---
title: Hg hooks å®è·µå†ç¨‹
pubDatetime: 2022-03-17
permalink: /post/hg-hooks.html
tags: 
  - hg
  - vcs
---
## æ•…äº‹çš„å¼€å§‹

> <aside> ğŸ’¬ æäº¤ä»£ç å‰è®°å¾— lint</aside>
> <aside> ğŸ’¬ åˆæœ‰äººæ²¡è·‘æµ‹è¯•å°±æäº¤ä»£ç </aside>
> <aside> ğŸ’¬ project-config æœ‰æ”¹åŠ¨ï¼Œéº»çƒ¦ yarn setup ä¸€ä¸‹</aside>

ç›¸ä¿¡ä½¿ç”¨ Hg çš„åŒå­¦ä»¬å·²ç»éå¸¸ç†Ÿæ‚‰ä¸Šé¢è¿™å‡ å¥è¯äº†ï¼Œæˆ‘ä»¬æ¯æ¬¡åœ¨æäº¤æˆ–è€…æ‹‰å–ä»£ç æ—¶æ€»éœ€è¦æ‰‹åŠ¨æ‰§è¡ŒæŸäº›å‘½ä»¤ï¼Œå®åœ¨ç¹çã€‚

ä½†ç°åœ¨å·²ç» 2022 å¹´äº†ï¼Œéš¾é“å°±æ²¡æœ‰æ›´å¥½çš„è§£å†³æ–¹æ³•å—ï¼Ÿ

æœ‰çš„ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œåœ¨ Git æœ‰ä¸ªä¸œè¥¿å«åš hooksï¼ˆé’©å­ï¼‰ï¼Œå¯ä»¥åœ¨ç‰¹å®šäº‹ä»¶å‘ç”Ÿä¹‹å‰æˆ–ä¹‹åæ‰§è¡Œç‰¹å®šåŠ¨ä½œã€‚

åŒæ ·çš„ï¼ŒHg ä¹Ÿæœ‰ [hooks](https://www.mercurial-scm.org/wiki/hook)ï¼Œä¸è¿‡å¹¶ä¸åƒ Git ä¸€æ ·ç”Ÿæ€è“¬å‹ƒå‘å±•ï¼Œä¹Ÿæ²¡æœ‰å¤ªå¤šç°æœ‰çš„å¼€æºå·¥å…·å¯ä¾›å¤§å®¶ä½¿ç”¨ã€‚

æœ¬æ–‡å°±æ¥ä»‹ç»ä¸€ä¸‹æˆ‘ä»¬ä» 0 åˆ° 1 çš„ Hg hooks å®è·µè¿‡ç¨‹ï¼ŒåŒæ—¶ä¹Ÿå¸Œæœ›èƒ½å¤Ÿèµ·åˆ°æŠ›ç –å¼•ç‰çš„ä½œç”¨ã€‚

## çŸ³å™¨æ—¶ä»£

åœ¨æ²¡æœ‰å¼•å…¥ Hg hooks ä¹‹å‰ï¼Œæˆ‘ä»¬å¸¸å¸¸ä¼šé¢å¯¹å‡ ç§æƒ…å†µï¼š

1. æœ‰åŒå­¦åœ¨æäº¤ä»£ç æ—¶å¿˜è®°æ‰§è¡Œ `yarn lint`ã€`yarn test`
2. ä¿®æ”¹äº† `project-config` çš„å¸¸é‡ï¼Œå´å¿˜è®°é€šçŸ¥å¤§å®¶ï¼Œæˆ–è€…æœ‰äººé”™è¿‡äº†è¿™æ¡ä¿¡æ¯ã€‚

è¿™éƒ½æœ‰å¯èƒ½ä¼šå¯¼è‡´å…¶ä»–å°ä¼™ä¼´æ‹‰å–ä»£ç åï¼Œå‘ç°é¡µé¢ä¸Šçš„æŸä¸ªåŠŸèƒ½çªç„¶å¼‚å¸¸ï¼ŒèŠ±è´¹ä¸€æ®µæ—¶é—´æ’æŸ¥æ‰å‘ç°åŸæ¥æ˜¯æ²¡æœ‰æ‰§è¡Œ `yarn setup`ã€‚

å¯èƒ½æœ‰éƒ¨åˆ†åŒå­¦ä¼šæƒ³åˆ°ï¼Œé‚£æˆ‘è‡ªå®šä¹‰ä¸€ä¸ªå‘½ä»¤åœ¨æäº¤æˆ–è€…æ‹‰å–ä»£ç æ—¶è‡ªåŠ¨åšè¿™ä»¶äº‹ä¸å°±å¥½äº†å—ï¼Ÿ

æ¯”å¦‚è¿™æ ·ï¼š

```bash
> yarn lint && hg commit -m "xxx"

> hg pull --update && yarn setup
```

è¿™æ ·ä¹Ÿä¸æ˜¯ä¸è¡Œï¼Œä½†æ˜¯ä¼šå­˜åœ¨ä¸€äº›é—®é¢˜ï¼š

1. ç”±äºæ¯ä¸ªäººçš„æ‹‰å–ä»£ç çš„å‘½ä»¤ä¸ä¸€æ ·ï¼Œå¦‚æœé¡¹ç›®å¼€å‘æµç¨‹å‘ç”Ÿå˜åŒ–ï¼Œåˆ™æ¯ä¸ªäººéƒ½éœ€è¦åŒæ­¥ä¿®æ”¹
2. æœ‰äº›åŒå­¦ä¹ æƒ¯ä½¿ç”¨å›¾å½¢åŒ–ç•Œé¢ï¼Œæ¯”å¦‚ SourceTreeã€vscode-hg ç­‰ï¼Œåˆ™æ— æ³•è‡ªå®šä¹‰æ“ä½œå‘½ä»¤



å› æ­¤ï¼Œæˆ‘ä»¬å¦è¾Ÿè¹Šå¾„ï¼Œå¯»æ‰¾æ›´å¥½çš„è§£å†³æ–¹æ¡ˆã€‚

## é’é“œæ—¶ä»£

æˆ‘ä»¬æœ€ä¸»è¦æƒ³è§£å†³çš„é—®é¢˜å°±æ˜¯ï¼š

1. åœ¨æäº¤ä»£ç å‰è‡ªåŠ¨æ‰§è¡Œ `yarn lint`ã€`yarn test`ï¼Œä¸é€šè¿‡åˆ™ç›´æ¥ç»ˆæ­¢æäº¤ã€‚
1. åœ¨æ‹‰å–ä»£ç åï¼Œæ£€æµ‹åˆ°å¦‚æœ project-config ç›®å½•å‘ç”Ÿæ”¹åŠ¨ï¼Œåˆ™è‡ªåŠ¨æ‰§è¡Œ `yarn setup`ã€‚
3. è¿˜æœ‰æ›´å¤šï¼š
   1. æ£€æŸ¥ commit message è§„èŒƒ
   2. ç»Ÿä¸€ä»£ç çš„æ ¼å¼åŒ–é£æ ¼



è¿™äº›éƒ½å¯ä»¥é€šè¿‡ Hg hooks è§£å†³ï¼Œæ‰€ä»¥å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆå¯¹ Hg hooks åšä¸€ä¸ªç®€å•çš„è®¤è¯†ã€‚

### Hg hooks ä»‹ç»

Hg hooks èƒ½åšä»€ä¹ˆï¼Œè¿™æ¬¡å†ä»‹ç»ä¸€éï¼š**å®ƒå¯ä»¥åœ¨ç‰¹å®šäº‹ä»¶å‘ç”Ÿä¹‹å‰æˆ–ä¹‹åæ‰§è¡Œç‰¹å®šåŠ¨ä½œã€‚**

ç‰¹å®šäº‹ä»¶ï¼ŒæŒ‡çš„å°±æ˜¯æˆ‘ä»¬åœ¨å¯¹ Hg ä»“åº“è¿›è¡Œæ“ä½œæ—¶çš„ä¸€äº›é’©å­ï¼Œæ¯”å¦‚æäº¤å‰ï¼ˆprecommitï¼‰ã€æäº¤åï¼ˆcommitï¼‰ï¼Œå¯ä»¥åœ¨è¿™é‡ŒæŸ¥çœ‹å…¨éƒ¨ hooks åˆ—è¡¨ï¼š[hooks](https://www.mercurial-scm.org/repo/hg/help/hgrc)ã€‚

ä¸‹é¢ä»‹ç»ä¸€ä¸‹å¦‚ä½•ä½¿ç”¨ hookï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹ä¸¤ä¸ªæ–‡ä»¶è¿›è¡Œé…ç½®ï¼š

1. `~/.hgrc`ï¼šå…¨å±€çš„ï¼Œå°†å¯¹æ‰€æœ‰ hg ä»“åº“èµ·ä½œç”¨ã€‚
2.  é¡¹ç›®æ ¹ç›®å½•çš„ `.hg/hgrc` ï¼šä»…å¯¹å½“å‰ä»“åº“èµ·ä½œç”¨ã€‚

æ¯”å¦‚æˆ‘ä»¬æƒ³è¦å®ç°ä¸€ä¸ªç®€å•çš„éœ€æ±‚ï¼šåœ¨æäº¤ä»£ç å‰è¿›è¡Œ `yarn lint`ã€‚

é¦–å…ˆç¼–è¾‘ `.hg/hgrc`æ–‡ä»¶ï¼š

```yaml
[hooks]
precommit = ./bin/hooks/precommit.sh # è¿™ä¸ªè·¯å¾„æ˜¯ç›¸å¯¹äºé¡¹ç›®æ ¹ç›®å½•çš„
```

ç„¶åç¼–å†™è„šæœ¬ `bin/hooks/precommit.sh`ï¼ˆä¹Ÿå¯ä»¥ä½¿ç”¨ pythonï¼‰ï¼š

```bash
#!/bin/bash

PATH=/usr/local/bin:/opt/homebrew/bin:$PATH

yarn lint

# lint æ²¡æœ‰é€šè¿‡ç›´æ¥é€€å‡º
if [ $? -ne 0 ]; then exit 1; fi
```

è¿™é‡Œéœ€è¦ç‰¹åˆ«æŒ‡å‡ºï¼Œä¹‹æ‰€ä»¥éœ€è¦é‡æ–°å£°æ˜ `PATH` å˜é‡ï¼š

1. hooks è„šæœ¬çš„è¿è¡Œç¯å¢ƒå–å†³äºåŒå­¦æäº¤ä»£ç çš„åœ°æ–¹ï¼Œæ¯”å¦‚é€šè¿‡ SourceTree æäº¤ï¼Œç”±äºç¯å¢ƒä¸ä¸€æ ·ï¼Œå°±å¯èƒ½ä¼šå‡ºç° `yarn: command not found` çš„æŠ¥é”™ï¼Œå‚è§ï¼š['Git Command Not found' in the custom action for SourceTree - Stack Overflow](https://stackoverflow.com/questions/22883197/git-command-not-found-in-the-custom-action-for-sourcetree)ã€‚
2. æ¯ä¸ªåŒå­¦å®‰è£… hg çš„æ–¹å¼å¯èƒ½ä¸ä¸€æ ·ï¼Œæœ‰é€šè¿‡ brewã€pipã€ç”šè‡³è‡ªå·±æ‰‹åŠ¨ç¼–è¯‘çš„ï¼Œå®ƒä»¬çš„å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„ä¸ä¸€æ ·ã€‚
   - å¯ä»¥é€šè¿‡ `which hg` æŸ¥çœ‹è¿™ä¸ªå‘½ä»¤çš„å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„ã€‚

è¿™æ ·ï¼Œä¸€ä¸ªç®€å•çš„ hook å°±é…ç½®å®Œæˆäº†ï¼Œè¿™æ—¶å€™æäº¤ä»£ç å°±ä¼šè§¦å‘ `precommit.sh`ï¼š

```bash
> hg commit -m "ci: precommit hooks"

$ eslint '**/*.js' --cache --fix
```

å½“ hook è„šæœ¬çš„ exit code ä¸ä¸º 0 çš„æ—¶å€™ï¼Œåˆ™ä¼šç»ˆæ­¢å½“å‰çš„ Hg æ“ä½œï¼Œå¯¹äºæŸäº›å…·æœ‰äº‹åŠ¡æ€§çš„ hookï¼ˆe.g. pretxncommitï¼‰ï¼Œè¿˜ä¼šè‡ªåŠ¨è¿›è¡Œå›æ»šã€‚

å¯ä»¥é€šè¿‡ä»¥ä¸‹é“¾æ¥å¯¹ Hg hooks è¿›è¡Œæ›´æ·±å…¥åœ°å­¦ä¹ ï¼š

- [hookExamples](https://www.mercurial-scm.org/wiki/hookExamples)
- [Usefulhooks](https://www.mercurial-scm.org/wiki/Usefulhooks)
- [Chapter 10. Handling repository events with hooks (red-bean.com)](http://hgbook.red-bean.com/read/handling-repository-events-with-hooks.html)

### Hg hooks å®è·µ

#### æäº¤ä»£ç å‰ï¼ˆprecommitï¼‰

è¿™é‡Œéœ€è¦ç”¨åˆ°çš„ hook æ˜¯ precommitï¼Œå®ƒçš„è¿è¡Œæ—¶æœºåœ¨æäº¤ä¹‹å‰ï¼Œexit code é 0 æ—¶å°†ç»ˆæ­¢æäº¤ã€‚

 `precommit.sh`ï¼š

```bash
#!/bin/bash

PATH=/usr/local/bin:/opt/homebrew/bin:$PATH

if [ "$SKIP_LINT" = "1" ]; then
    exit 0
fi

# éœ€è¦ lint çš„é¡¹ç›®
apps=(
    'miniprogram'
    'dashboard'
    'core'
)

for app in "${apps[@]}"; do
    # åˆ¤æ–­æ˜¯å¦ä¿®æ”¹è¯¥é¡¹ç›®ï¼Œæ— åˆ™è·³è¿‡ lint
    has_change=$(hg status | grep "${app}")

    if [ -z "$has_change" ]; then continue; fi

    cd "$app" || exit 1

    yarn && yarn lint

    # lint æ˜¯å¦æŠ¥é”™ï¼Œæ˜¯åˆ™ç›´æ¥é€€å‡ºè„šæœ¬
    if [ $? -ne 0 ]; then exit 1; fi

    cd -
done

# é’ˆå¯¹å½“å‰ä¿®æ”¹æˆ–æ–°å¢çš„æ–‡ä»¶æ‰¹é‡è¿›è¡Œ prettier æ ¼å¼åŒ–
hg status | grep -E "^(M|A).*.(js|json|wxss)$" | sed 's|^M||g; s|^A||g' | xargs ./node_modules/.bin/prettier --write >/dev/null 2>&1
```

æ¯”è¾ƒæµ…æ˜¾æ˜“æ‡‚ï¼Œç”±äºæ˜¯ Monorepo æ¶æ„ï¼Œæ‰€ä»¥ä»…é’ˆå¯¹å½“å‰æ”¹åŠ¨çš„å­é¡¹ç›®æ‰§è¡Œ `yarn lint` ï¼Œå½“ lint ä¸é€šè¿‡æ—¶ç»ˆæ­¢æäº¤ï¼›ç„¶åä»…å¯¹å½“å‰å˜æ›´çš„æ–‡ä»¶åš prettier æ ¼å¼åŒ–ï¼Œå¹¶ä¸”å¿½ç•¥è¿™è¡Œå‘½ä»¤çš„è¾“å‡ºå’Œé”™è¯¯ã€‚

psï¼šå…¶å®è¿™é‡Œçš„ prettier æœºåˆ¶æœ‰ç‚¹é—®é¢˜ï¼ŒåŸæœ¬çš„ç›®çš„æ˜¯ä»…æ ¼å¼åŒ–å½“å‰æäº¤çš„æ–‡ä»¶ï¼Œä½† Hg æ²¡æœ‰ staging area çš„æ¦‚å¿µï¼Œæ•…åªèƒ½ç²—æš´å¤„ç†ï¼Œå¦‚æœæœ‰æ›´å¥½çš„è§£å†³æ–¹æ³•æ¬¢è¿æŒ‡æ•™ã€‚

- hg commit å¯ä»¥åªæäº¤æŒ‡å®šçš„éƒ¨åˆ†æ–‡ä»¶ï¼Œæ‰€ä»¥æ˜¯æœ‰ changed files å’Œ commited files ä¸¤ä¸ªæ¦‚å¿µï¼Œä½†æ˜¯æ²¡æœ‰æ‰¾åˆ°åŠæ³•è·å– commited filesï¼Œå‚è§ï¼š[Mercurial pre-commit hook: How to tell apart changed and committed files - Stack Overflow](https://stackoverflow.com/questions/24565802/mercurial-pre-commit-hook-how-to-tell-apart-changed-and-committed-files)
- å¦ä¸€ç§æ€è·¯ï¼šä½¿ç”¨ pretxncommit é’©å­ï¼Œå°±å¯é€šè¿‡ $Hg_NODE å˜é‡æ‹¿åˆ°å½“å‰ commit çš„ä¿¡æ¯ï¼Œä½†ç¼ºç‚¹æ˜¯ pretxncommit é˜¶æ®µå°†ä¸èƒ½å†å¯¹æ–‡ä»¶è¿›è¡Œæ”¹åŠ¨ï¼Œåˆ™æ ¼å¼åŒ–åéœ€è¦é‡æ–°æäº¤ä¸€éã€‚

éšç€ç‰ˆæœ¬è¿­ä»£ï¼Œåœ¨ precommit é’©å­ä¸­å¢åŠ äº†æ£€æµ‹ utilsã€test ç›®å½•æ”¹åŠ¨åˆ™è‡ªåŠ¨æ‰§è¡Œå•å…ƒæµ‹è¯• ï¼š

```bash
# ä¿®æ”¹ä»¥ä¸‹æ–‡ä»¶éœ€è¦æ‰§è¡Œå•å…ƒæµ‹è¯•
apps=(
    'miniprogram/utils miniprogram/test'
)

for app in "${apps[@]}"; do
    dir=($app)
    pass=0

    for d in "${dir[@]}"; do
        # åˆ¤æ–­æ˜¯å¦ä¿®æ”¹å·¥å…·æ–¹æ³•ã€æµ‹è¯•ç”¨ä¾‹ï¼Œæ— åˆ™è·³è¿‡
        has_change=$(hg status | grep "${d}")
        
        if [ -z "$has_change" ]; then continue; fi
        
        # åŒä¸€ä¸ªé¡¹ç›®åªæ‰§è¡Œä¸€æ¬¡
        [ $pass -eq 1 ] && break

        cd "$d" || exit 1
        yarn && yarn test

        # test æ˜¯å¦æŠ¥é”™ï¼Œæ˜¯åˆ™ç›´æ¥é€€å‡ºè„šæœ¬
        if [ $? -ne 0 ]; then exit 1; fi

        pass=1

        cd -
    done
done
```

#### æ‹‰å–ä»£ç åï¼ˆchangegroupï¼‰

ä¸»è¦æƒ³è§£å†³çš„é—®é¢˜æ˜¯ï¼šå½“æ‹‰å–ä»£ç åï¼Œæ£€æµ‹åˆ° project-config ç›®å½•å‘ç”Ÿå˜æ›´ï¼Œåˆ™æ‰§è¡Œ `yarn setup`ã€‚

é¦–å…ˆè¦è§£å†³ç¬¬ä¸€ç‚¹ï¼Œå¦‚ä½•è·å–ä»è¿œç«¯æ‹‰å–ä»£ç æ‰€æ”¹åŠ¨çš„æ–‡ä»¶ï¼Ÿæœ‰ä¸‹é¢å‡ ç§æ–¹æ³•ï¼š

1. [hg incoming](https://backend.bolt80.com/hgdoc/hg-incoming.html)ï¼šæ˜¾ç¤ºè¿œç«¯ä¸­çš„æ–° commit
   - ç¼ºç‚¹ï¼šè¯¥æ–¹æ³•åªæ˜¯æ˜¾ç¤ºæ–°çš„ commitï¼Œåé¢ä»éœ€è¦å†è¿›è¡Œä¸€æ¬¡ pull æ‰èƒ½å°†æ–° commit æ‹‰å–ä¸‹æ¥ï¼Œå¯¼è‡´æ‹‰å–ä»£ç æ—¶é—´ç¿»å€ã€‚

2. [hg pull](https://backend.bolt80.com/hgdoc/hg-pull.html)ï¼šåœ¨æ‹‰å–ä»£ç ä¹‹åã€è¿›è¡Œ update æˆ– rebase ä¹‹å‰ï¼Œé€šè¿‡ `hg log` å¯¹æ¯”æœ¬åœ° head å’Œ è¿œç«¯æ‹‰å–ä¸‹æ¥çš„ headã€‚
3. hooksï¼š
   1. updateï¼šå·¥ä½œç›®å½•å‘ç”Ÿæ”¹å˜æ—¶ï¼Œæ‰€ä»¥åªè¦è¿›è¡Œæäº¤ã€å‚¨è—ã€åˆ‡æ¢åˆ†æ”¯éƒ½ä¼šè§¦å‘ï¼Œ**ä¸è€ƒè™‘**ã€‚
   2. incomingï¼šæ¯ä¸€ä¸ªæ–°çš„ commit è¢«ä¼ å…¥æ—¶éƒ½ä¼šè§¦å‘ä¸€æ¬¡ï¼Œè¿‡äºé¢‘ç¹ï¼Œ**ä¸è€ƒè™‘**ã€‚
   3. changegroupï¼šåœ¨ pushã€pullã€unbundle æ—¶éƒ½ä¼šè§¦å‘ï¼Œä½†å¤šä¸ª commit è¢«ä¼ å…¥ä¹Ÿåªä¼šè§¦å‘ä¸€æ¬¡ï¼Œ**å¯è€ƒè™‘**ã€‚
   4. è¿˜æœ‰ä¸€äº›ä¸å¤ªæ»¡è¶³çš„ hooks ä¸ä¸€ä¸€ä»‹ç»äº†ã€‚

åœ¨ä¸€å¼€å§‹ï¼Œæˆ‘ä»¬æ›¾å°è¯•ä½¿ç”¨ç¬¬äºŒç§æ–¹æ³•è§£å†³è¯¥é—®é¢˜ï¼š

```bash
hgpl() {
    no_shelve=$(hg shelve | grep "nothing changed")

    hg pull

    # æ”¹åŠ¨æ–‡ä»¶
    regex='\bproject-config'

    # è·å–æœ¬æ¬¡ pull å˜æ›´é›†çš„æ”¹åŠ¨æ–‡ä»¶åˆ—è¡¨ï¼Œåˆ¤æ–­æ˜¯å¦æœ‰æ”¹åŠ¨ç›¸å…³æ–‡ä»¶
    # @linkï¼šhttps://stackoverflow.com/questions/3277334/what-files-will-be-changed-vs-added-when-i-do-an-hg-pull-and-hg-update
    has_change=$(hg log --verbose -r .:tip | grep "files:" | grep -E "$regex")

    # å‚è€ƒ hg update --rebase çš„å®ç°ï¼Œå…ˆå°è¯• rebaseï¼Œå¦‚æœä¸éœ€è¦ rebaseï¼Œåˆ™ç›´æ¥ update
    # @linkï¼šhttps://stackoverflow.com/questions/35327163/what-is-the-rebase-command-used-in-hg-pull-rebase
    # @linkï¼šhttps://www.mercurial-scm.org/repo/hg/file/tip/hgext/rebase.py#l2172
    has_rebase=$(hg rebase -b . -d 'last(branch(.))' | grep "nothing to rebase")

    if [ ! -z "$has_rebase" ]; then
        hg update
    fi

    # æœ‰æ”¹åŠ¨ç›¸å…³æ–‡ä»¶ï¼Œéœ€è¦æ‰§è¡Œ yarn setup
    if [ ! -z "$has_change" ]; then
        yarn setup
    fi

    # å¦‚æœä¹‹å‰æœ‰ shelveï¼Œéœ€è¦æ¢å¤ shelve
    if [ -z "$no_shelve" ]; then
        hg unshelve
    fi
}
```

è¿™ä¸ªæ–¹æ³•å¯ä»¥å¾ˆå¥½åœ°å·¥ä½œï¼Œå®ƒå¯ä»¥æ»¡è¶³ï¼š

- æ‹‰å–ä»£ç æ—¶è‡ªåŠ¨å‚¨è—ã€æ¢å¤æœ¬åœ°æ”¹åŠ¨
- å½“ä¸¤ç«¯éƒ½åŒæ—¶ä¿®æ”¹ project-config æ—¶ï¼Œå¯ä»¥ update æˆ–è€… rebase åå†ç»Ÿä¸€ `yarn setup`

åæ¥å‘ç°ä½¿ç”¨ changegroup  hook é…åˆ `hg log` ä¸€æ ·å¯ä»¥è§£å†³é—®é¢˜ï¼Œäºæ˜¯å°±æœ‰äº† `changegroup.sh`ï¼š

```bash
#!/bin/bash

PATH=/usr/local/bin:/opt/homebrew/bin:$PATH

# æ”¹åŠ¨æ–‡ä»¶
regex='\bproject-config'

# è·å–æœ¬æ¬¡å˜æ›´é›†çš„æ”¹åŠ¨æ–‡ä»¶åˆ—è¡¨ï¼Œåˆ¤æ–­æ˜¯å¦æœ‰æ”¹åŠ¨ç›¸å…³æ–‡ä»¶
# @seeï¼šhttps://stackoverflow.com/questions/3277334/what-files-will-be-changed-vs-added-when-i-do-an-hg-pull-and-hg-update
has_change=$(hg log -v -r $Hg_NODE: | grep "files:" | grep -E "$regex")

# æœ‰æ”¹åŠ¨ç›¸å…³æ–‡ä»¶ï¼Œéœ€è¦æ‰§è¡Œ yarn setup
if [ ! -z "$has_change" ]; then
    cd $(hg root) || exit 1
    yarn setup
    cd -
fi
```

 å› æ­¤ `hgpl` å¯ä»¥ç²¾ç®€æˆè¿™æ ·ï¼š

```bash
hgpl() {
    has_shelve=$(hg shelve | grep "nothing changed")

    hg pull --rebase

    # å¦‚æœä¹‹å‰æœ‰ shelveï¼Œéœ€è¦æ¢å¤ shelve
    if [ -z "$has_shelve" ]; then
        hg unshelve
    fi
}
```

#### commit message æ£€æŸ¥ï¼ˆpretxncommitï¼‰

ä½¿ç”¨ pretxncommit é’©å­å¯å¯¹å½“å‰æäº¤ä¿¡æ¯è¿›è¡Œæ£€æŸ¥ï¼Œå¦‚æ£€æŸ¥ commit messageï¼š

```bash
#!/bin/bash

PATH=/usr/local/bin:/opt/homebrew/bin:$PATH

if [ "$SKIP_LINT" = "1" ]; then
    exit 0
fi

shelve_user="shelve@localhost"

commit_user=$(hg tip --template {user})

# å› ä¸º hg shelve ä¹Ÿä¼šè§¦å‘ pretxncommit é’©å­ï¼Œæ‰€ä»¥è¦è¿›è¡Œå¿½ç•¥
if [ "$commit_user" == "$shelve_user" ]; then
    exit 0
fi

commit_message=$(hg tip --template {desc})

echo "[msg] $commit_message"

echo "$commit_message" | ./node_modules/.bin/commitlint
```

## é“å™¨æ—¶ä»£ï¼Ÿ

è¿™ä¸ªæ ‡é¢˜ä¹‹æ‰€ä»¥æ‰“ä¸Šä¸€ä¸ªé—®å·ï¼Œæ˜¯å› ä¸ºè¯¥æ–¹æ¡ˆä»åœ¨ POC é˜¶æ®µï¼Œå°šæœªè½åœ°å®æ–½ï¼Œä½†ä¹Ÿå¯ä½œä¸ºä¸€ä¸ªå¯¹æœªæ¥çš„å±•æœ›ã€‚

è¿„ä»Šä¸ºæ­¢ï¼Œæˆ‘ä»¬çš„ Hg hooks å·²ç»èƒ½å¤Ÿæ»¡è¶³å¤§éƒ¨åˆ†åœºæ™¯äº†ï¼Œé‚£è¿˜å­˜åœ¨äº›ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ

ç›¸ä¿¡ä¸å°‘åŒå­¦å·²ç»å‘ç°è¿™æ ·æ“ä½œä¼šå­˜åœ¨æœ‰ä¸€ä¸ªå¾ˆæ˜æ˜¾çš„é—®é¢˜ï¼Œé‚£å°±æ˜¯ï¼šhooks é…ç½®å¦‚ä½•åŒæ­¥ï¼Ÿ

æˆ‘ä»¬çŸ¥é“ `.hg` ç›®å½•æ˜¯ä¸ä¼šåŠ å…¥ç‰ˆæœ¬æ§åˆ¶çš„ï¼Œè¿™æ˜¯éå¸¸åˆç†ä¸”å¿…è¦çš„ï¼Œå› ä¸º hooks æœ¬èº«æ˜¯ä¸€äº›æƒé™æé«˜çš„å¯æ‰§è¡Œè„šæœ¬ï¼Œæ‰€ä»¥å‡ºäºå®‰å…¨è€ƒè™‘ï¼ˆä½ ä¹Ÿä¸æƒ³ä½  clone ä¸€ä¸ªä»“åº“åï¼Œå®ƒä¼šè‡ªåŠ¨æ‰§è¡ŒæŸäº›ä½ ä¸æƒ³æ‰§è¡Œçš„å‘½ä»¤ï¼‰ï¼Œ**å› æ­¤æ˜¯ä¸ä¼šæœ‰ä»»ä½•ä¸€ä¸ª VSC ä¼šå°† hooks åŠ å…¥ç‰ˆæœ¬æ§åˆ¶çš„ã€‚**

å¯æ˜¯è¿™å°±ä¼šå¯¼è‡´ï¼š

1. å‡å¦‚é¡¹ç›®æ–°å¢äº†ä¸€ä¸ª hookï¼Œéœ€è¦é€šçŸ¥é¡¹ç›®æˆå‘˜åŒæ­¥ä¿®æ”¹æœ¬åœ°çš„ hooks é…ç½®ã€‚
2. æ–°æˆå‘˜åŠ å…¥é¡¹ç›®ï¼Œéœ€è¦æ‰‹åŠ¨é…ç½® hooksã€‚

å¦‚æœè¿™ä¸ªé—®é¢˜ä¸èƒ½å¾—åˆ°è§£å†³ï¼Œé‚£å½’æ ¹åˆ°åº•è¿˜æ˜¯æ— æ³•ç»•è¿‡é€šçŸ¥é¡¹ç›®æˆå‘˜æ‰‹åŠ¨æ“ä½œçš„è¿‡ç¨‹ã€‚

æ‰€å¹¸ï¼Œä»¥ä¸Šé—®é¢˜åœ¨ Git ä¸­åŒæ ·å­˜åœ¨ï¼Œå¹¶ä¸”å·²ç»æœ‰å¾ˆå¤šéå¸¸æˆç†Ÿçš„æ–¹æ¡ˆï¼Œå¦‚ï¼š [huksy](https://github.com/typicode/husky)ã€[pre-commit](https://pre-commit.com/) ã€‚

é‚£æœ‰æ²¡æœ‰äººåœ¨ Hg ç”Ÿæ€ä¸Šè§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿç²—ç•¥æ‰¾åˆ°äº†ä¸¤ä¸ªï¼š

1. [husky-hg](https://github.com/TobiasTimm/husky-hg)
2. [tdog-husky-hg](https://github.com/theylom/tdog-husky-hg)ï¼ˆå‰è€…çš„ fork

éƒ½æ˜¯åŸºäº husky [v0.14.3](https://github.com/tobiastimm/husky-hg/commit/fcd100f4f1a7bdf04c05f51ddd80af9f87687ddc#diff-7ae45ad102eab3b6d7e7896acd08c427a9b25b346470d7bc6507b6481575d519R2) æ”¹é€ çš„ï¼Œæœ€åæäº¤æ—¶é—´éƒ½åœ¨ä¸‰å¹´å‰ï¼ˆ2019ï¼‰ï¼Œç„¶è€Œ husky ç°åœ¨å·²ç»è¿­ä»£åˆ° [v7](https://github.com/typicode/husky/releases/tag/v7.0.4) ç‰ˆæœ¬äº†ï¼Œè¿™ 3 å¹´é—´ç»è¿‡æ— æ•°è¿­ä»£ï¼Œä½¿ç”¨æ–¹å¼å’Œå®ç°åŸç†éƒ½å‘ç”Ÿç¿»å¤©è¦†åœ°çš„å˜åŒ–ï¼Œäºæ˜¯æˆ‘ä»¬å†³å®šåŸºäº husky v7 è‡ªè¡Œæ”¹é€ ã€‚

ä½†æ˜¯åœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆäº†è§£ä¸€ä¸‹ Git å¦‚ä½•é…ç½® hooksï¼š

1. åœ¨ä»¥å‰çš„ Git ç‰ˆæœ¬ä¸­ï¼Œå¦‚æœè¦é…ç½®ä¸€ä¸ª hooks åˆ™éœ€è¦åœ¨ `.git/hooks` ç›®å½•æ–°å¢ä¸€ä¸ª hook åŒåçš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¹¶ä¸”å‡ºäºå‰é¢è¯´çš„å®‰å…¨è€ƒè™‘ï¼Œ `.git`  ç›®å½•æ˜¯ä¸ä¼šè¢«åŠ å…¥ç‰ˆæœ¬æ§åˆ¶çš„ï¼Œ**å› æ­¤ä¹Ÿå­˜åœ¨ä¸Šé¢æ‰€è¯´çš„é—®é¢˜**ã€‚
2. åœ¨ Git v2.9 ä»¥åï¼Œæ”¯æŒé€šè¿‡é…ç½® core.hooksPath è‡ªå®šä¹‰é¡¹ç›®çš„ hooks çš„å­˜æ”¾è·¯å¾„ï¼Œä¹Ÿå³æ„å‘³ç€å¯å°† hooks åŠ å…¥ç‰ˆæœ¬æ§åˆ¶ï¼Œé¡¹ç›®æˆå‘˜åªéœ€è¦åœ¨ç¬¬ä¸€æ¬¡é…ç½® core.hooksPath å³å¯ï¼Œåç»­å¢åˆ  hooks éƒ½å¯ç›´æ¥ä½¿ç”¨ã€‚

å› ä¸º Git æ”¯æŒ core.hooksPath ï¼Œæ‰€ä»¥ husky ç›´æ¥é‡‡ç”¨äº†æ–°çš„å®ç°åŸç†é‡æ„ï¼š

1. åœ¨ huksy v4 çš„æ—¶å€™ï¼Œç”±äº Git hooks ç›®å½•æ— æ³•è¢«åŠ å…¥ç‰ˆæœ¬æ§åˆ¶ï¼Œå®ƒä»¬æ˜¯è¿™æ ·è§£å†³è¿™ä¸ªé—®é¢˜çš„ï¼š
   1. åœ¨åˆå§‹åŒ–çš„æ—¶å€™å°±åœ¨ `.git/hooks` ç›®å½•é¢„å…ˆåˆ›å»ºæ‰€æœ‰çš„ hooks å¯æ‰§è¡Œæ–‡ä»¶ï¼Œç„¶ååœ¨ hooks æ–‡ä»¶ä¸­æ‰§è¡Œå®šä¹‰åœ¨ `package.json` ä¸­çš„ hooks å‘½ä»¤ã€‚
   2.  è¿™æ ·å¾ˆæ˜¾ç„¶å¯ä»¥è§£å†³ hooks æ— æ³•åŒæ­¥çš„é—®é¢˜ï¼Œä½†æ˜¯è¿™ä¸ªå®ç°åŸç†ä¹Ÿè¢«ä¸å°‘äººè¯Ÿç—…ï¼Œè§ [#260](https://github.com/typicode/husky/issues/260) ã€‚

2. ç”±äº Git v2.9 çš„å‡çº§ï¼Œåœ¨ husky v7 ä¸­ä½¿ç”¨äº†æ–°çš„å®ç°æ–¹å¼ï¼š
   1. å°† hooks å¯æ‰§è¡Œæ–‡ä»¶å­˜æ”¾åœ¨ä¸€ä¸ªå¯ä»¥è¢«è¿›è¡Œç‰ˆæœ¬æ§åˆ¶çš„ç›®å½•ï¼ˆé»˜è®¤æ˜¯ `.husky`ï¼‰ï¼Œç„¶ååˆå§‹åŒ–çš„æ—¶å€™åªéœ€è¦é…ç½®  core.hooksPath å³å¯ã€‚


æ˜¾ç„¶ï¼Œv7 çš„å®ç°æ–¹å¼æ›´åŠ æ–¹ä¾¿å¿«æ·äº†ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œå®ƒä»¬çš„ä½¿ç”¨æ–¹å¼ä¹Ÿæœ‰å¾ˆå¤§çš„ä¸åŒï¼š

1. åœ¨ v4 ä¸­ï¼Œé€šè¿‡åœ¨ `package.json`  ä¸­é…ç½® `husky` å­—æ®µæ¥å®šä¹‰ hooksã€‚
2. åœ¨ v7 ä¸­ï¼Œ**å®ƒä¸å†ä»…é™äº Node.js é¡¹ç›®**ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡ CLI çš„æ–¹å¼è¿›è¡Œé…ç½®ï¼Œå‚è§ï¼š[Why husky has dropped conventional JS config](https://blog.typicode.com/husky-git-hooks-javascript-config/)ã€‚

åœ¨æ·±å…¥äº†è§£èƒŒåçš„å®ç°åŸç†åï¼Œæˆ‘ä»¬å¾—å‡ºäº†ç»“è®ºï¼š

1. v4 ç‰ˆæœ¬çš„ä»£ç **æœ‰è¾ƒå¤šå†å²åŒ…è¢±ï¼Œä¸åˆ©äºæ”¹é€ ï¼Œæ•…åŸºäº v7 ç‰ˆæœ¬ä¿®æ”¹**ã€‚
2. ä½† v7 ç‰ˆæœ¬çš„å®ç°æ–¹å¼å¯¹ Hg å¹¶ä¸å®Œå…¨é€‚ç”¨ï¼Œæ‰€ä»¥éœ€è¦ç»§ç»­æ²¿ç”¨ v4 çš„éƒ¨åˆ†å®ç°æ–¹å¼ï¼Œæ‰€ä»¥è¿™æ ·è®¾è®¡ï¼š
   1. å°† hooks è„šæœ¬å­˜æ”¾åœ¨å¯è¢«ç‰ˆæœ¬æ§åˆ¶çš„ `.husky` ç›®å½•
   2. ä½†ä¸é€šè¿‡é¢„æ³¨å†Œæ‰€æœ‰çš„ hooks çš„æ–¹å¼ï¼Œè€Œæ˜¯é‡‡ç”¨æŒ‰éœ€é…ç½®ï¼Œåˆå§‹åŒ–æ—¶æ ¹æ® `.husky` çš„ hooks å¯æ‰§è¡Œæ–‡ä»¶åˆ—è¡¨æ³¨å…¥ hooks é…ç½®ã€‚
      1. æ¯”å¦‚åœ¨ Node.js é¡¹ç›®ä¸­å¯ä»¥é€šè¿‡ npm çš„ [prepare](https://docs.npmjs.com/cli/v8/using-npm/scripts#prepare-and-prepublish) é’©å­æ¥è‡ªåŠ¨åˆå§‹åŒ–ã€‚
3. å› æ­¤ï¼Œä½¿ç”¨æ–¹å¼ä¸ husky [æ–‡æ¡£](https://typicode.github.io/husky/) ä¸­åŸºæœ¬ä¸€è‡´ã€‚
   1. `husky install`ã€`husky add .husky/pre-commit`




ä»¥ä¸Šçš„å¿ƒè·¯å†ç¨‹ã€æ”¹é€ è¿›å±•å¯ä»¥é€šè¿‡è¿™ä¸ª [PR](https://github.com/gd4Ark/husky/pull/1) æŸ¥çœ‹ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯è‡ªè¡Œå°è¯•ï¼š

1. clone é¡¹ç›®ï¼Œå®‰è£…ä¾èµ–ï¼Œæ‰§è¡Œ npm linkã€‚
2. å‚è€ƒ  husky [æ–‡æ¡£](https://typicode.github.io/husky/) è¿›è¡Œä½¿ç”¨ã€‚

## èƒŒåçš„ä¸€äº›äºŒä¸‰äº‹

æœ€ååˆ†äº«ä¸€äº›æˆ‘ä»¬åœ¨å®è·µ Hg hooks æ—¶çš„å°æ’æ›²ã€‚

### ä¸€ä¸ªéšè—å­—ç¬¦å¼•å‘çš„å‰ç«¯äº‹æ•…

æœ‰ä¸€å¤©ä¸‹åˆï¼Œåœ¨ç¾¤é‡Œæ”¶åˆ°è¿™ä¹ˆä¸€ä¸ªåé¦ˆï¼š

<img src="https://gd4ark-1258805822.cos.ap-guangzhou.myqcloud.com/images202203191549957.jpg"  alt="2471647676117_.pic" style="margin-left: 0;" />

ç‚¹å¼€å¤§å›¾ä¸€çœ‹ï¼Œå¥½å®¶ä¼™ï¼èµ«ç„¶ä¸€ä¸ªã€Œå£ã€å­—å°±è¿™ä¹ˆæ˜ç›®å¼ èƒ†åœ°è´´åœ¨é¡µé¢çš„å·¦ä¸‹è§’ï¼Œçœ‹å®ƒã€Œæµ“çœ‰å¤§çœ¼ã€çš„ã€‚

åˆ°åº•æ˜¯å“ªé‡Œå‡ºäº†é—®é¢˜å‘¢ï¼Ÿ

ä»”ç»†çœ‹æ¸…æ¥šï¼Œæ‰å‘ç°å®ƒå…¶å®ä¸æ˜¯ä¸€ä¸ªã€Œå£ã€å­—ï¼Œè€Œæ˜¯ã€Œâ–¡ã€ï¼Œå­¦åå«åš [è™šç¼ºå·](https://zh.wikipedia.org/zh-hans/è™šç¼ºå·)ï¼Œé€šä¿—åœ°è®²å°±æ˜¯ä¸€ä¸ªç‰¹æ®Šå­—ç¬¦ã€‚

äºæ˜¯æ‰“å¼€å¯¹åº”çš„ä»£ç æ–‡ä»¶ï¼Œæœç„¶ä¸€ä¸ªçº¢åº•ç™½è‰² BS å­—ç¬¦å¼•å…¥çœ¼å¸˜ï¼š

![](https://gd4ark-1258805822.cos.ap-guangzhou.myqcloud.com/images202204042021847.png)


#### è¿™æ˜¯ VSCode çš„é”…ï¼Ÿ

åœ¨ç½‘ä¸Šæœ‰ä¸€ç•ªæœå¯»åï¼Œå‘ç°æ—©å°±å·²ç»æœ‰ä¸å°‘äººé‡åˆ°è¿‡è¿™ä¸ªé—®é¢˜ï¼š

- [vscodeæ§åˆ¶å­—ç¬¦å¼•èµ·çš„é—®é¢˜ä»¥åŠè§£å†³æ€è·¯](https://github.com/wangduanduan/wangduanduan.github.io/issues/158)
- [éšè—å­—ç¬¦å¼•å‘çš„è¡€æ¡ˆ](https://jiangxiaokun.com/css/2018/11/15/ghost_chars/)

çœ‹ä¸‹ä»–ä»¬æä¾›çš„å¤ç°è¿‡ç¨‹ï¼š

![hmmm](https://gd4ark-1258805822.cos.ap-guangzhou.myqcloud.com/images202203191703719.gif)

ç›´æ¥è¯´ä¸‹è¿™ä¸ª Bug çš„ç»“è®ºï¼š

1. VSCode å¼€å¯ webview çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨ä¸­æ–‡è¾“å…¥æ³•æ—¶æŒ‰ä¸‹é€€æ ¼é”®ï¼Œå°±ä¼šå¯¼è‡´å‡ºç°é€€æ ¼ç¬¦ã€‚
2. VSCode åº•å±‚æ˜¯ Electronï¼ŒElectron åº•å±‚ç”¨çš„ chromiumï¼Œè¿™ä¸ª BUG æ˜¯ chromium çš„ã€‚
3. è¯¥ BUG å·²ç»åœ¨ VSCode v1.4.0 å¾—åˆ°ä¿®å¤ï¼Œå‚è§è¿™ä¸ª [issue](https://github.com/microsoft/vscode/issues/37114#issuecomment-544236959)ã€‚



ä½†æ—¢ç„¶è¯¥é—®é¢˜åœ¨ 2019 å¹´å·²ç»ä¿®å¤ï¼Œé‚£ä¸ºä»€ä¹ˆåœ¨ 2022 å¹´çš„ä»Šå¤©è¿˜ä¼šå‡ºç°è¿™ä¸ªé€€æ ¼ç¬¦å‘¢ï¼Ÿ

ç”±äºå·²ç»å¤ç°ä¸äº†ï¼Œæ ¹æºè¿½æ±‚ä¹Ÿå°±åªèƒ½ä¸äº†äº†ä¹‹ï¼Œä½†å½±å“åˆå¦‚æ­¤ä¹‹å¤§ï¼Œæ‰€ä»¥æˆ‘ä»¬åº”è¯¥æ€ä¹ˆå»è§„é¿å®ƒå‘¢ï¼Ÿ

#### è§„é¿æ–¹æ¡ˆ

##### åˆ©ç”¨ VSCode æ‰©å±•è‡ªåŠ¨åˆ é™¤

æœ‰ä¸€ä¸ª VSCode æ‰©å±• [Remove backspace control character](https://github.com/satokaz/vscode-bs-ctrlchar-remover) ä¸“é—¨ç”¨äºè§£å†³æ­¤ç±»é—®é¢˜ï¼Œå®‰è£…åæˆ‘ä»¬åªéœ€è¦åœ¨ setting.json æ·»åŠ å¦‚ä¸‹é…ç½®ï¼š

```json
  "[wxml]": {
    "editor.formatOnSave": true,
    "editor.defaultFormatter": "satokaz.vscode-bs-ctrlchar-remover"
  }
```

å³å¯åœ¨ä¿å­˜ä»£ç çš„æ—¶å€™è‡ªåŠ¨ç§»é™¤è¿™äº›ç‰¹æ®Šçš„éšè—å­—ç¬¦ã€‚

å®ç°æ–¹å¼ä¸»è¦æ˜¯é€šè¿‡æ­£åˆ™å»åŒ¹é…è¿™ç±»éšè—å­—ç¬¦ï¼š

```bash
/[\u0000]|[\u0001]|[\u0002]|[\u0003]|[\u0004]|[\u0005]|[\u0006]|[\u0007]|[\u0008]|[\u000b]|[\u000c]|[\u000d]|[\u000e]|[\u000f]|[\u0010]|[\u0011]|[\u0012]|[\u0013]|[\u0014]|[\u0015]|[\u0016]|[\u0017]|[\u0018]|[\u0019]|[\u001a]|[\u001b]|[\u001c]|[\u001d]|[\u001e]|[\u001f]|[\u001c]|[\u007f]/gm
```

åœ¨è¿™é‡ŒæŸ¥çœ‹æ‰€æœ‰å­—ç¬¦çš„ä»‹ç»ï¼š[Unicode](https://www.techonthenet.com/unicode/chart.php)ï¼Œæœ¬æ–‡æ‰€å‡ºç°çš„ BS æ­£æ˜¯ [\u0008]ï¼Œä¹Ÿå°±æ˜¯é€€æ ¼ç¬¦ã€‚

##### æäº¤ä»£ç å‰è‡ªåŠ¨åˆ é™¤

æ›´å¥½çš„æ–¹å¼æ˜¯ï¼šæˆ‘ä»¬å¯ä»¥åœ¨ precommit é’©å­è‡ªåŠ¨åšè¿™ä»¶äº‹ï¼š

```bash
find . -name "*.wxml" -exec perl -i -p -e "s/[\x08]//g" {} +

# è¿™è¡Œå‘½ä»¤çš„ time total
0.10s user 0.80s system 93% cpu 0.953 total
```

### è®© vscode-hg æäº¤ä»£ç æ—¶æ˜¾ç¤º ESLint æŠ¥é”™çš„è§„åˆ™

èµ·å› æ˜¯æŸä½åŒå­¦åæ˜ åœ¨ vscode-hg æäº¤ä»£ç çš„æ—¶å€™ï¼Œæ— æ³•æ˜¾ç¤º ESLint æ ¡éªŒä¸é€šè¿‡çš„è§„åˆ™æç¤ºï¼š

![image-20220320141520784](https://gd4ark-1258805822.cos.ap-guangzhou.myqcloud.com/images202203201415448.png)

é€šå¸¸æˆ‘ä»¬æäº¤ä»£ç æ—¶ï¼Œå¦‚æœ yarn lint ä¸é€šè¿‡ï¼Œä¼šè¾“å‡ºå¦‚ä¸‹ï¼š

```bash
$ eslint '**/*.js' --cache --fix

/Users/4ark/project/helper/404.js
  9:7  error  'a' is assigned a value but never used  no-unused-vars

âœ– 1 problem (1 error, 0 warnings)

error Command failed with exit code 1.
info Visit https://yarnpkg.com/en/docs/cli/run for documentation about this command.
abort: pre-commit hook exited with status 1
```

è€Œ vscode-hg åªè¾“å‡ºå¦‚ä¸‹ï¼š

```bash
error Command failed with exit code 1.
abort: pre-commit hook exited with status 1
```

ä¸è¿‡ç»æµ‹è¯•åœ¨ VSCode ä¸­è¿›è¡Œ Git ä»£ç æäº¤æ—¶å¹¶ä¸å­˜åœ¨è¯¥é—®é¢˜ï¼Œæ‰€ä»¥çŒœæµ‹æ˜¯ vscode-hg è¿™ä¸ªæ‰©å±•çš„åŸå› ã€‚

äºæ˜¯æŠ±ç€æ€€ç–‘çš„æ€åº¦çœ‹ä¸€ä¸‹æºç ï¼Œå‘ç°æœç„¶å¦‚æ­¤ï¼š

```js
// src/hg.ts#L620
if (options.logErrors !== false && result.stderr) {
    this.log(`${result.stderr}\n`);
}
```

è¿™é‡Œåªè¾“å‡ºäº† stderrï¼Œä½†æ˜¯ ESLint çš„è§„åˆ™è¾“å‡ºæ˜¯ stdoutã€‚

äºæ˜¯æˆ‘ä»¬ä¸ºäº†æ›´å¥½åœ°ä½¿ç”¨ Hg hooksï¼Œè®©å®ƒæ”¯æŒäº†è¾“å‡º ESLint è§„åˆ™ï¼Œè§ [#185](https://github.com/mrcrowl/vscode-hg/issues/185)ã€‚

## ç»“è¯­

ä»¥ä¸Šå°±æ˜¯æˆ‘ä»¬åœ¨å®è·µ Hg hooks è¿‡ç¨‹çš„ä¸€äº›ç»å†å’Œå¿ƒå¾—ï¼Œæœªå¿…æ˜¯æœ€ä½³è§£å†³æ–¹æ¡ˆï¼Œæ­£å¦‚æ–‡æœ¬å¼€å¤´æ‰€è¯´ï¼Œæ’°å†™æœ¬æ–‡çš„ç›®çš„æ˜¯å¸Œæœ›èƒ½èµ·åˆ°æŠ›ç –å¼•ç‰çš„ä½œç”¨ï¼Œä¸å¤§å®¶ä¸€èµ·è¿›ä¸€æ­¥çš„æ·±å…¥æ¢è®¨ã€‚

å¯¹äºæœ¬æ–‡çš„å®è·µæ€è·¯ã€ä»£ç å®ç°æœ‰ä»»ä½•çš„æ„è§å’Œå»ºè®®ï¼Œéƒ½è¯·ä¸åæŒ‡æ•™ã€‚

æœ€åæ„Ÿè°¢å¤§å®¶çš„é˜…è¯»ã€‚

