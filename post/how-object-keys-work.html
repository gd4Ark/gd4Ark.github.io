<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="故事背景有一天上线后大佬在群里反馈了一个问题，他刚发的动态在生成分享卡片的时候，卡片底部的小程序码丢失了，然而其他小伙伴都表示在自己手机上运行正常。事实上大佬也说除了这条动态以外，其它都是正常的。 说明这个 BUG 需要特定的动态卡片 + 特定的设备才能复现，所幸坐我对面的小姐姐手机与大佬是同款，也能复现 BUG，避免了作为社恐的我要去找大佬借手机测试的尴尬。 先交代一下项目背景，这是一个微信小程">
<meta property="og:type" content="article">
<meta property="og:title" content="一行 Object.keys() 引发的血案">
<meta property="og:url" content="https://4ark.me/post/how-object-keys-work.html">
<meta property="og:site_name" content="4Ark × Blog">
<meta property="og:description" content="故事背景有一天上线后大佬在群里反馈了一个问题，他刚发的动态在生成分享卡片的时候，卡片底部的小程序码丢失了，然而其他小伙伴都表示在自己手机上运行正常。事实上大佬也说除了这条动态以外，其它都是正常的。 说明这个 BUG 需要特定的动态卡片 + 特定的设备才能复现，所幸坐我对面的小姐姐手机与大佬是同款，也能复现 BUG，避免了作为社恐的我要去找大佬借手机测试的尴尬。 先交代一下项目背景，这是一个微信小程">
<meta property="og:locale">
<meta property="og:image" content="https://gd4ark-1258805822.cos.ap-guangzhou.myqcloud.com/images/object-keys.jpeg">
<meta property="og:image" content="https://gd4ark-1258805822.cos.ap-guangzhou.myqcloud.com/images/v8-object-keys.jpeg">
<meta property="og:image" content="https://gd4ark-1258805822.cos.ap-guangzhou.myqcloud.com/images/WechatIMG100.jpeg">
<meta property="og:image" content="https://gd4ark-1258805822.cos.ap-guangzhou.myqcloud.com/images/Snipaste_2021-12-08_00-07-16.png">
<meta property="og:image" content="https://gd4ark-1258805822.cos.ap-guangzhou.myqcloud.com/images/object-keys.jpeg">
<meta property="og:image" content="https://gd4ark-1258805822.cos.ap-guangzhou.myqcloud.com/images/%E4%B8%8B%E8%BD%BD.jpeg">
<meta property="og:image" content="https://gd4ark-1258805822.cos.ap-guangzhou.myqcloud.com/images/v8-object-keys.jpeg">
<meta property="og:image" content="https://ozinparis.com/wp-content/uploads/2016/04/jon-snow-know-nothing-e1461048094110-1.jpg">
<meta property="article:published_time" content="2021-12-06T00:00:00.000Z">
<meta property="article:modified_time" content="2024-02-06T18:11:56.000Z">
<meta property="article:author" content="4Ark">
<meta property="article:tag" content="前端">
<meta property="article:tag" content="JavaScript">
<meta property="article:tag" content="V8">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://gd4ark-1258805822.cos.ap-guangzhou.myqcloud.com/images/object-keys.jpeg">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>一行 Object.keys() 引发的血案</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <script>localStorage.getItem("dark_mode")==="dark"&&document.write(`<link rel="stylesheet" href="${location.origin}/css/dark.css">`)</script>
    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
    <meta name="google-site-verification" content="DwDg4EuywHWNZUkTC7sG0WGv_UQekM4uRtOoaGuDJHc" />
<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="4Ark × Blog" type="application/atom+xml">
<link rel="alternate" href="/rss.xml" title="4Ark × Blog" type="application/rss+xml">
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about">About</a></li><!--
     --><!--
       --><li><a href="/archives">Writing</a></li><!--
     --><!--
       --><li><a href="/weekly">Weekly</a></li><!--
     --><!--
       --><li><a href="/tags">Tags</a></li><!--
     --><!--
       --><li><a href="/search">Search</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/post/2021-summary.html"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/post/vue-router-score-code.html"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon"><i class="fa fa-moon" id="dark-btn" aria-hidden="true" onmouseover="$('#i-dark').toggle()" onmouseout="$('#i-dark').toggle()"></i></a></li>
        <li><a class="icon" target="_blank" rel="noopener" href="https://4ark.me/atom.xml" aria-label="rss"><i class="fas fa-rss"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-dark" class="info" style="display: none;">Switch mode</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://4ark.me/post/how-object-keys-work.html"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://4ark.me/post/how-object-keys-work.html&text=一行 Object.keys() 引发的血案"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://4ark.me/post/how-object-keys-work.html&title=一行 Object.keys() 引发的血案"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://4ark.me/post/how-object-keys-work.html&is_video=false&description=一行 Object.keys() 引发的血案"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=一行 Object.keys() 引发的血案&body=Check out this article: https://4ark.me/post/how-object-keys-work.html"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://4ark.me/post/how-object-keys-work.html&title=一行 Object.keys() 引发的血案"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://4ark.me/post/how-object-keys-work.html&title=一行 Object.keys() 引发的血案"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://4ark.me/post/how-object-keys-work.html&title=一行 Object.keys() 引发的血案"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://4ark.me/post/how-object-keys-work.html&title=一行 Object.keys() 引发的血案"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://4ark.me/post/how-object-keys-work.html&name=一行 Object.keys() 引发的血案&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://4ark.me/post/how-object-keys-work.html&t=一行 Object.keys() 引发的血案"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%85%E4%BA%8B%E8%83%8C%E6%99%AF"><span class="toc-number">1.</span> <span class="toc-text">故事背景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TL-DR"><span class="toc-number">2.</span> <span class="toc-text">TL;DR</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3%E8%AF%A5-BUG"><span class="toc-number">3.</span> <span class="toc-text">如何解决该 BUG</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-Object-keys"><span class="toc-number">4.</span> <span class="toc-text">深入理解 Object.keys()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#V8-%E6%98%AF%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86%E5%AF%B9%E8%B1%A1%E5%B1%9E%E6%80%A7%E7%9A%84"><span class="toc-number">5.</span> <span class="toc-text">V8 是如何处理对象属性的</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%99%E5%9C%A8%E6%9C%80%E5%90%8E"><span class="toc-number">6.</span> <span class="toc-text">写在最后</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BB%B6%E4%BC%B8%E9%98%85%E8%AF%BB"><span class="toc-number">7.</span> <span class="toc-text">延伸阅读</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        一行 Object.keys() 引发的血案
    </h1>



    <div class="meta">
      <span
        class="author"
        itemprop="author"
        itemscope
        itemtype="http://schema.org/Person"
      >
        <span itemprop="name"
          >4Ark</span
        >
      </span>
      
    <div class="postdate">
      
        <time datetime="2021-12-06T00:00:00.000Z" itemprop="datePublished">2021-12-06</time>
        
      
    </div>

 
      
        
 
        
    <div class="article-tag">
        <i class="fas fa-hashtag"></i>
        <a class="tag-link-link" href="/tags/JavaScript/" rel="tag">JavaScript</a>, <a class="tag-link-link" href="/tags/V8/" rel="tag">V8</a>, <a class="tag-link-link" href="/tags/%E5%89%8D%E7%AB%AF/" rel="tag">前端</a>
    </div>


      
    </div>
  </header>
  

  <div class="content" itemprop="articleBody"><h2 id="故事背景"><a href="#故事背景" class="headerlink" title="故事背景"></a>故事背景</h2><p>有一天上线后大佬在群里反馈了一个问题，他刚发的动态在生成分享卡片的时候，卡片底部的小程序码丢失了，然而其他小伙伴都表示在自己手机上运行正常。事实上大佬也说除了这条动态以外，其它都是正常的。</p>
<p>说明这个 BUG 需要特定的动态卡片 + 特定的设备才能复现，所幸坐我对面的小姐姐手机与大佬是同款，也能复现 BUG，避免了作为社恐的我要去找大佬借手机测试的尴尬。</p>
<p>先交代一下项目背景，这是一个微信小程序项目，其中生成分享卡片功能用到的是一个叫 <a target="_blank" rel="noopener" href="https://github.com/wg-front/wxml2canvas">wxml2canvas</a> 的库，然而该库目前看上去已经「年久失修」，上面所说的 BUG 就是因为这个库，本文主要对其进行「鞭尸」之余，顺便分享一下排查该 BUG 的过程、以及如何从 ECMAScript 规范中找到关于 <code>Object.keys()</code> 返回顺序的规范定义，最后介绍一下在 V8 引擎中是如何处理对象属性的。</p>
<p>希望大家在阅读本文后，不会再因为搞不懂  <code>Object.keys()</code> 输出的顺序而犯错导致产生莫名其妙的 BUG。</p>
<h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h2><blockquote>
<p>浪费读者的时间是可耻的。———— 鲁迅</p>
</blockquote>
<p>本文很长，如果你不想阅读整篇文章，可以阅读这段摘要；如果你打算阅读整篇文章，那么你完全可以跳过本段。</p>
<p>如果阅读摘要时未能帮助你理解，可以跳转到对应章节进行详细阅读。</p>
<p>摘要：</p>
<ol>
<li>这个 BUG 是如何产生的？</li>
</ol>
<ul>
<li><code>wxml2canvas</code> 在绘制的时候，会根据一个叫做 <code>sorted</code> 的对象对它的 keys 进行遍历，该对象的 key 为节点的 top 值，value 为节点元素；问题就是出在这里，该库作者误以为 <code>Object.keys()</code> 总是会按照实际创建属性的顺序返回，<strong>然而当 key 为正整数的时候</strong>，返回顺序就不符合原本的预期了，会出现了绘制顺序错乱，从而导致这个 BUG 的产生。</li>
<li>源码：<a target="_blank" rel="noopener" href="https://github.com/wg-front/wxml2canvas/blob/master/src/index.js#L1146">src/index.js#L1146</a> 和 <a target="_blank" rel="noopener" href="https://github.com/wg-front/wxml2canvas/blob/master/src/index.js#L829">src/index.js#L829</a></li>
</ul>
<ol start="2">
<li>如何解决这个 BUG</li>
</ol>
<ul>
<li>由于对象的 key 是一个数字，那么 key 有可能会是整数，也有可能是浮点数。但是预期行为是希望  <code>Object.keys()</code> 按照属性实际创建的顺序返回，那只要将所有 key 都强制转换为浮点数就好了。</li>
</ul>
<ol start="3">
<li><code>Object.keys()</code> 是按照什么顺序返回值的？</li>
</ol>
<ul>
<li><code>Object.keys()</code> 返回顺序与遍历对象属性时的顺序一样，调用的是 <code>[[OwnPropertyKeys]]()</code> 内部方法。</li>
<li>根据 <a target="_blank" rel="noopener" href="https://262.ecma-international.org/6.0/#sec-ordinary-object-internal-methods-and-internal-slots-ownpropertykeys">ECMAScript 规范</a>，在输出 keys 时会<strong>先将所有 key 为数组索引类型（正整数）从小到大的顺序排序，然后将所有字符串类型（包括负数、浮点数）的 key 按照实际创建的顺序来排序</strong>。</li>
</ul>
<ol start="4">
<li>V8 内部是如何处理对象属性的？</li>
</ol>
<ul>
<li>V8 在存储对象属性时，为了提高访问效率，会分为<strong>常规属性(properties)</strong> 和 <strong>排序属性(elements)</strong><ul>
<li><strong>排序属性(elements)</strong> ，就是数组索引类型的属性（也就是正整数类型）。</li>
<li><strong>常规属性(properties)</strong> ，就是字符串类型的属性（也包括负数、浮点数）。</li>
<li>以上两种属性都会存放在线性结构中，称为<strong>快属性</strong>。</li>
<li>然而这样每次查询都有一个间接层，会影响效率，所以 V8 引入<strong>对象内属性(in-object-properties)</strong>  。</li>
</ul>
</li>
<li>V8 会为每一个对象关联一个隐藏类，用于记录该对象的形状，相同形状的对象会共用同一个隐藏类。<ul>
<li>当对象添加、删除属性的时候，会创建一个新的对应的<strong>隐藏类</strong>，并重新关联。</li>
</ul>
</li>
<li><strong>对象内属性</strong>会将部分<strong>常规属性</strong>直接放在对象第一层，所以它访问效率是最高的。<ul>
<li>当<strong>常规属性</strong>的数量<strong>少于对象初始化时的属性数量</strong>时，<strong>常规属性</strong>会直接作为<strong>对象内属性</strong>存放。</li>
</ul>
</li>
<li>虽然<strong>快属性</strong>访问速度快，但是从线性结构中添加或删除时执行效率会非常低，因此如果属性特别多、或出现添加和删除属性时，就会将<strong>常规属性</strong>从线性存储改为字典存储，这就是<strong>慢属性</strong>。</li>
</ul>
<p>可以看一下这两张图帮助理解：</p>
<p><img src="https://gd4ark-1258805822.cos.ap-guangzhou.myqcloud.com/images/object-keys.jpeg"></p>
<p style="text-align:center;">V8 常规属性和排序属性</p>

<p><img src="https://gd4ark-1258805822.cos.ap-guangzhou.myqcloud.com/images/v8-object-keys.jpeg"></p>
<p style="text-align:center;">V8 对象内属性、快属性和慢属性</p>
<p style="text-align:center;"><a target="_blank" rel="noopener" href="https://time.geekbang.org/column/intro/100048001">图片出处：《图解 Google V8》 —— 极客时间</a></p>

<h2 id="如何解决该-BUG"><a href="#如何解决该-BUG" class="headerlink" title="如何解决该 BUG"></a>如何解决该 BUG</h2><p>由于是特定的动态 + 特定的设备才能复现问题，可以很轻易地排除掉网络原因，通过在 <code>wxml2canvas</code> 输出绘制的节点列表，也能看到小程序码相关的节点。</p>
<p>既然 <code>wxml2canvas</code> 已经接收到小程序码的节点，却没有绘制出来，那么问题自然就出在 <code>wxml2canvas</code>  内部，不过已经见怪不怪了，在我加入项目以后就已经多次因为这操蛋的 <code>wxml2canvas</code> 出现各种问题而搞得头皮发麻，有机会一定要替换掉这个库，但由于已经有很多页面在依赖这个库，现在也只能硬着头皮上。</p>
<p>首先怀疑是小程序码节点的坐标位置不太对，通过对比，发现位置相差不大，排除该原因。</p>
<p>然后对比所有节点的绘制顺序，发现了一个不太寻常的点，在复现 BUG 的手机上，绘制小程序码节点的时机是比较靠前的，但由于它在卡片底部，所以在正常情况下，应该是比较靠后才对。</p>
<p>于是通过查看相关代码，果然发现了其中的玄机：</p>
<p><img src="https://gd4ark-1258805822.cos.ap-guangzhou.myqcloud.com/images/WechatIMG100.jpeg"></p>
<p>在绘制的时候，通过遍历 <code>sorted</code> 对象，从上往下、从左到右依次绘制，但是通过对比两台手机的 <code>Object.keys()</code>，发现了它们的输出是不一样的，这时候我就明白怎么回事了。</p>
<p>先来说说这个 <code>sorted</code> 对象，它是一个 key 为节点 top 值，value 为所有相同 top 值（同一行）的元素数组。</p>
<p>下面是生成它的代码：</p>
<p><img src="https://gd4ark-1258805822.cos.ap-guangzhou.myqcloud.com/images/Snipaste_2021-12-08_00-07-16.png"></p>
<p>问题就发生在前面所说的 <code>Object.keys()</code> 这里，我们先来看个 🌰：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sorted = &#123;&#125;</span><br><span class="line"></span><br><span class="line">sorted[<span class="number">300</span>] = &#123;&#125;</span><br><span class="line">sorted[<span class="number">200</span>] = &#123;&#125;</span><br><span class="line">sorted[<span class="number">100</span>] = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">Object</span>.keys(sorted)) <span class="comment">// 输出什么呢？</span></span><br></pre></td></tr></table></figure>

<p>相信大部分同学都知道答案是：[‘100’, ‘200’, ‘300’]。</p>
<p>如果在有浮点数的情况呢？</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sorted = &#123;&#125;</span><br><span class="line"></span><br><span class="line">sorted[<span class="number">300</span>] = &#123;&#125;</span><br><span class="line">sorted[<span class="number">100</span>] = &#123;&#125;</span><br><span class="line">sorted[<span class="number">200</span>] = &#123;&#125;</span><br><span class="line">sorted[<span class="number">50.5</span>] = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">Object</span>.keys(sorted)) <span class="comment">// 这次又输出什么呢？</span></span><br></pre></td></tr></table></figure>

<p>会不会有同学以为答案是：[‘50.5’, ‘100’, ‘200’, ‘300’] 呢？</p>
<p>但正确的答案应该是：[‘100’, ‘200’, ‘300’,’50.5’]。</p>
<p>所以我合理地猜测 <code>wxml2canvas</code> 的作者就是犯了这样的错误，他可能以为 <code>Object.keys</code>  会根据 key 从小到大的顺序返回，因此满足从上往下绘制的逻辑。但是他却没有考虑浮点数的情况，所以当某个节点 top 值为整数的时候，会比其他 top 值为浮点数的节点更早地绘制，导致绘制后面的节点时覆盖了前面的节点。</p>
<p>于是，当我把代码改成这样后，分享卡片的小程序码就正常绘制出来了：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  Object</span><br><span class="line">  .keys(sorted)</span><br><span class="line"><span class="addition">+ .sort((a, b)=&gt; a - b)</span></span><br><span class="line">  .forEach((top, topIndex) =&gt; &#123;</span><br><span class="line">    //  do something</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>OK，搞定收工。</p>
<p><strong>测试小姐姐</strong>：慢着！影响到其它地方了。</p>
<p>我一看，果然。于是再次经过对比，发现原来大部分情况下，top 值都会是浮点数，而本次出 BUG 的卡片小程序码只是非常凑巧地为整数，导致绘制顺序不对。</p>
<p>我才发现 <code>wxml2canvas</code> 原本的逻辑是想根据 <code>sorted</code> 创建的顺序来绘制，但是没有考虑 key 为整数的情况。</p>
<p>所以，最后这样修改解决问题：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">_sortListByTop (list = []) &#123;</span><br><span class="line">    let sorted = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    // 粗略地认为2px相差的元素在同一行</span><br><span class="line">    list.forEach((item, index) =&gt; &#123;</span><br><span class="line"><span class="deletion">-       let top = item.top;</span></span><br><span class="line"><span class="addition">+       let top = item.top.toFixed(6); // 强制添加小数点，将整数转为浮点数</span></span><br><span class="line">        if (!sorted[top]) &#123;</span><br><span class="line">            if (sorted[top - 2]) &#123;</span><br><span class="line">                top = top - 2;</span><br><span class="line">            &#125;else if (sorted[top - 1]) &#123;</span><br><span class="line">                top = top - 1;</span><br><span class="line">            &#125; else if (sorted[top + 1]) &#123;</span><br><span class="line">                top = top + 1;</span><br><span class="line">            &#125; else if (sorted[top + 2]) &#123;</span><br><span class="line">                top = top + 2;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                sorted[top] = [];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        sorted[top].push(item);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    return sorted;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>很显然，是因为 <code>wxml2canvas</code> 作者对 <code>Object.keys()</code> 返回顺序的机制不了解，才导致出现这样的 BUG。</p>
<p>不知道是否也有同学犯过同样的错误，为避免再次出现这样的情况，非常有必要深入、全面地介绍一下 <code>Object.keys()</code> 的执行机制。 </p>
<p>所以接下来就跟随我一探究竟吧。</p>
<h2 id="深入理解-Object-keys"><a href="#深入理解-Object-keys" class="headerlink" title="深入理解 Object.keys()"></a>深入理解 Object.keys()</h2><p>可能会有同学说： <code>Object.keys()</code> 又不是什么新出的 API， Google 一下不就行了，何必大费周章写一篇文章来介绍呢？</p>
<p>的确通过搜索引擎可以很快就能知道 <code>Object.keys()</code> 的返回顺序是怎样的，但是很多都只流于表面，甚至我还见过这样片面的回答：数字排前面，字符串排后面。</p>
<p>所以这次我想试着追本溯源，通过第一手资料来获取信息，轻易相信口口相传得来的信息，都极有可能是片面的、甚至是错误的。</p>
<p>PS：其实不光技术，我们在对待其它不了解的事物都应保持同样的态度。 </p>
<p>我们先来看看在 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/keys">MDN</a> 上关于 <code>Object.keys()</code> 的描述：</p>
<blockquote>
<p><code>Object.keys()</code> 方法会返回一个由一个给定对象的自身可枚举属性组成的数组，数组中属性名的排列顺序和正常循环遍历该对象时返回的顺序一致 。</p>
</blockquote>
<p>emmm… 并没有直接告诉我们输出顺序是什么，不过我们可以看看上面的 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/keys#polyfill">Polyfill</a> 是怎么写的：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="built_in">Object</span>.keys) &#123;</span><br><span class="line">  <span class="built_in">Object</span>.keys = (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> hasOwnProperty = <span class="built_in">Object</span>.prototype.hasOwnProperty,</span><br><span class="line">        hasDontEnumBug = !(&#123;<span class="attr">toString</span>: <span class="literal">null</span>&#125;).propertyIsEnumerable(<span class="string">&#x27;toString&#x27;</span>),</span><br><span class="line">        dontEnums = [</span><br><span class="line">          <span class="string">&#x27;toString&#x27;</span>,</span><br><span class="line">          <span class="string">&#x27;toLocaleString&#x27;</span>,</span><br><span class="line">          <span class="string">&#x27;valueOf&#x27;</span>,</span><br><span class="line">          <span class="string">&#x27;hasOwnProperty&#x27;</span>,</span><br><span class="line">          <span class="string">&#x27;isPrototypeOf&#x27;</span>,</span><br><span class="line">          <span class="string">&#x27;propertyIsEnumerable&#x27;</span>,</span><br><span class="line">          <span class="string">&#x27;constructor&#x27;</span></span><br><span class="line">        ],</span><br><span class="line">        dontEnumsLength = dontEnums.length;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">obj</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> obj !== <span class="string">&#x27;object&#x27;</span> &amp;&amp; <span class="keyword">typeof</span> obj !== <span class="string">&#x27;function&#x27;</span> || obj === <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">&#x27;Object.keys called on non-object&#x27;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">var</span> result = [];</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">var</span> prop <span class="keyword">in</span> obj) &#123;</span><br><span class="line">        <span class="keyword">if</span> (hasOwnProperty.call(obj, prop)) result.push(prop);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (hasDontEnumBug) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i &lt; dontEnumsLength; i++) &#123;</span><br><span class="line">          <span class="keyword">if</span> (hasOwnProperty.call(obj, dontEnums[i])) result.push(dontEnums[i]);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)()</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>其实就是利用 <code>for...in</code> 来进行遍历，接下来我们可以再看看关于 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/for...in">for…in</a> 的文档，然而里面也没有告诉我们顺序是怎样的。</p>
<p>既然 MDN 上没有，那我们可以直接看 ECMAScript 规范，通常 MDN 上都会附上关于这个 API 的规范链接，我们直接点开最新（Living Standard）的那个，下面是关于 Object.keys 的<a target="_blank" rel="noopener" href="https://tc39.es/ecma262/#sec-object.keys">规范定义</a>：</p>
<blockquote>
<p>When the keys function is called with argument <em>O</em>, the following steps are taken:</p>
<ol>
<li> Let <em>obj</em> be ? <a target="_blank" rel="noopener" href="https://tc39.es/ecma262/#sec-toobject">ToObject</a>(<em>O</em>).</li>
<li> Let <em>nameList</em> be ? <a target="_blank" rel="noopener" href="https://tc39.es/ecma262/#sec-enumerableownpropertynames">EnumerableOwnPropertyNames</a>(<em>obj</em>, key).</li>
<li> Return <a target="_blank" rel="noopener" href="https://tc39.es/ecma262/#sec-createarrayfromlist">CreateArrayFromList</a>(<em>nameList</em>).</li>
</ol>
</blockquote>
<p>对象属性列表是通过 <code> EnumerableOwnPropertyNames</code> 获取的，这是它的<a target="_blank" rel="noopener" href="https://tc39.es/ecma262/#sec-enumerableownpropertynames">规范定义</a>：</p>
<blockquote>
<p>The abstract operation EnumerableOwnPropertyNames takes arguments O (an Object) and kind (key, value, or key+value). It performs the following steps when called:</p>
<ol>
<li><p>Let ownKeys be ? O.<a href="">[OwnPropertyKeys]</a>.</p>
</li>
<li><p>Let properties be a new empty List.</p>
</li>
<li><p>For each element key of ownKeys, do<br> a. If Type(key) is String, then</p>
<ol>
<li>Let desc be ? O.<a href="key">[GetOwnProperty]</a>.</li>
<li>If desc is not undefined and desc.[[Enumerable]] is true, then<br> a. If kind is key, append key to properties.<br> b. Else,<ol>
<li>Let value be ? Get(O, key).</li>
<li>If kind is value, append value to properties.</li>
<li>Else<br> i. Assert: kind is key+value.<br> ii. Let entry be ! CreateArrayFromList(« key, value »).<br> iii. Append entry to properties.</li>
</ol>
</li>
</ol>
</li>
<li><p>Return properties.</p>
</li>
</ol>
</blockquote>
<p><strong>敲黑板！</strong> 这里有个细节，请同学们多留意，后面会考。</p>
<p>我们接着探索，<code>OwnPropertyKeys</code> 最终返回的 <code>OrdinaryOwnPropertyKeys</code>：</p>
<blockquote>
<p>The [[OwnPropertyKeys]] internal method of an ordinary object O takes no arguments. It performs the following steps when called:</p>
<ol>
<li>Return ! <a target="_blank" rel="noopener" href="https://tc39.es/ecma262/#sec-ordinaryownpropertykeys">OrdinaryOwnPropertyKeys(O)</a>.</li>
</ol>
</blockquote>
<p>重头戏来了，关于 keys 如何排序就在 <code>OrdinaryOwnPropertyKeys</code> 的<a target="_blank" rel="noopener" href="https://tc39.es/ecma262/#sec-ordinaryownpropertykeys">定义</a>中：</p>
<blockquote>
<p>The abstract operation OrdinaryOwnPropertyKeys takes argument O (an Object). It performs the following steps when called:</p>
<ol>
<li>Let keys be a new empty List.</li>
<li>For each own property key P of O such that P is an array index, in ascending numeric index order, do<br> a. Add P as the last element of keys.</li>
<li>For each own property key P of O such that Type(P) is String and P is not an array index, in ascending chronological order of property creation, do<br> a. Add P as the last element of keys.</li>
<li>For each own property key P of O such that Type(P) is Symbol, in ascending chronological order of property creation, do<br> a. Add P as the last element of keys.</li>
<li>Return keys.</li>
</ol>
</blockquote>
<p>到这里，我们已经知道我们想要的答案，这里总结一下：</p>
<ol>
<li>创建一个空的列表用于存放 keys</li>
<li>将所有<strong>合法的数组索引</strong>按升序的顺序存入</li>
<li>将所有<strong>字符串类型索引</strong>按属性创建时间以升序的顺序存入</li>
<li>将所有 <strong><code>Symbol</code> 类型索引</strong>按属性创建时间以升序的顺序存入</li>
<li>返回 keys</li>
</ol>
<p>这里顺便也纠正一个普遍的误区：有些回答说将所有属性为数字类型的 key 从小到大排序，其实不然，还必须要符合<strong>「合法的数组索引」</strong>，也即只有<strong>正整数</strong>才行，负数或者浮点数，一律当做字符串处理。</p>
<p>PS：严格来说对象属性没有数字类型的，无论是数字还是字符串，都会被当做字符串来处理。</p>
<p>我们结合上面的规范，来思考一下下面这段代码会输出什么：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> testObj = &#123;&#125;</span><br><span class="line"></span><br><span class="line">testObj[-<span class="number">1</span>] = <span class="string">&#x27;&#x27;</span></span><br><span class="line">testObj[<span class="number">1</span>] = <span class="string">&#x27;&#x27;</span></span><br><span class="line">testObj[<span class="number">1.1</span>] = <span class="string">&#x27;&#x27;</span></span><br><span class="line">testObj[<span class="string">&#x27;2&#x27;</span>] = <span class="string">&#x27;&#x27;</span></span><br><span class="line">testObj[<span class="string">&#x27;c&#x27;</span>] = <span class="string">&#x27;&#x27;</span></span><br><span class="line">testObj[<span class="string">&#x27;b&#x27;</span>] = <span class="string">&#x27;&#x27;</span></span><br><span class="line">testObj[<span class="string">&#x27;a&#x27;</span>] = <span class="string">&#x27;&#x27;</span></span><br><span class="line">testObj[<span class="built_in">Symbol</span>(<span class="number">1</span>)] = <span class="string">&#x27;&#x27;</span></span><br><span class="line">testObj[<span class="built_in">Symbol</span>(<span class="string">&#x27;a&#x27;</span>)] = <span class="string">&#x27;&#x27;</span></span><br><span class="line">testObj[<span class="built_in">Symbol</span>(<span class="string">&#x27;b&#x27;</span>)] = <span class="string">&#x27;&#x27;</span></span><br><span class="line">testObj[<span class="string">&#x27;d&#x27;</span>] = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">Object</span>.keys(testObj))</span><br></pre></td></tr></table></figure>

<p>请认真思考后，在这里核对你的答案是否正确：</p>
<details>
  <summary>查看结果</summary>
  
  <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&#x27;<span class="number">1</span>&#x27;, &#x27;<span class="number">2</span>&#x27;, &#x27;<span class="number">-1</span>&#x27;, &#x27;<span class="number">1.1</span>&#x27;, &#x27;c&#x27;, &#x27;b&#x27;, &#x27;a&#x27;, &#x27;d&#x27;]</span><br></pre></td></tr></table></figure>
<p>  是否与你想象的一致？你可能会奇怪为什么没有 <code>Symbol</code> 类型。</p>
<p>  还记得前面敲黑板让同学们留意的地方吗，因为在 <code>EnumerableOwnPropertyNames</code> 的规范中规定了返回值只应包含字符串属性（上面说了数字其实也是字符串）。</p>
<p>  所以 Symbol 属性是不会被返回的，可以看 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/getOwnPropertyNames">MDN</a> 上关于 <code>Object.getOwnPropertyNames()</code> 的描述。</p>
<p>  如果要返回 Symbol 属性可以用 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/getOwnPropertySymbols">Object.getOwnPropertySymbols()</a>。</p>
</details>



<p>看完 ECMAScript 的规范定义，相信你不会再搞错 <code>Object.keys()</code> 的输出顺序了。但是你好奇 V8 是如何处理对象属性的吗，下一节我们就来讲讲。</p>
<h2 id="V8-是如何处理对象属性的"><a href="#V8-是如何处理对象属性的" class="headerlink" title="V8 是如何处理对象属性的"></a>V8 是如何处理对象属性的</h2><p>在 V8 的官方博客上有一篇文章<a target="_blank" rel="noopener" href="https://v8.dev/blog/fast-properties">《Fast properties in V8》</a>（<a target="_blank" rel="noopener" href="https://blog.crimx.com/2018/11/25/v8-fast-properties/">中译版</a>），非常详细地向我们解释了 V8 内部如何处理 JavaScript 的对象属性，强烈推荐阅读。</p>
<p>另外再推荐一下极客时间上的课程《<a target="_blank" rel="noopener" href="https://time.geekbang.org/column/intro/100048001">图解 Google V8</a>》（毕竟本文借用了里面的图片，怎么好意思不推荐）。</p>
<p>本节内容主要参考这两个地方，下面我们来总结一下。</p>
<p>首先，V8 为了提高对象属性的访问效率，将属性分为两种类型：</p>
<ul>
<li><p><strong>排序属性(elements)</strong> ，就是符合数组索引类型的属性（也就是正整数）。</p>
</li>
<li><p><strong>常规属性(properties)</strong> ，就是字符串类型的属性（也包括负数、浮点数）。</p>
</li>
</ul>
<p>所有的<strong>排序属性</strong>都会存放在一个线性结构中，线性结构的特点就是支持通过索引随机访问，所以能加快访问速度，对于存放在线性结构的属性都称为<strong>快属性</strong>。</p>
<p><strong>常规属性</strong>也会存放在另一个线性结构中，可以看下面这张图帮助理解：</p>
<p><img src="https://gd4ark-1258805822.cos.ap-guangzhou.myqcloud.com/images/object-keys.jpeg" alt="img"></p>
<p style="text-align:center;">V8 排序属性和常规属性</p>

<p>但是<strong>常规属性</strong>还需要做一些额外的处理，这里我们要先介绍一下什么是<strong>隐藏类</strong>。</p>
<p>由于 JavaScript 在运行时是可以修改对象属性的，所以在查询的时候会比较慢，可以看回上面那张图，每次访问一个属性的时候都需要经过多一层的访问，而像 C++ 这类静态语言在声明对象之前需要定义这个对象的结构（形状），经过编译后每个对象的形状都是固定的，所以在访问的时候由于知道了属性的偏移量，自然就会比较快。</p>
<p>V8 采用的思路就是将这种机制应用在 JavaScript 对象中，所以引入了<strong>隐藏类</strong>的机制，你可以简单的理解<strong>隐藏类</strong>就是描述这个对象的形状、包括每个属性对应的位置，这样查询的时候就会快很多。</p>
<p>关于<strong>隐藏类</strong>还有几点要补充：</p>
<ol>
<li>对象的第一个字段指向它的<strong>隐藏类</strong>。</li>
<li>如果两个对象的形状是完全相同的，会共用同一个<strong>隐藏类</strong>。</li>
<li>当对象添加、删除属性的时候，会创建一个新的对应的<strong>隐藏类</strong>，并重新指向它。</li>
<li>V8 有一个转换树的机制来创建隐藏类，不过本文不赘述，有兴趣可以看<a target="_blank" rel="noopener" href="https://v8.dev/blog/fast-properties#hiddenclasses-and-descriptorarrays">这里</a>。</li>
</ol>
<p>解释完隐藏类，我们再回头来讲讲<strong>常规属性</strong>，通过上面那张图我们很容易发现一个问题，那就是每次访问一个属性的时候，都需要经过一个间接层才能访问，这无疑降低了访问效率，为了解决这个问题，V8 又引入了一个叫做<strong>对象内属性</strong>，顾名思义，它会将某些属性直接存放在对象的第一层里，它的访问是最快的，如下图所示：</p>
<p><img src="https://gd4ark-1258805822.cos.ap-guangzhou.myqcloud.com/images/%E4%B8%8B%E8%BD%BD.jpeg"></p>
<p style="text-align:center;">V8 对象内属性</p>

<p>但要注意，<strong>对象内属性</strong>只存放<strong>常规属性</strong>，排序属性依旧不变。而且需要常规属性的数量<strong>小于</strong>某个数量的时候才会直接存放<strong>对象内属性</strong>，那这个数量是多少呢？</p>
<p>答案是取决于<strong>对象初始化时的大小</strong>。</p>
<p>PS：有些文章说是少于 10 个属性时才会存放对象内属性，<strong>别被误导了</strong>。</p>
<p>除了<strong>对象内属性</strong>、<strong>快属性</strong>以外，还有一个<strong>慢属性</strong>。</p>
<p>为什么会有<strong>慢属性</strong>呢？<strong>快属性</strong>虽然访问很快，但是如果要从对象中添加或删除大量属性，则可能会产生大量时间和内存开销来维护<strong>隐藏类</strong>，所以在<strong>属性过多或者反复添加、删除属性时</strong>会将<strong>常规属性</strong>的存储方式从线性结构变成字典，也就是降级到<strong>慢属性</strong>，而由于<strong>慢属性</strong>的信息不会再存放在<strong>隐藏类</strong>中，所以它的访问会比<strong>快属性</strong>要慢，但是可以高效地添加和删除属性。可以通过下图帮助理解：</p>
<p><img src="https://gd4ark-1258805822.cos.ap-guangzhou.myqcloud.com/images/v8-object-keys.jpeg" alt="img"></p>
<p style="text-align:center;">V8 慢属性</p>

<p>写到这里，我觉得自己对 V8 的快属性、慢属性这些知识已经非常了解，简直要牛逼到上天了。</p>
<p>但当我看到这段代码的时候：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">toFastProperties</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">    <span class="comment">/*jshint -W027*/</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line">    f.prototype = obj;</span><br><span class="line">    ASSERT(<span class="string">&quot;%HasFastProperties&quot;</span>, <span class="literal">true</span>, obj);</span><br><span class="line">    <span class="keyword">return</span> f;</span><br><span class="line">    <span class="built_in">eval</span>(obj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我的心情是这样的：</p>
<img src="https://ozinparis.com/wp-content/uploads/2016/04/jon-snow-know-nothing-e1461048094110-1.jpg" style="text-align: left; margin-left: 0;" />

<p>关于这段代码是如何能让 V8 使用对象<strong>快属性</strong>的可以看这篇文章：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/25069272">开启 V8 对象属性的“fast”模式</a>。</p>
<p>另外也可以看一下这段代码：<a target="_blank" rel="noopener" href="https://github.com/sindresorhus/to-fast-properties/blob/main/index.js">to-fast-properties/index.js</a>。</p>
<h2 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h2><p>当在开发时遇到一个简单的错误，通常可以很快地利用搜索引擎解决问题，但如果只是面向 Google 编程，可能在技术上很难会有进步，所以我们不光要能解决问题，还要理解这个产生问题的背后的原因到底是什么，也就是知其然更知其所以然。</p>
<p>真的非常建议每个 JavaScript 开发者都应该去了解一些关于 V8 或其它 JavaScript 引擎的知识，无论你是通过什么途径（真的没有打广告），这样能保证我们在编写 JavaScript 代码时出现问题可以更加地得心应手。</p>
<p>最后，本文篇幅有限，部分细节难免会有遗漏，非常建议有兴趣深入了解的同学可以延伸阅读下面的列表。</p>
<p>感谢阅读。</p>
<h2 id="延伸阅读"><a href="#延伸阅读" class="headerlink" title="延伸阅读"></a>延伸阅读</h2><ul>
<li><a target="_blank" rel="noopener" href="https://v8.dev/blog/fast-properties">Fast properties in V8</a><ul>
<li><a target="_blank" rel="noopener" href="https://blog.crimx.com/2018/11/25/v8-fast-properties/">中译版</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://time.geekbang.org/column/intro/100048001">《图解 Google V8》 —— 极客时间</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.dashlane.com/how-is-data-stored-in-v8-js-engine-memory/">How is data stored in V8 JS engine memory?</a></li>
<li><a target="_blank" rel="noopener" href="https://z3rog.tech/blog/2020/fast-properties.html">V8 中的快慢属性与快慢数组</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/25069272">开启 V8 对象属性的“fast”模式</a></li>
<li><a target="_blank" rel="noopener" href="https://262.ecma-international.org/6.0/">ECMAScript® 2015 Language Specification</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/5525795/does-javascript-guarantee-object-property-order">Does JavaScript guarantee object property order? —— stackoverflow</a></li>
</ul>
</div>
  <hr class="copy-line" />
  <div class="post-copyright">
    <div class="copy-author">
      <span>作者 :</span>
      <span
        >4Ark</span
      >
    </div>
    <div class="copy-url">
      <span>地址 :</span>
      <a href="https://4ark.me/post/how-object-keys-work.html">https://4ark.me/post/how-object-keys-work.html</a>
    </div>
    <div class="copy-origin">
      <span>来源 :</span>
      <a href="https://4ark.me">https://4ark.me</a>
    </div>
    <div class="copy-license">著作权归作者所有，转载请联系作者获得授权。</div>
  </div>
</article>

<div class="blog-post-comments">
  <div id="load-disqus">
    <p onclick="loadDisqus()" style="cursor: pointer; text-align: center">
      🥳&nbsp;加载 Disqus 评论
    </p>
  </div>
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the comments.</noscript>
  </div>
</div>
 


        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about">About</a></li>
         
          <li><a href="/archives">Writing</a></li>
         
          <li><a href="/weekly">Weekly</a></li>
         
          <li><a href="/tags">Tags</a></li>
         
          <li><a href="/search">Search</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%85%E4%BA%8B%E8%83%8C%E6%99%AF"><span class="toc-number">1.</span> <span class="toc-text">故事背景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TL-DR"><span class="toc-number">2.</span> <span class="toc-text">TL;DR</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3%E8%AF%A5-BUG"><span class="toc-number">3.</span> <span class="toc-text">如何解决该 BUG</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-Object-keys"><span class="toc-number">4.</span> <span class="toc-text">深入理解 Object.keys()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#V8-%E6%98%AF%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86%E5%AF%B9%E8%B1%A1%E5%B1%9E%E6%80%A7%E7%9A%84"><span class="toc-number">5.</span> <span class="toc-text">V8 是如何处理对象属性的</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%99%E5%9C%A8%E6%9C%80%E5%90%8E"><span class="toc-number">6.</span> <span class="toc-text">写在最后</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BB%B6%E4%BC%B8%E9%98%85%E8%AF%BB"><span class="toc-number">7.</span> <span class="toc-text">延伸阅读</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://4ark.me/post/how-object-keys-work.html"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://4ark.me/post/how-object-keys-work.html&text=一行 Object.keys() 引发的血案"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://4ark.me/post/how-object-keys-work.html&title=一行 Object.keys() 引发的血案"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://4ark.me/post/how-object-keys-work.html&is_video=false&description=一行 Object.keys() 引发的血案"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=一行 Object.keys() 引发的血案&body=Check out this article: https://4ark.me/post/how-object-keys-work.html"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://4ark.me/post/how-object-keys-work.html&title=一行 Object.keys() 引发的血案"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://4ark.me/post/how-object-keys-work.html&title=一行 Object.keys() 引发的血案"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://4ark.me/post/how-object-keys-work.html&title=一行 Object.keys() 引发的血案"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://4ark.me/post/how-object-keys-work.html&title=一行 Object.keys() 引发的血案"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://4ark.me/post/how-object-keys-work.html&name=一行 Object.keys() 引发的血案&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://4ark.me/post/how-object-keys-work.html&t=一行 Object.keys() 引发的血案"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="dark-mobile" class="icon"><i class="fa fa-sun" id="dark-btn" aria-hidden="true"></i> Switch</a>
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2024
    4Ark
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about">About</a></li><!--
     --><!--
       --><li><a href="/archives">Writing</a></li><!--
     --><!--
       --><li><a href="/weekly">Weekly</a></li><!--
     --><!--
       --><li><a href="/tags">Tags</a></li><!--
     --><!--
       --><li><a href="/search">Search</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-190615898-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-190615898-1');
    </script>

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<script type="text/javascript">
  function loadDisqus() {
    var disqus_shortname = 'https-4ark-me'

    ;(function () {
      var dsq = document.createElement('script')
      dsq.type = 'text/javascript'
      dsq.async = true
      dsq.src =
        '//' +
        disqus_shortname +
        '.disqus.com/embed.js'
      ;(
        document.getElementsByTagName('head')[0] ||
        document.getElementsByTagName('body')[0]
      ).appendChild(dsq)
    })()

    $('#load-disqus').hide()
  }
</script>

<!-- utterances Comments -->

</body>
</html>
