<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="前言本文是针对 vue-router v3.5.2 版本的一次源码解析，由于水平有限，有些地方写得比较混乱，还望多多包涵。 希望本文能够给那些想阅读 vue-router 源代码却又不知从何上手的同学们给予一些帮助。 一、 new Router 时发生了什么？对应源码在 src&#x2F;index.js，下面讲一下它做了哪些操作： 1. 声明一些变量123456789101112&#x2F;&#x2F; 当前实例this.a">
<meta property="og:type" content="article">
<meta property="og:title" content="vue-router 源码解析">
<meta property="og:url" content="https://4ark.me/post/vue-router-score-code.html">
<meta property="og:site_name" content="4Ark × Blog">
<meta property="og:description" content="前言本文是针对 vue-router v3.5.2 版本的一次源码解析，由于水平有限，有些地方写得比较混乱，还望多多包涵。 希望本文能够给那些想阅读 vue-router 源代码却又不知从何上手的同学们给予一些帮助。 一、 new Router 时发生了什么？对应源码在 src&#x2F;index.js，下面讲一下它做了哪些操作： 1. 声明一些变量123456789101112&#x2F;&#x2F; 当前实例this.a">
<meta property="og:locale">
<meta property="article:published_time" content="2021-07-16T00:00:00.000Z">
<meta property="article:modified_time" content="2024-02-06T18:11:56.000Z">
<meta property="article:author" content="4Ark">
<meta property="article:tag" content="前端">
<meta property="article:tag" content="Vue">
<meta property="article:tag" content="源码解析">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>vue-router 源码解析</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <script>localStorage.getItem("dark_mode")==="dark"&&document.write(`<link rel="stylesheet" href="${location.origin}/css/dark.css">`)</script>
    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
    <meta name="google-site-verification" content="DwDg4EuywHWNZUkTC7sG0WGv_UQekM4uRtOoaGuDJHc" />
<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="4Ark × Blog" type="application/atom+xml">
<link rel="alternate" href="/rss.xml" title="4Ark × Blog" type="application/rss+xml">
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about">About</a></li><!--
     --><!--
       --><li><a href="/archives">Writing</a></li><!--
     --><!--
       --><li><a href="/weekly">Weekly</a></li><!--
     --><!--
       --><li><a href="/tags">Tags</a></li><!--
     --><!--
       --><li><a href="/search">Search</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/post/how-object-keys-work.html"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/post/composition-api-score-code.html"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon"><i class="fa fa-moon" id="dark-btn" aria-hidden="true" onmouseover="$('#i-dark').toggle()" onmouseout="$('#i-dark').toggle()"></i></a></li>
        <li><a class="icon" target="_blank" rel="noopener" href="https://4ark.me/atom.xml" aria-label="rss"><i class="fas fa-rss"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-dark" class="info" style="display: none;">Switch mode</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://4ark.me/post/vue-router-score-code.html"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://4ark.me/post/vue-router-score-code.html&text=vue-router 源码解析"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://4ark.me/post/vue-router-score-code.html&title=vue-router 源码解析"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://4ark.me/post/vue-router-score-code.html&is_video=false&description=vue-router 源码解析"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=vue-router 源码解析&body=Check out this article: https://4ark.me/post/vue-router-score-code.html"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://4ark.me/post/vue-router-score-code.html&title=vue-router 源码解析"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://4ark.me/post/vue-router-score-code.html&title=vue-router 源码解析"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://4ark.me/post/vue-router-score-code.html&title=vue-router 源码解析"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://4ark.me/post/vue-router-score-code.html&title=vue-router 源码解析"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://4ark.me/post/vue-router-score-code.html&name=vue-router 源码解析&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://4ark.me/post/vue-router-score-code.html&t=vue-router 源码解析"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81-new-Router-%E6%97%B6%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-number">2.</span> <span class="toc-text">一、 new Router 时发生了什么？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%A3%B0%E6%98%8E%E4%B8%80%E4%BA%9B%E5%8F%98%E9%87%8F"><span class="toc-number">2.1.</span> <span class="toc-text">1. 声明一些变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%88%9B%E5%BB%BA-matcher"><span class="toc-number">2.2.</span> <span class="toc-text">2. 创建 matcher</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%A0%B9%E6%8D%AE%E8%B7%AF%E7%94%B1%E9%85%8D%E7%BD%AE%E7%94%9F%E6%88%90%E4%B8%89%E5%BC%A0%E8%A1%A8"><span class="toc-number">2.3.</span> <span class="toc-text">3. 根据路由配置生成三张表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E4%BD%BF%E7%94%A8%E4%B8%80%E4%BA%9B%E6%96%B9%E6%B3%95%E6%9D%A5%E6%93%8D%E4%BD%9C%E8%BF%99%E4%B8%89%E5%BC%A0%E8%A1%A8"><span class="toc-number">2.4.</span> <span class="toc-text">4. 使用一些方法来操作这三张表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E6%A3%80%E6%9F%A5-mode-%EF%BC%8C%E4%BD%BF%E7%94%A8%E5%AF%B9%E5%BA%94%E7%9A%84%E8%B7%AF%E7%94%B1%E6%A8%A1%E5%BC%8F"><span class="toc-number">2.5.</span> <span class="toc-text">5. 检查 mode ，使用对应的路由模式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81-use-Router-%E6%97%B6%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-number">3.</span> <span class="toc-text">二、 use Router 时发生了什么？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Vue-use-%E6%BA%90%E7%A0%81"><span class="toc-number">3.1.</span> <span class="toc-text">1. Vue.use 源码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%AE%89%E8%A3%85-Router"><span class="toc-number">3.2.</span> <span class="toc-text">2. 安装 Router</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81-%E5%88%87%E6%8D%A2%E8%B7%AF%E7%94%B1%E6%97%B6%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88"><span class="toc-number">4.</span> <span class="toc-text">三、 切换路由时发生了什么</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%87%E6%8D%A2%E8%B7%AF%E7%94%B1%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E5%BC%8F"><span class="toc-number">4.0.1.</span> <span class="toc-text">切换路由的几种方式</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E6%89%8B%E5%8A%A8%E8%A7%A6%E5%8F%91-URL-%E6%9B%B4%E6%96%B0"><span class="toc-number">4.0.1.1.</span> <span class="toc-text">1. 手动触发 URL 更新</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E9%80%9A%E8%BF%87-router-link-%E5%88%87%E6%8D%A2"><span class="toc-number">4.0.1.2.</span> <span class="toc-text">2. 通过 router-link 切换</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E9%80%9A%E8%BF%87-router-%E7%9A%84%E6%96%B9%E6%B3%95%E5%88%87%E6%8D%A2"><span class="toc-number">4.0.1.3.</span> <span class="toc-text">3. 通过 router 的方法切换</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%87%E6%8D%A2%E8%BF%87%E7%A8%8B"><span class="toc-number">4.0.2.</span> <span class="toc-text">切换过程</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E8%B0%83%E7%94%A8-transitionTo-%E6%96%B9%E6%B3%95"><span class="toc-number">4.0.2.1.</span> <span class="toc-text">1. 调用 transitionTo 方法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E8%B0%83%E7%94%A8-match-%E6%96%B9%E6%B3%95%E5%8C%B9%E9%85%8D%E8%B7%AF%E7%94%B1"><span class="toc-number">4.0.2.2.</span> <span class="toc-text">2. 调用 match 方法匹配路由</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E8%B0%83%E7%94%A8-confirmTransition-%E6%96%B9%E6%B3%95"><span class="toc-number">4.0.2.3.</span> <span class="toc-text">3. 调用 confirmTransition 方法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-%E6%9E%84%E9%80%A0%E5%AF%BC%E8%88%AA%E5%AE%88%E5%8D%AB%E9%98%9F%E5%88%97"><span class="toc-number">4.0.2.4.</span> <span class="toc-text">4. 构造导航守卫队列</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-%E6%89%A7%E8%A1%8C%E9%98%9F%E5%88%97"><span class="toc-number">4.0.2.5.</span> <span class="toc-text">5. 执行队列</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-%E6%89%A7%E8%A1%8C-confirmTransition-%E5%90%8E%E7%9A%84%E6%93%8D%E4%BD%9C"><span class="toc-number">4.0.2.6.</span> <span class="toc-text">6. 执行 confirmTransition 后的操作</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-%E6%9B%B4%E6%96%B0%E8%B7%AF%E7%94%B1%E4%BF%A1%E6%81%AF"><span class="toc-number">4.0.2.7.</span> <span class="toc-text">7. 更新路由信息</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#8-%E6%9B%B4%E6%96%B0-URL"><span class="toc-number">4.0.2.8.</span> <span class="toc-text">8. 更新 URL</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#9-%E6%B8%B2%E6%9F%93%E5%AF%B9%E5%BA%94%E7%9A%84%E8%B7%AF%E7%94%B1%E8%A7%86%E5%9B%BE"><span class="toc-number">4.0.2.9.</span> <span class="toc-text">9. 渲染对应的路由视图</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81-%E5%8A%A8%E6%80%81%E6%B7%BB%E5%8A%A0%E8%B7%AF%E7%94%B1%E5%AE%9E%E7%8E%B0"><span class="toc-number">5.</span> <span class="toc-text">四、 动态添加路由实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81-%E4%B8%89%E7%A7%8D%E8%B7%AF%E7%94%B1%E6%A8%A1%E5%BC%8F%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">6.</span> <span class="toc-text">五、 三种路由模式的实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%B8%E5%90%8C%E7%9A%84%E9%83%A8%E5%88%86"><span class="toc-number">6.0.1.</span> <span class="toc-text">相同的部分</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#hash-%E6%A8%A1%E5%BC%8F"><span class="toc-number">6.0.2.</span> <span class="toc-text">hash 模式</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">6.0.2.1.</span> <span class="toc-text">初始化</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#push-%E5%92%8C-replace"><span class="toc-number">6.0.2.2.</span> <span class="toc-text">push 和 replace</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#go"><span class="toc-number">6.0.2.3.</span> <span class="toc-text">go</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#setupListeners"><span class="toc-number">6.0.2.4.</span> <span class="toc-text">setupListeners</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#history-%E6%A8%A1%E5%BC%8F"><span class="toc-number">6.0.3.</span> <span class="toc-text">history 模式</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96-1"><span class="toc-number">6.0.3.1.</span> <span class="toc-text">初始化</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#push-%E5%92%8C-replace%E3%80%81go"><span class="toc-number">6.0.3.2.</span> <span class="toc-text">push 和 replace、go</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#setupListeners-1"><span class="toc-number">6.0.3.3.</span> <span class="toc-text">setupListeners</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#abstract-%E6%A8%A1%E5%BC%8F"><span class="toc-number">6.0.4.</span> <span class="toc-text">abstract 模式</span></a></li></ol></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        vue-router 源码解析
    </h1>



    <div class="meta">
      <span
        class="author"
        itemprop="author"
        itemscope
        itemtype="http://schema.org/Person"
      >
        <span itemprop="name"
          >4Ark</span
        >
      </span>
      
    <div class="postdate">
      
        <time datetime="2021-07-16T00:00:00.000Z" itemprop="datePublished">2021-07-16</time>
        
      
    </div>

 
      
        
 
        
    <div class="article-tag">
        <i class="fas fa-hashtag"></i>
        <a class="tag-link-link" href="/tags/Vue/" rel="tag">Vue</a>, <a class="tag-link-link" href="/tags/%E5%89%8D%E7%AB%AF/" rel="tag">前端</a>, <a class="tag-link-link" href="/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" rel="tag">源码解析</a>
    </div>


      
    </div>
  </header>
  

  <div class="content" itemprop="articleBody"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本文是针对 vue-router <a target="_blank" rel="noopener" href="https://github.com/vuejs/vue-router/releases/tag/v3.5.2">v3.5.2</a> 版本的一次源码解析，由于水平有限，有些地方写得比较混乱，还望多多包涵。</p>
<p>希望本文能够给那些想阅读 vue-router 源代码却又不知从何上手的同学们给予一些帮助。</p>
<h2 id="一、-new-Router-时发生了什么？"><a href="#一、-new-Router-时发生了什么？" class="headerlink" title="一、 new Router 时发生了什么？"></a>一、 new Router 时发生了什么？</h2><p>对应源码在 <a target="_blank" rel="noopener" href="https://github1s.com/vuejs/vue-router/blob/HEAD/src/index.js">src/index.js</a>，下面讲一下它做了哪些操作：</p>
<h3 id="1-声明一些变量"><a href="#1-声明一些变量" class="headerlink" title="1. 声明一些变量"></a>1. 声明一些变量</h3><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 当前实例</span></span><br><span class="line"><span class="built_in">this</span>.app = <span class="literal">null</span></span><br><span class="line"><span class="comment">// 存在多实例的话则保存</span></span><br><span class="line"><span class="built_in">this</span>.apps = []</span><br><span class="line"><span class="comment">// 传入的配置</span></span><br><span class="line"><span class="built_in">this</span>.options = options</span><br><span class="line"><span class="comment">// 存放已注册的一些导航守卫</span></span><br><span class="line"><span class="built_in">this</span>.beforeHooks = []</span><br><span class="line"><span class="built_in">this</span>.resolveHooks = []</span><br><span class="line"><span class="built_in">this</span>.afterHooks = []</span><br><span class="line"><span class="comment">// 创建 matcher</span></span><br><span class="line"><span class="built_in">this</span>.matcher = createMatcher(options.routes || [], <span class="built_in">this</span>)</span><br></pre></td></tr></table></figure>

<h3 id="2-创建-matcher"><a href="#2-创建-matcher" class="headerlink" title="2. 创建 matcher"></a>2. 创建 <code>matcher</code></h3><p><code>createMatcher</code> 的源码位置在 <a target="_blank" rel="noopener" href="https://github1s.com/vuejs/vue-router/blob/HEAD/src/create-matcher.js">src/create-matcher.js</a>，这个方法的整体是这样的：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createMatcher</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  routes: <span class="built_in">Array</span>&lt;RouteConfig&gt;,</span></span></span><br><span class="line"><span class="params"><span class="function">  router: VueRouter</span></span></span><br><span class="line"><span class="params"><span class="function"></span>): <span class="title">Matcher</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; pathList, pathMap, nameMap &#125; = createRouteMap(routes)</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">addRoutes</span>(<span class="params">routes</span>) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">addRoute</span>(<span class="params">parentOrRoute, route</span>) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getRoutes</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">match</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    raw: RawLocation,</span></span></span><br><span class="line"><span class="params"><span class="function">    currentRoute?: Route,</span></span></span><br><span class="line"><span class="params"><span class="function">    redirectedFrom?: Location</span></span></span><br><span class="line"><span class="params"><span class="function">  </span>): <span class="title">Route</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">redirect</span>(<span class="params">record: RouteRecord, location: Location</span>): <span class="title">Route</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">alias</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    record: RouteRecord,</span></span></span><br><span class="line"><span class="params"><span class="function">    location: Location,</span></span></span><br><span class="line"><span class="params"><span class="function">    matchAs: string</span></span></span><br><span class="line"><span class="params"><span class="function">  </span>): <span class="title">Route</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">_createRoute</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    record: ?RouteRecord,</span></span></span><br><span class="line"><span class="params"><span class="function">    location: Location,</span></span></span><br><span class="line"><span class="params"><span class="function">    redirectedFrom?: Location</span></span></span><br><span class="line"><span class="params"><span class="function">  </span>): <span class="title">Route</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    match,</span><br><span class="line">    addRoute,</span><br><span class="line">    getRoutes,</span><br><span class="line">    addRoutes</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里主要是两点：</p>
<ol>
<li>根据传入的路由配置生成三张表：<code>pathList</code>、 <code>pathMap</code>、 <code>nameMap</code>，这样后面就可以更高效地访问路由表。</li>
<li>返回一些方法，让它可以获取，操作这三张表。</li>
</ol>
<h3 id="3-根据路由配置生成三张表"><a href="#3-根据路由配置生成三张表" class="headerlink" title="3. 根据路由配置生成三张表"></a>3. 根据路由配置生成三张表</h3><p><code>createRouteMap</code> 的源码位置在 <a target="_blank" rel="noopener" href="https://github1s.com/vuejs/vue-router/blob/HEAD/src/create-route-map.js">src/create-route-map.js</a>，可以点开来对照看。</p>
<p>我们先不管其它逻辑，只关注它在第一次时是如何生成这三张表的，其核心逻辑是如下：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">routes.forEach(<span class="function">(<span class="params">route</span>) =&gt;</span> &#123;</span><br><span class="line">  addRouteRecord(pathList, pathMap, nameMap, route, parentRoute)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>这里给循环调用了 <code>addRouteRecord</code> 方法，它就在同一个文件中，总结一下它做了如下操作：</p>
<ol>
<li> 首先检查是否有配置 <code>pathToRegexpOptions</code> 参数，这个属性值是路由高级匹配模式中（<code>path-to-regexp</code>）的参数。</li>
<li> 调用 <code>normalizePath</code> 将 <code>path</code> 标准化，比较重要的是这里会将子路由的 <code>path</code> 父路由的 <code>path</code> 拼接在一起。</li>
<li> 处理 <code>caseSensitive</code> 参数，它也是 <code>path-to-regexp</code> 中的参数。</li>
<li> 声明一个 <code>RouteRecord</code> ，主要代码：</li>
</ol>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> record: RouteRecord = &#123;</span><br><span class="line">  <span class="attr">path</span>: normalizedPath,</span><br><span class="line">  <span class="comment">// 用于匹配该路由的正则</span></span><br><span class="line">  <span class="attr">regex</span>: compileRouteRegex(normalizedPath, pathToRegexpOptions),</span><br><span class="line">  <span class="comment">// 该路由对应的组件，注意这里与 &lt;router-view&gt; 的 name 有关联</span></span><br><span class="line">  <span class="attr">components</span>: route.components || &#123; <span class="attr">default</span>: route.component &#125;,</span><br><span class="line">  <span class="comment">// 路由别名</span></span><br><span class="line">  <span class="attr">alias</span>: route.alias</span><br><span class="line">    ? <span class="keyword">typeof</span> route.alias === <span class="string">&#x27;string&#x27;</span></span><br><span class="line">      ? [route.alias]</span><br><span class="line">      : route.alias</span><br><span class="line">    : []</span><br><span class="line">  <span class="comment">// other property</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li> 如果该路由存在子路由，则递归调用 <code>addRouteRecord</code> 添加路由记录。</li>
<li> 将这条 <code>RouteRecord</code> 存入 <code>pathList</code> 。</li>
<li> 将这条记录以 <code>path</code> 作为 <code>key</code> 存入 <code>pathMap</code> 。</li>
<li> 如果存在 <code>alias</code> ，则用 <code>alias</code> 作为 <code>path</code> 再添加一条路由记录。</li>
<li> 如果存在 <code>name</code> ，则以 <code>name</code> 作为 <code>key</code> 存入 <code>nameMap</code>。</li>
</ol>
<p>到这里，已经搞懂如何生成这三张表了。</p>
<h3 id="4-使用一些方法来操作这三张表"><a href="#4-使用一些方法来操作这三张表" class="headerlink" title="4. 使用一些方法来操作这三张表"></a>4. 使用一些方法来操作这三张表</h3><p>接着我们回到 <code>createMatcher</code> 方法内部，可以看到它返回的一些方法：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createMatcher</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  routes: <span class="built_in">Array</span>&lt;RouteConfig&gt;,</span></span></span><br><span class="line"><span class="params"><span class="function">  router: VueRouter</span></span></span><br><span class="line"><span class="params"><span class="function"></span>): <span class="title">Matcher</span> </span>&#123;</span><br><span class="line">  <span class="comment">// other code</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    match,</span><br><span class="line">    addRoute,</span><br><span class="line">    getRoutes,</span><br><span class="line">    addRoutes</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其内部无非就是根据这三张表来做一些匹配或者改动而已，后面也基本会提到，这里就先略过。<br>​</p>
<p>到这里 <code>createMatcher</code> 的操作就基本讲完了，下面我们回到 <code>new Router</code> 本身。</p>
<h3 id="5-检查-mode-，使用对应的路由模式"><a href="#5-检查-mode-，使用对应的路由模式" class="headerlink" title="5. 检查 mode ，使用对应的路由模式"></a>5. 检查 <code>mode</code> ，使用对应的路由模式</h3><p>根据传入的路由配置创建一系列的数据表后，下面就要根据不同的 <code>mode</code> 来做不同的操作，核心代码如下：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 众所周知，hash 是默认值</span></span><br><span class="line"><span class="keyword">let</span> mode = options.mode || <span class="string">&#x27;hash&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果使用了 history 但不支持 pushState 的情况也需要回退到 hash</span></span><br><span class="line"><span class="built_in">this</span>.fallback =</span><br><span class="line">  mode === <span class="string">&#x27;history&#x27;</span> &amp;&amp; !supportsPushState &amp;&amp; options.fallback !== <span class="literal">false</span></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">this</span>.fallback) &#123;</span><br><span class="line">  mode = <span class="string">&#x27;hash&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 非浏览器环境(比如SSR)，则使用 abstract</span></span><br><span class="line"><span class="keyword">if</span> (!inBrowser) &#123;</span><br><span class="line">  mode = <span class="string">&#x27;abstract&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">this</span>.mode = mode</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据不同的 mode 构建不同的 history</span></span><br><span class="line"><span class="keyword">switch</span> (mode) &#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="string">&#x27;history&#x27;</span>:</span><br><span class="line">    <span class="built_in">this</span>.history = <span class="keyword">new</span> HTML5History(<span class="built_in">this</span>, options.base)</span><br><span class="line">    <span class="keyword">break</span></span><br><span class="line">  <span class="keyword">case</span> <span class="string">&#x27;hash&#x27;</span>:</span><br><span class="line">    <span class="built_in">this</span>.history = <span class="keyword">new</span> HashHistory(<span class="built_in">this</span>, options.base, <span class="built_in">this</span>.fallback)</span><br><span class="line">    <span class="keyword">break</span></span><br><span class="line">  <span class="keyword">case</span> <span class="string">&#x27;abstract&#x27;</span>:</span><br><span class="line">    <span class="built_in">this</span>.history = <span class="keyword">new</span> AbstractHistory(<span class="built_in">this</span>, options.base)</span><br><span class="line">    <span class="keyword">break</span></span><br><span class="line">  <span class="attr">default</span>:</span><br><span class="line">    <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">      assert(<span class="literal">false</span>, <span class="string">`invalid mode: <span class="subst">$&#123;mode&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关于三种 mode 有何不同下面会讲。</p>
<p>到这里， <code>new Router()</code> 的整个过程就基本讲完了。</p>
<h2 id="二、-use-Router-时发生了什么？"><a href="#二、-use-Router-时发生了什么？" class="headerlink" title="二、 use Router 时发生了什么？"></a>二、 use Router 时发生了什么？</h2><p>我们知道仅仅通过 <code>new Router()</code> 来构造一个 vue-router 实例后，还需要通过 <code>Vue.use(router)</code> 才能真正在项目中使用它，下面就来讲讲这过程到底发生了什么？</p>
<h3 id="1-Vue-use-源码"><a href="#1-Vue-use-源码" class="headerlink" title="1. Vue.use 源码"></a>1. Vue.use 源码</h3><p>在这之前，我们先来看看 Vue.use 做了哪些操作，它的源码在 <a target="_blank" rel="noopener" href="https://github1s.com/vuejs/vue/blob/HEAD/src/core/global-api/use.js">src/core/global-api/use.js</a>：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; toArray &#125; <span class="keyword">from</span> <span class="string">&#x27;../util/index&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">initUse</span>(<span class="params">Vue: GlobalAPI</span>) </span>&#123;</span><br><span class="line">  Vue.use = <span class="function"><span class="keyword">function</span> (<span class="params">plugin: <span class="built_in">Function</span> | <span class="built_in">Object</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> installedPlugins =</span><br><span class="line">      <span class="built_in">this</span>._installedPlugins || (<span class="built_in">this</span>._installedPlugins = [])</span><br><span class="line">    <span class="keyword">if</span> (installedPlugins.indexOf(plugin) &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">this</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> args = toArray(<span class="built_in">arguments</span>, <span class="number">1</span>)</span><br><span class="line">    args.unshift(<span class="built_in">this</span>)</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> plugin.install === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      plugin.install.apply(plugin, args)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> plugin === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      plugin.apply(<span class="literal">null</span>, args)</span><br><span class="line">    &#125;</span><br><span class="line">    installedPlugins.push(plugin)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代码不长，就是接受一个 <code>plugin</code> ，这个 <code>plugin</code> 要么是一个函数，要么就是一个有 <code>install</code> 方法的对象，然后 Vue 会调用这方法，并且将当前 Vue 作为参数传入，以便插件对 Vue 来进行扩展，最后将 <code>plugin</code> 传入 <code>installedPlugins</code> 中，防止重复调用。</p>
<h3 id="2-安装-Router"><a href="#2-安装-Router" class="headerlink" title="2. 安装 Router"></a>2. 安装 Router</h3><p>然后我们看看在 Vue 安装 VueRouter 时，VueRouter 会做哪些操作，它的源码在 <a target="_blank" rel="noopener" href="https://github1s.com/vuejs/vue-router/blob/HEAD/src/install.js">src/install.js</a>：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> View <span class="keyword">from</span> <span class="string">&#x27;./components/view&#x27;</span></span><br><span class="line"><span class="keyword">import</span> Link <span class="keyword">from</span> <span class="string">&#x27;./components/link&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">let</span> _Vue</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">install</span>(<span class="params">Vue</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 防止重复执行</span></span><br><span class="line">  <span class="keyword">if</span> (install.installed &amp;&amp; _Vue === Vue) <span class="keyword">return</span></span><br><span class="line">  install.installed = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 把 Vue 存起来并 export 供其它文件使用</span></span><br><span class="line">  _Vue = Vue</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> isDef = <span class="function">(<span class="params">v</span>) =&gt;</span> v !== <span class="literal">undefined</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> registerInstance = <span class="function">(<span class="params">vm, callVal</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> i = vm.$options._parentVnode</span><br><span class="line">    <span class="comment">// router-view 才有 registerRouteInstance 属性</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      isDef(i) &amp;&amp;</span><br><span class="line">      isDef((i = i.data)) &amp;&amp;</span><br><span class="line">      isDef((i = i.registerRouteInstance))</span><br><span class="line">    ) &#123;</span><br><span class="line">      i(vm, callVal)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 注册一个全局 mixin</span></span><br><span class="line">  Vue.mixin(&#123;</span><br><span class="line">    <span class="function"><span class="title">beforeCreate</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="comment">// 初始化</span></span><br><span class="line">      <span class="keyword">if</span> (isDef(<span class="built_in">this</span>.$options.router)) &#123;</span><br><span class="line">        <span class="built_in">this</span>._routerRoot = <span class="built_in">this</span></span><br><span class="line">        <span class="built_in">this</span>._router = <span class="built_in">this</span>.$options.router</span><br><span class="line">        <span class="comment">// 调用 router.init()，后面会讲</span></span><br><span class="line">        <span class="built_in">this</span>._router.init(<span class="built_in">this</span>)</span><br><span class="line">        <span class="comment">// 使 _router 变成响应式</span></span><br><span class="line">        Vue.util.defineReactive(<span class="built_in">this</span>, <span class="string">&#x27;_route&#x27;</span>, <span class="built_in">this</span>._router.history.current)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 如果已经初始化，继承父组件的 _routerRoot</span></span><br><span class="line">        <span class="built_in">this</span>._routerRoot = (<span class="built_in">this</span>.$parent &amp;&amp; <span class="built_in">this</span>.$parent._routerRoot) || <span class="built_in">this</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 注册实例，实际上是挂载 &lt;router-view&gt;</span></span><br><span class="line">      registerInstance(<span class="built_in">this</span>, <span class="built_in">this</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">destroyed</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="comment">// 离开时卸载</span></span><br><span class="line">      registerInstance(<span class="built_in">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 把 $router 和 $route 挂载到 Vue 原型上，这样就能在任意 Vue 实例中访问</span></span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(Vue.prototype, <span class="string">&#x27;$router&#x27;</span>, &#123;</span><br><span class="line">    <span class="function"><span class="title">get</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">this</span>._routerRoot._router</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(Vue.prototype, <span class="string">&#x27;$route&#x27;</span>, &#123;</span><br><span class="line">    <span class="function"><span class="title">get</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">this</span>._routerRoot._route</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 全局组件</span></span><br><span class="line">  Vue.component(<span class="string">&#x27;RouterView&#x27;</span>, View)</span><br><span class="line">  Vue.component(<span class="string">&#x27;RouterLink&#x27;</span>, Link)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 利用 Vue 合并策略新增几个相关的生命周期</span></span><br><span class="line">  <span class="keyword">const</span> strats = Vue.config.optionMergeStrategies</span><br><span class="line">  <span class="comment">// use the same hook merging strategy for route hooks</span></span><br><span class="line">  strats.beforeRouteEnter =</span><br><span class="line">    strats.beforeRouteLeave =</span><br><span class="line">    strats.beforeRouteUpdate =</span><br><span class="line">      strats.created</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们看到它调用了 <code>router.init()</code> 这个方法，它的源码在 <a target="_blank" rel="noopener" href="https://github1s.com/vuejs/vue-router/blob/HEAD/src/index.js">src/index.js</a>：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">init (app: any <span class="comment">/* Vue component instance */</span>) &#123;</span><br><span class="line">	    <span class="comment">// 开发环境下检查是否已安装</span></span><br><span class="line">    process.env.NODE_ENV !== <span class="string">&#x27;production&#x27;</span> &amp;&amp;</span><br><span class="line">      assert(</span><br><span class="line">        install.installed,</span><br><span class="line">        <span class="string">`not installed. Make sure to call \`Vue.use(VueRouter)\` `</span> +</span><br><span class="line">          <span class="string">`before creating root instance.`</span></span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 保存当前 app 实例</span></span><br><span class="line">    <span class="built_in">this</span>.apps.push(app)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当前 app 销毁时需要在 apps 中移除，由 issue #2639 提出</span></span><br><span class="line">    app.$once(<span class="string">&#x27;hook:destroyed&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// clean out app from this.apps array once destroyed</span></span><br><span class="line">      <span class="keyword">const</span> index = <span class="built_in">this</span>.apps.indexOf(app)</span><br><span class="line">      <span class="keyword">if</span> (index &gt; -<span class="number">1</span>) <span class="built_in">this</span>.apps.splice(index, <span class="number">1</span>)</span><br><span class="line">      <span class="comment">// ensure we still have a main app or null if no apps</span></span><br><span class="line">      <span class="comment">// we do not release the router so it can be reused</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.app === app) <span class="built_in">this</span>.app = <span class="built_in">this</span>.apps[<span class="number">0</span>] || <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">this</span>.app) <span class="built_in">this</span>.history.teardown()</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 防止重复调用</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.app) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.app = app</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当前的 history，由之前 new Router 时根据不同 mode 来创建</span></span><br><span class="line">    <span class="keyword">const</span> history = <span class="built_in">this</span>.history</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在浏览器环境下初始化时根据当前路由位置做路由跳转</span></span><br><span class="line">    <span class="keyword">if</span> (history <span class="keyword">instanceof</span> HTML5History || history <span class="keyword">instanceof</span> HashHistory) &#123;</span><br><span class="line">      <span class="keyword">const</span> handleInitialScroll = <span class="function"><span class="params">routeOrError</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">from</span> = history.current</span><br><span class="line">        <span class="keyword">const</span> expectScroll = <span class="built_in">this</span>.options.scrollBehavior</span><br><span class="line">        <span class="keyword">const</span> supportsScroll = supportsPushState &amp;&amp; expectScroll</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (supportsScroll &amp;&amp; <span class="string">&#x27;fullPath&#x27;</span> <span class="keyword">in</span> routeOrError) &#123;</span><br><span class="line">          handleScroll(<span class="built_in">this</span>, routeOrError, <span class="keyword">from</span>, <span class="literal">false</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">const</span> setupListeners = <span class="function"><span class="params">routeOrError</span> =&gt;</span> &#123;</span><br><span class="line">        history.setupListeners()</span><br><span class="line">        handleInitialScroll(routeOrError)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 切换路由的方法，这个方法后面会讲</span></span><br><span class="line">      history.transitionTo(</span><br><span class="line">        history.getCurrentLocation(),</span><br><span class="line">        setupListeners,</span><br><span class="line">        setupListeners</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 监听路由变化，在所有 app 实例中设置当前路由</span></span><br><span class="line">    <span class="comment">// 所以我们一直可以通过 this.$route 拿到当前路由</span></span><br><span class="line">    history.listen(<span class="function"><span class="params">route</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.apps.forEach(<span class="function"><span class="params">app</span> =&gt;</span> &#123;</span><br><span class="line">        app._route = route</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>相信现在对安装 VueRouter 时的大致流程已经很清楚了，我们还看到了它会调用一些很重要的方法，这些方法会从后面的问题中继续深入探讨。</p>
<h2 id="三、-切换路由时发生了什么"><a href="#三、-切换路由时发生了什么" class="headerlink" title="三、 切换路由时发生了什么"></a>三、 切换路由时发生了什么</h2><p>下面我们看看 vue-router 在切换路由时做了哪些操作，首先回想一下我们平时使用 vue-router 时有哪些操作可以切换路由？</p>
<h4 id="切换路由的几种方式"><a href="#切换路由的几种方式" class="headerlink" title="切换路由的几种方式"></a>切换路由的几种方式</h4><p>我们可以通过以下方式切换不同的路由：</p>
<ol>
<li>手动触发 URL 更新</li>
<li>点击 <code>router-link</code></li>
<li>通过 <code>this.$router</code> 的 <code>push</code> 、<code>replace</code> 等方法</li>
</ol>
<h5 id="1-手动触发-URL-更新"><a href="#1-手动触发-URL-更新" class="headerlink" title="1. 手动触发 URL 更新"></a>1. 手动触发 URL 更新</h5><p>只要我们更新了 <code>URL</code> ，vue-router 都会相应执行切换路由的逻辑，能更新 <code>URL</code> 操作有以下：</p>
<ul>
<li>如支持 <code>history</code> api<ul>
<li>history.pushState</li>
<li>history.replaceState</li>
<li>history.back</li>
<li>history.go</li>
</ul>
</li>
<li><code>location.href = &#39;xxx&#39;</code></li>
<li><code>location.hash = &#39;xxx&#39;</code></li>
</ul>
<p>vue-router 是如何监听这些操作的呢？其实只要监听 <code>popstate</code> 或者 <code>hashchange</code> 就可以了，不过这部分留到后面讲 <code>history</code> 实现时再仔细讲，这里先略过。</p>
<h5 id="2-通过-router-link-切换"><a href="#2-通过-router-link-切换" class="headerlink" title="2. 通过 router-link 切换"></a>2. 通过 <code>router-link</code> 切换</h5><p>还有就是通过 <code>router-link</code> 组件的方式来切换，这个组件相信大家已经很熟悉了，它的源码在 <a target="_blank" rel="noopener" href="https://github1s.com/vuejs/vue-router/blob/HEAD/src/components/link.js">src/components/link.js</a>，我们直接看最关键的部分：<br>​</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 事件处理，不一定是 click，取决于用户传入的 event</span></span><br><span class="line"><span class="keyword">const</span> handler = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 判断用户触发该事件时的行为，具体看下面的 guardEvent 方法</span></span><br><span class="line">  <span class="keyword">if</span> (guardEvent(e)) &#123;</span><br><span class="line">    <span class="comment">// 使用不同的方式来切换路由</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.replace) &#123;</span><br><span class="line">      router.replace(location, noop)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      router.push(location, noop)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册事件</span></span><br><span class="line"><span class="keyword">const</span> on = &#123; <span class="attr">click</span>: guardEvent &#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(<span class="built_in">this</span>.event)) &#123;</span><br><span class="line">  <span class="built_in">this</span>.event.forEach(<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">    on[e] = handler</span><br><span class="line">  &#125;)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  on[<span class="built_in">this</span>.event] = handler</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">guardEvent</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 不处理有媒体键的情况</span></span><br><span class="line">  <span class="comment">// 比如 a 标签可以通过按住 shift 点击链接在新窗口打开，这时候原本的窗口不做任何处理</span></span><br><span class="line">  <span class="keyword">if</span> (e.metaKey || e.altKey || e.ctrlKey || e.shiftKey) <span class="keyword">return</span></span><br><span class="line">  <span class="comment">// 调用了 preventDefault 也不处理</span></span><br><span class="line">  <span class="keyword">if</span> (e.defaultPrevented) <span class="keyword">return</span></span><br><span class="line">  <span class="comment">// 如果是 button，并且不是使用左键单击也不处理</span></span><br><span class="line">  <span class="keyword">if</span> (e.button !== <span class="literal">undefined</span> &amp;&amp; e.button !== <span class="number">0</span>) <span class="keyword">return</span></span><br><span class="line">  <span class="comment">// 如果给 a 标签设置了 _blank 也不处理</span></span><br><span class="line">  <span class="keyword">if</span> (e.currentTarget &amp;&amp; e.currentTarget.getAttribute) &#123;</span><br><span class="line">    <span class="keyword">const</span> target = e.currentTarget.getAttribute(<span class="string">&#x27;target&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> (<span class="regexp">/\b_blank\b/i</span>.test(target)) <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 取消默认行为，这里要判断是因为在诸如 weex 环境中没有该方法</span></span><br><span class="line">  <span class="keyword">if</span> (e.preventDefault) &#123;</span><br><span class="line">    e.preventDefault()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>很明显， <code>router-link</code> 本质上也是通过 router 的方法来切换路由，那下面就来看看 router 的方法。</p>
<h5 id="3-通过-router-的方法切换"><a href="#3-通过-router-的方法切换" class="headerlink" title="3. 通过 router 的方法切换"></a>3. 通过 router 的方法切换</h5><p>通过 router 方法来切换路由主要是三个：</p>
<ol>
<li><code>push</code></li>
<li><code>replace</code></li>
<li><code>go</code></li>
</ol>
<p>当然还有其它的，比如 <code>resolve</code> ，但这个方法并不是切换路由，但只是把对应路由信息返回过来，这里就不谈了。</p>
<p>其实不同的 <code>mode</code> 它们的实现是不一样的，这里我们就拿最常用的 <code>hash</code> 模式来讲，其它 <code>mode</code> 的方法实现会在后面将不同的 <code>mode</code> 的差异时讨论。</p>
<p>下面是这些方法在 <code>hash</code> 模式下的实现：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">push</span>(<span class="params">location: RawLocation, onComplete ? : <span class="built_in">Function</span>, onAbort ? : <span class="built_in">Function</span></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;</span><br><span class="line">        <span class="attr">current</span>: fromRoute</span><br><span class="line">    &#125; = <span class="built_in">this</span></span><br><span class="line">    <span class="built_in">this</span>.transitionTo(</span><br><span class="line">        location,</span><br><span class="line">        <span class="function">(<span class="params">route</span>) =&gt;</span> &#123;</span><br><span class="line">            pushHash(route.fullPath)</span><br><span class="line">            handleScroll(<span class="built_in">this</span>.router, route, fromRoute, <span class="literal">false</span>)</span><br><span class="line">            onComplete &amp;&amp; onComplete(route)</span><br><span class="line">        &#125;,</span><br><span class="line">        onAbort</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">replace</span>(<span class="params">location: RawLocation, onComplete?: <span class="built_in">Function</span>, onAbort?: <span class="built_in">Function</span></span>)</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="attr">current</span>: fromRoute &#125; = <span class="built_in">this</span></span><br><span class="line">  <span class="built_in">this</span>.transitionTo(</span><br><span class="line">    location,</span><br><span class="line">    <span class="function">(<span class="params">route</span>) =&gt;</span> &#123;</span><br><span class="line">      replaceHash(route.fullPath)</span><br><span class="line">      handleScroll(<span class="built_in">this</span>.router, route, fromRoute, <span class="literal">false</span>)</span><br><span class="line">      onComplete &amp;&amp; onComplete(route)</span><br><span class="line">    &#125;,</span><br><span class="line">    onAbort</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">go</span>(<span class="params">n: number</span>)</span> &#123;</span><br><span class="line">  <span class="built_in">window</span>.history.go(n)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，除了 <code>go</code> 之外（它是通过事件监听器），都是在调用 <code>transitionTo</code> 这个方法，下面我们就看看这个方法的内部。</p>
<h4 id="切换过程"><a href="#切换过程" class="headerlink" title="切换过程"></a>切换过程</h4><h5 id="1-调用-transitionTo-方法"><a href="#1-调用-transitionTo-方法" class="headerlink" title="1. 调用 transitionTo 方法"></a>1. 调用 transitionTo 方法</h5><p>前面我们得知切换路由实际上都在调用 <code>transitionTo</code> ，它是一个 <code>History</code> 基类的方法，三种 <code>mode</code> 都是共用的同一个，下面是它的实现：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">transitionTo</span>(<span class="params">location: RawLocation, onComplete ? : <span class="built_in">Function</span>, onAbort ? : <span class="built_in">Function</span></span>)</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> route</span><br><span class="line">  <span class="comment">// 这里要 try 一下是因为 match 方法内部会在有 redirect 属性时调用它</span></span><br><span class="line">  <span class="comment">// 但用户提供的 redirect 方法可能会发生报错，所以这里需要捕获到错误回调方法</span></span><br><span class="line">  <span class="comment">// 具体看 issues #3201</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 这是根据当前位置匹配路由，下面会讲</span></span><br><span class="line">    route = <span class="built_in">this</span>.router.match(location, <span class="built_in">this</span>.current)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="built_in">this</span>.errorCbs.forEach(<span class="function">(<span class="params">cb</span>) =&gt;</span> &#123;</span><br><span class="line">      cb(e)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// 依然要抛出异常，让用户得知</span></span><br><span class="line">    <span class="keyword">throw</span> e</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 记录之前的路由，后面会用到</span></span><br><span class="line">  <span class="keyword">const</span> prev = <span class="built_in">this</span>.current</span><br><span class="line">  <span class="comment">// 这个才是真正切换路由的方法，下面会讲</span></span><br><span class="line">  <span class="built_in">this</span>.confirmTransition(</span><br><span class="line">    <span class="comment">// 传入准备切换的路由</span></span><br><span class="line">    route,</span><br><span class="line">    <span class="comment">// 切换之后的回调</span></span><br><span class="line">    <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 更新到当前路由信息 (current)，下面会讲</span></span><br><span class="line">      <span class="built_in">this</span>.updateRoute(route)</span><br><span class="line">      <span class="comment">// 执行用户传入的 onComplete回调</span></span><br><span class="line">      onComplete &amp;&amp; onComplete(route)</span><br><span class="line">      <span class="comment">// 更新浏览器地址栏上的 URL</span></span><br><span class="line">      <span class="built_in">this</span>.ensureURL()</span><br><span class="line">      <span class="comment">// 执行注册的 afterHooks</span></span><br><span class="line">      <span class="built_in">this</span>.router.afterHooks.forEach(<span class="function">(<span class="params">hook</span>) =&gt;</span> &#123;</span><br><span class="line">        hook &amp;&amp; hook(route, prev)</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">this</span>.ready) &#123;</span><br><span class="line">        <span class="built_in">this</span>.ready = <span class="literal">true</span></span><br><span class="line">        <span class="comment">// 执行用户传入的 onReady 回调</span></span><br><span class="line">        <span class="built_in">this</span>.readyCbs.forEach(<span class="function">(<span class="params">cb</span>) =&gt;</span> &#123;</span><br><span class="line">          cb(route)</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 发生错误的回调</span></span><br><span class="line">    <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 执行用户传入的 onAbort 回调</span></span><br><span class="line">      <span class="keyword">if</span> (onAbort) &#123;</span><br><span class="line">        onAbort(err)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 执行用户传入的 onError 回调</span></span><br><span class="line">      <span class="keyword">if</span> (err &amp;&amp; !<span class="built_in">this</span>.ready) &#123;</span><br><span class="line">        <span class="comment">// Initial redirection should not mark the history as ready yet</span></span><br><span class="line">        <span class="comment">// because it&#x27;s triggered by the redirection instead</span></span><br><span class="line">        <span class="comment">// https://github.com/vuejs/vue-router/issues/3225</span></span><br><span class="line">        <span class="comment">// https://github.com/vuejs/vue-router/issues/3331</span></span><br><span class="line">        <span class="keyword">if</span> (!isNavigationFailure(err, NavigationFailureType.redirected) || prev !== START) &#123;</span><br><span class="line">          <span class="built_in">this</span>.ready = <span class="literal">true</span></span><br><span class="line">          <span class="built_in">this</span>.readyErrorCbs.forEach(<span class="function">(<span class="params">cb</span>) =&gt;</span> &#123;</span><br><span class="line">            cb(err)</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在上面这段方法中我们得知，要切换路由首先调用 <code>match</code> 方法来匹配到待切换的路由，下面我们看看实现。</p>
<h5 id="2-调用-match-方法匹配路由"><a href="#2-调用-match-方法匹配路由" class="headerlink" title="2. 调用 match 方法匹配路由"></a>2. 调用 <code>match</code> 方法匹配路由</h5><p>在 <code>transitionTo</code> 中调用的是 <code>router</code> 的 <code>match</code> 方法：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">match (raw: RawLocation, current?: Route, redirectedFrom?: Location): Route &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">this</span>.matcher.match(raw, current, redirectedFrom)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而它实际上是调用了 <code>matcher</code> 的 <code>match</code> 方法，这个方法我们之前在 <a href="#_2-%E5%88%9B%E5%BB%BA-matcher">创建 match</a> 这一小节有提到过，下面是它的实现：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">match</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="comment">// 待切换的路由，取值为 字符串 或者 Location 对象</span></span></span></span><br><span class="line"><span class="params"><span class="function">  raw: RawLocation,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="comment">// 当前的路由</span></span></span></span><br><span class="line"><span class="params"><span class="function">  currentRoute?: Route,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="comment">// 使用重定向方式切换时才会传入</span></span></span></span><br><span class="line"><span class="params"><span class="function">  redirectedFrom?: Location</span></span></span><br><span class="line"><span class="params"><span class="function"></span>): <span class="title">Route</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 将待切换的路由转换成一个标准的 Location 对象</span></span><br><span class="line">  <span class="comment">// 例如：path 补全、合并 params 等</span></span><br><span class="line">  <span class="keyword">const</span> location = normalizeLocation(raw, currentRoute, <span class="literal">false</span>, router)</span><br><span class="line">  <span class="comment">// 待切换路由的 name</span></span><br><span class="line">  <span class="keyword">const</span> &#123; name &#125; = location</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (name) &#123;</span><br><span class="line">    <span class="comment">// 有 name 属性的时候直接通过 nameMap 获取，根本无需遍历，非常高效</span></span><br><span class="line">    <span class="keyword">const</span> record = nameMap[name]</span><br><span class="line">    <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">      warn(record, <span class="string">`Route with name &#x27;<span class="subst">$&#123;name&#125;</span>&#x27; does not exist`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 该路由不存在，创建一个空的路由记录</span></span><br><span class="line">    <span class="keyword">if</span> (!record) <span class="keyword">return</span> _createRoute(<span class="literal">null</span>, location)</span><br><span class="line">    <span class="comment">// 获取可以从父路由中继承的 param 参数</span></span><br><span class="line">    <span class="keyword">const</span> paramNames = record.regex.keys</span><br><span class="line">      .filter(<span class="function">(<span class="params">key</span>) =&gt;</span> !key.optional)</span><br><span class="line">      .map(<span class="function">(<span class="params">key</span>) =&gt;</span> key.name)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  params 需要为对象</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> location.params !== <span class="string">&#x27;object&#x27;</span>) &#123;</span><br><span class="line">      location.params = &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 继承父路由的 param 参数</span></span><br><span class="line">    <span class="keyword">if</span> (currentRoute &amp;&amp; <span class="keyword">typeof</span> currentRoute.params === <span class="string">&#x27;object&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> currentRoute.params) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!(key <span class="keyword">in</span> location.params) &amp;&amp; paramNames.indexOf(key) &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">          location.params[key] = currentRoute.params[key]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 将 path 和 param 合并为 URL</span></span><br><span class="line">    location.path = fillParams(</span><br><span class="line">      record.path,</span><br><span class="line">      location.params,</span><br><span class="line">      <span class="string">`named route &quot;<span class="subst">$&#123;name&#125;</span>&quot;`</span></span><br><span class="line">    )</span><br><span class="line">    <span class="comment">// 创建路由记录</span></span><br><span class="line">    <span class="keyword">return</span> _createRoute(record, location, redirectedFrom)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (location.path) &#123;</span><br><span class="line">    <span class="comment">// 如果是通过 path 跳转，则需要通过遍历 pathList 匹配对应的路由</span></span><br><span class="line">    location.params = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; pathList.length; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> path = pathList[i]</span><br><span class="line">      <span class="keyword">const</span> record = pathMap[path]</span><br><span class="line">      <span class="comment">// 检查路径与当前遍历到的路由是否匹配，该方法下面会讲</span></span><br><span class="line">      <span class="keyword">if</span> (matchRoute(record.regex, location.path, location.params)) &#123;</span><br><span class="line">        <span class="keyword">return</span> _createRoute(record, location, redirectedFrom)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 找不到匹配的则创建一条空的路由记录</span></span><br><span class="line">  <span class="keyword">return</span> _createRoute(<span class="literal">null</span>, location)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果是通过 <code>path</code> 的方式跳转，由于 <code>path</code> 可能会携带一些 <code>params</code> 的信息，前面我们已经提到过<a href="#%E4%B8%80%E3%80%81-new-router-%E6%97%B6%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88">初始化路由</a>信息时，会为每条路由生成一个正则表达式，所以这里就可以根据这个正则来检查是否符合当前路由，也就是上面提到 <code>matchRoute</code> 作用，下面是它的实现：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">matchRoute</span>(<span class="params">regex: RouteRegExp, path: string, params: <span class="built_in">Object</span></span>): <span class="title">boolean</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> m = path.match(regex)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!m) &#123;</span><br><span class="line">    <span class="comment">// 不匹配则直接退出</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!params) &#123;</span><br><span class="line">    <span class="comment">// 如果匹配并且该路由没有声明 param 参数，则匹配成功</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 将使用正则匹配到的 param 参数放入 params 对象中</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">1</span>, len = m.length; i &lt; len; ++i) &#123;</span><br><span class="line">    <span class="keyword">const</span> key = regex.keys[i - <span class="number">1</span>]</span><br><span class="line">    <span class="keyword">if</span> (key) &#123;</span><br><span class="line">      <span class="comment">// Fix #1994: using * with props: true generates a param named 0</span></span><br><span class="line">      params[key.name || <span class="string">&#x27;pathMatch&#x27;</span>] =</span><br><span class="line">        <span class="keyword">typeof</span> m[i] === <span class="string">&#x27;string&#x27;</span> ? decode(m[i]) : m[i]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到这里，关于如何匹配对应的路由已经讲完了，下面我们讲讲匹配到之后它还会做什么？</p>
<h5 id="3-调用-confirmTransition-方法"><a href="#3-调用-confirmTransition-方法" class="headerlink" title="3. 调用 confirmTransition 方法"></a>3. 调用 confirmTransition 方法</h5><p>前面我们在 <a href="#_1-%E8%B0%83%E7%94%A8-transitionto-%E6%96%B9%E6%B3%95">1. 调用 transitionTo 方法</a> 时讲到它拿到匹配的路由之后，就会调用 <code>confirmTransition</code> 方法，下面是它的实现：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 因为待跳转路由有可能是一个异步组件，所以设计成有回调的方法</span></span><br><span class="line"><span class="function"><span class="title">confirmTransition</span>(<span class="params">route: Route, onComplete: <span class="built_in">Function</span>, onAbort?: <span class="built_in">Function</span></span>)</span> &#123;</span><br><span class="line">  <span class="comment">// 跳转前的的路由（from）</span></span><br><span class="line">  <span class="keyword">const</span> current = <span class="built_in">this</span>.current</span><br><span class="line">  <span class="comment">// 待跳转的路由（to）</span></span><br><span class="line">  <span class="built_in">this</span>.pending = route</span><br><span class="line">  <span class="comment">// 错误时的回调</span></span><br><span class="line">  <span class="keyword">const</span> abort = <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// changed after adding errors with</span></span><br><span class="line">    <span class="comment">// https://github.com/vuejs/vue-router/pull/3047 before that change,</span></span><br><span class="line">    <span class="comment">// redirect and aborted navigation would produce an err == null</span></span><br><span class="line">    <span class="keyword">if</span> (!isNavigationFailure(err) &amp;&amp; isError(err)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.errorCbs.length) &#123;</span><br><span class="line">        <span class="built_in">this</span>.errorCbs.forEach(<span class="function">(<span class="params">cb</span>) =&gt;</span> &#123;</span><br><span class="line">          cb(err)</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        warn(<span class="literal">false</span>, <span class="string">&#x27;uncaught error during route navigation:&#x27;</span>)</span><br><span class="line">        <span class="built_in">console</span>.error(err)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    onAbort &amp;&amp; onAbort(err)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> lastRouteIndex = route.matched.length - <span class="number">1</span></span><br><span class="line">  <span class="keyword">const</span> lastCurrentIndex = current.matched.length - <span class="number">1</span></span><br><span class="line">  <span class="comment">// 判断是否相同路径</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    isSameRoute(route, current) &amp;&amp;</span><br><span class="line">    <span class="comment">// in the case the route map has been dynamically appended to</span></span><br><span class="line">    lastRouteIndex === lastCurrentIndex &amp;&amp;</span><br><span class="line">    route.matched[lastRouteIndex] === current.matched[lastCurrentIndex]</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="comment">// 依旧切换</span></span><br><span class="line">    <span class="built_in">this</span>.ensureURL()</span><br><span class="line">    <span class="comment">// 报一个重复导航的错误</span></span><br><span class="line">    <span class="keyword">return</span> abort(createNavigationDuplicatedError(current, route))</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 通过 from 和 to的 matched 数组拿到新增、更新、销毁的部分，以便执行组件的生命周期</span></span><br><span class="line">  <span class="comment">// 该方法下面会仔细讲</span></span><br><span class="line">  <span class="keyword">const</span> &#123; updated, deactivated, activated &#125; = resolveQueue(</span><br><span class="line">    <span class="built_in">this</span>.current.matched,</span><br><span class="line">    route.matched</span><br><span class="line">  )</span><br><span class="line">  <span class="comment">// 一个队列，存放各种组件生命周期和导航守卫</span></span><br><span class="line">  <span class="comment">// 这里的顺序可以看回前面讲的完整的导航解析流程，具体实现下面会讲</span></span><br><span class="line">  <span class="keyword">const</span> queue: <span class="built_in">Array</span>&lt;?NavigationGuard&gt; = [].concat(</span><br><span class="line">    <span class="comment">// in-component leave guards</span></span><br><span class="line">    extractLeaveGuards(deactivated),</span><br><span class="line">    <span class="comment">// global before hooks</span></span><br><span class="line">    <span class="built_in">this</span>.router.beforeHooks,</span><br><span class="line">    <span class="comment">// in-component update hooks</span></span><br><span class="line">    extractUpdateHooks(updated),</span><br><span class="line">    <span class="comment">// in-config enter guards</span></span><br><span class="line">    activated.map(<span class="function">(<span class="params">m</span>) =&gt;</span> m.beforeEnter),</span><br><span class="line">    <span class="comment">// async components</span></span><br><span class="line">    resolveAsyncComponents(activated)</span><br><span class="line">  )</span><br><span class="line">  <span class="comment">// 迭代器，每次执行一个钩子，调用 next 时才会进行下一项</span></span><br><span class="line">  <span class="keyword">const</span> iterator = <span class="function">(<span class="params">hook: NavigationGuard, next</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 在当前导航还没有完成之前又有了一个新的导航。</span></span><br><span class="line">    <span class="comment">// 比如，在等待导航守卫的过程中又调用了 router.push</span></span><br><span class="line">    <span class="comment">// 这时候需要报一个 cancel 错误</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.pending !== route) &#123;</span><br><span class="line">      <span class="keyword">return</span> abort(createNavigationCancelledError(current, route))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 执行当前钩子，但用户传入的导航守卫有可能会出错，需要 try 一下</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 这就是路由钩子的参数：to、from、next</span></span><br><span class="line">      hook(route, current, <span class="function">(<span class="params">to: any</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 我们可以通过 next(&#x27;/login&#x27;) 这样的方式来重定向</span></span><br><span class="line">        <span class="comment">// 如果传入 false 则中断当前的导航，并将 URL 重置到 from 路由对应的地址</span></span><br><span class="line">        <span class="keyword">if</span> (to === <span class="literal">false</span>) &#123;</span><br><span class="line">          <span class="comment">// next(false) -&gt; abort navigation, ensure current URL</span></span><br><span class="line">          <span class="built_in">this</span>.ensureURL(<span class="literal">true</span>)</span><br><span class="line">          abort(createNavigationAbortedError(current, route))</span><br><span class="line">        <span class="comment">// 如果传入 next 的参数是一个 Error 实例</span></span><br><span class="line">        <span class="comment">// 则导航会被终止且该错误会被传递给 router.onError() 注册过的回调。</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isError(to)) &#123;</span><br><span class="line">          <span class="built_in">this</span>.ensureURL(<span class="literal">true</span>)</span><br><span class="line">          abort(to)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">          <span class="comment">// 判断传入的参数是否符合要求</span></span><br><span class="line">          <span class="keyword">typeof</span> to === <span class="string">&#x27;string&#x27;</span> ||</span><br><span class="line">          (<span class="keyword">typeof</span> to === <span class="string">&#x27;object&#x27;</span> &amp;&amp;</span><br><span class="line">            (<span class="keyword">typeof</span> to.path === <span class="string">&#x27;string&#x27;</span> || typeofto.name === <span class="string">&#x27;string&#x27;</span>))</span><br><span class="line">        ) &#123;</span><br><span class="line">          <span class="comment">// next(&#x27;/&#x27;) or next(&#123; path: &#x27;/&#x27; &#125;) -&gt; redirect</span></span><br><span class="line">          abort(createNavigationRedirectedError(current, route))</span><br><span class="line">          <span class="comment">// 判断切换类型</span></span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">typeof</span> to === <span class="string">&#x27;object&#x27;</span> &amp;&amp; to.replace) &#123;</span><br><span class="line">            <span class="built_in">this</span>.replace(to)</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.push(to)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// 不符合则跳转至 to</span></span><br><span class="line">          <span class="comment">// confirm transition and pass on the value</span></span><br><span class="line">          next(to)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    <span class="comment">// 出错时执行 abort 回调</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      abort(e)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 执行队列，下面仔细讲</span></span><br><span class="line">  runQueue(queue, iterator, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// wait until async components are resolved before</span></span><br><span class="line">    <span class="comment">// extracting in-component enter guards</span></span><br><span class="line">    <span class="keyword">const</span> enterGuards = extractEnterGuards(activated)</span><br><span class="line">    <span class="keyword">const</span> queue = enterGuards.concat(<span class="built_in">this</span>.router.resolveHooks)</span><br><span class="line">    runQueue(queue, iterator, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.pending !== route) &#123;</span><br><span class="line">        <span class="keyword">return</span> abort(createNavigationCancelledError(current, route))</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">this</span>.pending = <span class="literal">null</span></span><br><span class="line">      onComplete(route)</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.router.app) &#123;</span><br><span class="line">        <span class="built_in">this</span>.router.app.$nextTick(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          handleRouteEntered(route)</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="4-构造导航守卫队列"><a href="#4-构造导航守卫队列" class="headerlink" title="4. 构造导航守卫队列"></a>4. 构造导航守卫队列</h5><p>我们知道在切换路由时需要执行一系列的导航守卫和路由相关的生命周期，下面就讲讲它的实现，其实也是在 <code>confirmTransition</code> 这个方法中。<br>​</p>
<p>第一步就是构造队列，关于它们执行的顺序可以看回文档。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 一个队列，存放各种组件生命周期和导航守卫</span></span><br><span class="line"><span class="comment">// 注意：这里只是完整迭代导航解析流程中的 2~6 步</span></span><br><span class="line"><span class="keyword">const</span> queue: <span class="built_in">Array</span>&lt;?NavigationGuard&gt; = [].concat(</span><br><span class="line">  <span class="comment">// 调用此次失活的部分组件的 beforeRouteLeave</span></span><br><span class="line">  extractLeaveGuards(deactivated),</span><br><span class="line">  <span class="comment">// 全局的 before 钩子</span></span><br><span class="line">  <span class="built_in">this</span>.router.beforeHooks,</span><br><span class="line">  <span class="comment">// 调用此次更新的部分组件的 beforeRouteUpdate</span></span><br><span class="line">  extractUpdateHooks(updated),</span><br><span class="line">  <span class="comment">// 调用此次激活的路由配置的 beforeEach</span></span><br><span class="line">  activated.map(<span class="function">(<span class="params">m</span>) =&gt;</span> m.beforeEnter),</span><br><span class="line">  <span class="comment">// 解析异步组件</span></span><br><span class="line">  resolveAsyncComponents(activated)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>还记得前面我们讲了 <code>updated, deactivated, activated</code> 这三个数组是从 <code>resolveQueue</code> 方法中获取：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; updated, deactivated, activated &#125; = resolveQueue(</span><br><span class="line">  <span class="built_in">this</span>.current.matched,</span><br><span class="line">  route.matched</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>下面是它的实现：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolveQueue</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  current: <span class="built_in">Array</span>&lt;RouteRecord&gt;,</span></span></span><br><span class="line"><span class="params"><span class="function">  next: <span class="built_in">Array</span>&lt;RouteRecord&gt;</span></span></span><br><span class="line"><span class="params"><span class="function"></span>): </span>&#123;</span><br><span class="line">  <span class="attr">updated</span>: <span class="built_in">Array</span>&lt;RouteRecord&gt;,</span><br><span class="line">  activated: <span class="built_in">Array</span>&lt;RouteRecord&gt;,</span><br><span class="line">  deactivated: <span class="built_in">Array</span>&lt;RouteRecord&gt;</span><br><span class="line">&#125; &#123;</span><br><span class="line">  <span class="keyword">let</span> i</span><br><span class="line">  <span class="keyword">const</span> max = <span class="built_in">Math</span>.max(current.length, next.length)</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; max; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (current[i] !== next[i]) &#123;</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">updated</span>: next.slice(<span class="number">0</span>, i),</span><br><span class="line">    <span class="attr">activated</span>: next.slice(i),</span><br><span class="line">    <span class="attr">deactivated</span>: current.slice(i)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实现原理很简单，只需要对比 <code>current</code> 和 <code>next</code> 的 <code>match</code> 数组，就能拿到以下数组：</p>
<ol>
<li><code>updated</code>：有交集的部分</li>
<li><code>activated</code>：next 有并且 current 没有的部分</li>
<li><code>deactivated</code>：current 有并且 next 没有的部分</li>
</ol>
<p>下面是队列中各项的实现</p>
<ol>
<li>调用 <code>extractLeaveGuards(deactivated)</code> 执行销毁的组件 <code>beforeRouteLeave</code> 生命周期：</li>
</ol>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">extractLeaveGuards</span>(<span class="params">deactivated: <span class="built_in">Array</span>&lt;RouteRecord&gt;</span>): <span class="title">Array</span>&lt;?<span class="title">Function</span>&gt; </span>&#123;</span><br><span class="line">  <span class="comment">// 最后一个参数为 true 是因为这个生命周期要倒序执行，先执行子路由的再执行父路由的</span></span><br><span class="line">  <span class="keyword">return</span> extractGuards(deactivated, <span class="string">&#x27;beforeRouteLeave&#x27;</span>, bindGuard, <span class="literal">true</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>调用全局的 <code>beforeHooks</code> ，其实也就是存放用户通过 <code>beforeEach</code> 注册的数组：</li>
</ol>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">beforeEach (fn: <span class="built_in">Function</span>): <span class="built_in">Function</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> registerHook(<span class="built_in">this</span>.beforeHooks, fn)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>调用 <code>extractUpdateHooks(updated)</code> 执行更新的组件：</li>
</ol>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">extractUpdateHooks</span>(<span class="params">updated: <span class="built_in">Array</span>&lt;RouteRecord&gt;</span>): <span class="title">Array</span>&lt;?<span class="title">Function</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> extractGuards(updated, <span class="string">&#x27;beforeRouteUpdate&#x27;</span>, bindGuard)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>调用所有激活组件的 <code>beforeEnter</code> 生命周期：</li>
</ol>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">activated.map(<span class="function">(<span class="params">m</span>) =&gt;</span> m.beforeEnter)</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>调用 <code>resolveAsyncComponents(activated)</code> 来解析异步组件：</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">resolveAsyncComponents</span>(<span class="params">matched: <span class="built_in">Array</span>&lt;RouteRecord&gt;</span>): <span class="title">Function</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 返回一个队列钩子函数</span></span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">to, <span class="keyword">from</span>, next</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 用于标记是否异步组件</span></span><br><span class="line">    <span class="keyword">let</span> hasAsync = <span class="literal">false</span></span><br><span class="line">    <span class="comment">// 待加载的组件数量</span></span><br><span class="line">    <span class="keyword">let</span> pending = <span class="number">0</span></span><br><span class="line">    <span class="comment">// 是否加载错误</span></span><br><span class="line">    <span class="keyword">let</span> error = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这个方法下面会讲，主要作用是依次遍历传入的 matched 数组相关的 component</span></span><br><span class="line">    flatMapComponents(matched, <span class="function">(<span class="params">def, _, match, key</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 判断是否异步组件</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> def === <span class="string">&#x27;function&#x27;</span> &amp;&amp; def.cid === <span class="literal">undefined</span>) &#123;</span><br><span class="line">        hasAsync = <span class="literal">true</span></span><br><span class="line">        pending++</span><br><span class="line"></span><br><span class="line">        <span class="comment">// webpack 加载这个异步组件的 chunk 后执行</span></span><br><span class="line">        <span class="keyword">const</span> resolve = once(<span class="function">(<span class="params">resolvedDef</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (isESModule(resolvedDef)) &#123;</span><br><span class="line">            resolvedDef = resolvedDef.default</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// 将它变成一个 vue 组件</span></span><br><span class="line">          <span class="comment">// save resolved on async factory in case it&#x27;s used elsewhere</span></span><br><span class="line">          def.resolved =</span><br><span class="line">            <span class="keyword">typeof</span> resolvedDef === <span class="string">&#x27;function&#x27;</span></span><br><span class="line">              ? resolvedDef</span><br><span class="line">              : _Vue.extend(resolvedDef)</span><br><span class="line">          <span class="comment">// 把解析好的组件更新到当前路由记录中</span></span><br><span class="line">          match.components[key] = resolvedDef</span><br><span class="line">          pending--</span><br><span class="line">          <span class="comment">// 如果已经加载完则调用 next 进入下一个队列</span></span><br><span class="line">          <span class="keyword">if</span> (pending &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            next()</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// webpack 加载这个异步组件失败后执行</span></span><br><span class="line">        <span class="keyword">const</span> reject = once(<span class="function">(<span class="params">reason</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="comment">// 报个错</span></span><br><span class="line">          <span class="keyword">const</span> msg = <span class="string">`Failed to resolve async component <span class="subst">$&#123;key&#125;</span>: <span class="subst">$&#123;reason&#125;</span>`</span></span><br><span class="line">          process.env.NODE_ENV !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; warn(<span class="literal">false</span>, msg)</span><br><span class="line">          <span class="keyword">if</span> (!error) &#123;</span><br><span class="line">            error = isError(reason) ? reason : <span class="keyword">new</span> <span class="built_in">Error</span>(msg)</span><br><span class="line">            next(error)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> res</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">// 这里是调用 webpack 方法加载这个组件，返回的是一个 Promise</span></span><br><span class="line">          res = def(resolve, reject)</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">          reject(e)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (res) &#123;</span><br><span class="line">          <span class="comment">// 这里才真正加载这个组件</span></span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">typeof</span> res.then === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">            res.then(resolve, reject)</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// new syntax in Vue 2.3</span></span><br><span class="line">            <span class="keyword">const</span> comp = res.component</span><br><span class="line">            <span class="keyword">if</span> (comp &amp;&amp; <span class="keyword">typeof</span> comp.then === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">              comp.then(resolve, reject)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 不是异步则直接 next</span></span><br><span class="line">    <span class="keyword">if</span> (!hasAsync) next()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>异步加载这一块其实涉及比较多，深入讲的话还要讲 <code>webpack</code> ，所以这里只讲大概的流程，以后有机会的话再深入讲解。</p>
<p>可以看到执行导航守卫都是通过调用一个 <code>extractGuards</code> 方法，下面是它的实现：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// records: routerRecord 数组</span></span><br><span class="line"><span class="comment">// name 钩子的名字</span></span><br><span class="line"><span class="comment">// bind 就是 bindGuard 方法，下面会讲</span></span><br><span class="line"><span class="comment">// reverse 是否倒序执行</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">extractGuards</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  records: <span class="built_in">Array</span>&lt;RouteRecord&gt;,</span></span></span><br><span class="line"><span class="params"><span class="function">  name: string,</span></span></span><br><span class="line"><span class="params"><span class="function">  bind: <span class="built_in">Function</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  reverse?: boolean</span></span></span><br><span class="line"><span class="params"><span class="function"></span>): <span class="title">Array</span>&lt;?<span class="title">Function</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> guards = flatMapComponents(records, <span class="function">(<span class="params">def, instance, match, key</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> guard = extractGuard(def, name)</span><br><span class="line">    <span class="keyword">if</span> (guard) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Array</span>.isArray(guard)</span><br><span class="line">        ? guard.map(<span class="function">(<span class="params">guard</span>) =&gt;</span> bind(guard, instance, match, key))</span><br><span class="line">        : bind(guard, instance, match, key)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">return</span> flatten(reverse ? guards.reverse() : guards)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在仔细讲这个方法内部逻辑前，要先搞清楚这三个方法的内部： <code>extractGuard</code> 、 <code>bindGuard</code> 、 <code>flatMapComponents</code> ：</p>
<p><code>extractGuard</code> 很简单，其实就是获取 vue 组件实例中特定的生命周期：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">extractGuard</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  def: <span class="built_in">Object</span> | <span class="built_in">Function</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  key: string</span></span></span><br><span class="line"><span class="params"><span class="function"></span>): <span class="title">NavigationGuard</span> | <span class="title">Array</span>&lt;<span class="title">NavigationGuard</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> def !== <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">    <span class="comment">// extend now so that global mixins are applied.</span></span><br><span class="line">    def = _Vue.extend(def)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> def.options[key]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>bindGuard</code> 的作用就是返回一个函数，这个函数会调用组件特定生命周期，给后续执行队列时调用：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// guard：某个生命周期钩子</span></span><br><span class="line"><span class="comment">// instance：执行的 vue 实例</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bindGuard</span>(<span class="params">guard: NavigationGuard, instance: ?_Vue</span>): ?<span class="title">NavigationGuard</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (instance) &#123;</span><br><span class="line">    <span class="comment">// 这时只是返回这个方法，没有立即调用</span></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">boundRouteGuard</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="comment">// 调用这个钩子</span></span><br><span class="line">      <span class="keyword">return</span> guard.apply(instance, <span class="built_in">arguments</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而 <code>flatMapComponents</code> 顾名思义就是跟组件相关的，它的作用是依次遍历传入的 <code>matched</code> 数组相关的组件，并调用传入的回调的返回值作为自己的返回值，所以它的返回值是调用者决定的：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">flatMapComponents</span>(<span class="params">matched, fn</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> flatten(</span><br><span class="line">    matched.map(<span class="function"><span class="keyword">function</span> (<span class="params">m</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Object</span>.keys(m.components).map(<span class="function"><span class="keyword">function</span> (<span class="params">key</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> fn(m.components[key], m.instances[key], m, key)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以现在再回过头来看 <code>extractGuards</code> 就很清晰了，它的作用就是通过 <code>flatMapComponents</code> 遍历所有 <code>match</code> 数组中的组件，并通过 <code>extractGuard</code> 拿到这些组件的特定生命周期，然后通过 <code>bindGuard</code> 返回一个可以调用这个生命周期的函数，然后利用 <code>flatten</code> 将它们扁平化，根据 <code>reverse</code> 决定是否倒序返回这些函数数组。</p>
<p>最后这些函数全部放在 <code>queue</code> 中，这就是构造整个队列的过程了。</p>
<h5 id="5-执行队列"><a href="#5-执行队列" class="headerlink" title="5. 执行队列"></a>5. 执行队列</h5><p>构造完队列，下面就要开始执行这个队列了，在这之前我们先来看看 <code>runQueue</code> 的实现：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">runQueue</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  queue: <span class="built_in">Array</span>&lt;?NavigationGuard&gt;,</span></span></span><br><span class="line"><span class="params"><span class="function">  fn: <span class="built_in">Function</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  cb: <span class="built_in">Function</span></span></span></span><br><span class="line"><span class="params"><span class="function"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> step = <span class="function">(<span class="params">index</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (index &gt;= queue.length) &#123;</span><br><span class="line">      cb()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (queue[index]) &#123;</span><br><span class="line">        fn(queue[index], <span class="function">() =&gt;</span> &#123;</span><br><span class="line">          step(index + <span class="number">1</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        step(index + <span class="number">1</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  step(<span class="number">0</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其实也不复杂，首先从 0 开始按顺序遍历 <code>queue</code> 中的每一项，在调用 <code>fn</code> 时作为第一个参数传入，当使用者调用了第二个参数的回调时，才进入下一次项，最后遍历完 <code>queue</code> 中所有的项后，调用 <code>cb</code> 回到参数。</p>
<p>下面是执行这个队列的过程：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 执行队列</span></span><br><span class="line"><span class="comment">// queue 就是上面那个队列</span></span><br><span class="line"><span class="comment">// iterator 传入 to、from、next，只有执行 next 才会进入下一项</span></span><br><span class="line"><span class="comment">// cb 回调函数，当执行完整个队列后调用</span></span><br><span class="line">runQueue(queue, iterator, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// wait until async components are resolved before</span></span><br><span class="line">  <span class="comment">// extracting in-component enter guards</span></span><br><span class="line">  <span class="keyword">const</span> enterGuards = extractEnterGuards(activated)</span><br><span class="line">  <span class="keyword">const</span> queue = enterGuards.concat(<span class="built_in">this</span>.router.resolveHooks)</span><br><span class="line">  runQueue(queue, iterator, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.pending !== route) &#123;</span><br><span class="line">      <span class="keyword">return</span> abort(createNavigationCancelledError(current, route))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.pending = <span class="literal">null</span></span><br><span class="line">    onComplete(route)</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.router.app) &#123;</span><br><span class="line">      <span class="built_in">this</span>.router.app.$nextTick(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        handleRouteEntered(route)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><code>iterator</code> 的定义在 <a href="#_1-%E8%B0%83%E7%94%A8-transitionto-%E6%96%B9%E6%B3%95">1. 调用 transitionTo 方法</a> 这一小节中已经有提到了，这里拷贝一份过来：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 迭代器，每次执行一个钩子，调用 next 时才会进行下一项</span></span><br><span class="line"><span class="keyword">const</span> iterator = <span class="function">(<span class="params">hook: NavigationGuard, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 在当前导航还没有完成之前又有了一个新的导航。</span></span><br><span class="line">  <span class="comment">// 比如，在等待导航守卫的过程中又调用了 router.push</span></span><br><span class="line">  <span class="comment">// 这时候需要报一个 cancel 错误</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">this</span>.pending !== route) &#123;</span><br><span class="line">    <span class="keyword">return</span> abort(createNavigationCancelledError(current, route))</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 执行当前钩子，但用户传入的导航守卫有可能会出错，需要 try 一下</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 这就是路由钩子的参数：to、from、next</span></span><br><span class="line">    hook(route, current, <span class="function">(<span class="params">to: any</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 我们可以通过 next(&#x27;/login&#x27;) 这样的方式来重定向</span></span><br><span class="line">      <span class="comment">// 如果传入 false 则中断当前的导航，并将 URL 重置到 from 路由对应的地址</span></span><br><span class="line">      <span class="keyword">if</span> (to === <span class="literal">false</span>) &#123;</span><br><span class="line">        <span class="comment">// next(false) -&gt; abort navigation, ensure current URL</span></span><br><span class="line">        <span class="built_in">this</span>.ensureURL(<span class="literal">true</span>)</span><br><span class="line">        abort(createNavigationAbortedError(current, route))</span><br><span class="line">        <span class="comment">// 如果传入 next 的参数是一个 Error 实例</span></span><br><span class="line">        <span class="comment">// 则导航会被终止且该错误会被传递给 router.onError() 注册过的回调。</span></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isError(to)) &#123;</span><br><span class="line">        <span class="built_in">this</span>.ensureURL(<span class="literal">true</span>)</span><br><span class="line">        abort(to)</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">        <span class="comment">// 判断传入的参数是否符合要求</span></span><br><span class="line">        <span class="keyword">typeof</span> to === <span class="string">&#x27;string&#x27;</span> ||</span><br><span class="line">        (<span class="keyword">typeof</span> to === <span class="string">&#x27;object&#x27;</span> &amp;&amp;</span><br><span class="line">          (<span class="keyword">typeof</span> to.path === <span class="string">&#x27;string&#x27;</span> || typeofto.name === <span class="string">&#x27;string&#x27;</span>))</span><br><span class="line">      ) &#123;</span><br><span class="line">        <span class="comment">// next(&#x27;/&#x27;) or next(&#123; path: &#x27;/&#x27; &#125;) -&gt; redirect</span></span><br><span class="line">        abort(createNavigationRedirectedError(current, route))</span><br><span class="line">        <span class="comment">// 判断切换类型</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> to === <span class="string">&#x27;object&#x27;</span> &amp;&amp; to.replace) &#123;</span><br><span class="line">          <span class="built_in">this</span>.replace(to)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="built_in">this</span>.push(to)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 不符合则跳转至 to</span></span><br><span class="line">        <span class="comment">// confirm transition and pass on the value</span></span><br><span class="line">        next(to)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// 出错时执行 abort 回调</span></span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    abort(e)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是我们留意到这里其实是嵌套执行了两次 <code>runQueue</code> ，这是因为我们前面构造的 <code>queue</code> 只是 vue-router 完整的导航解析流程中的 第 2<del>6 步，而接下来就要执行第 7</del>9 步：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这时候异步组件已经解析完成</span></span><br><span class="line"><span class="comment">// 下面是构造 beforeRouteEnter 和 beforeResolve 守卫的队列</span></span><br><span class="line"><span class="keyword">const</span> enterGuards = extractEnterGuards(activated)</span><br><span class="line"><span class="keyword">const</span> queue = enterGuards.concat(<span class="built_in">this</span>.router.resolveHooks)</span><br><span class="line">runQueue(queue, iterator, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">this</span>.pending !== route) &#123;</span><br><span class="line">    <span class="keyword">return</span> abort(createNavigationCancelledError(current, route))</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">this</span>.pending = <span class="literal">null</span></span><br><span class="line">  <span class="comment">// 这里是调用 transitionTo 传入的 onComplete 回调</span></span><br><span class="line">  <span class="comment">// 在这里会做一些更新路由、URL、调用 afterHooks、onReady 等回调，下面就讲</span></span><br><span class="line">  onComplete(route)</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">this</span>.router.app) &#123;</span><br><span class="line">    <span class="comment">// 下次更新 DOM 时触发 handleRouteEntered</span></span><br><span class="line">    <span class="built_in">this</span>.router.app.$nextTick(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// TODO 不太明白这个方法的内部</span></span><br><span class="line">      handleRouteEntered(route)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h5 id="6-执行-confirmTransition-后的操作"><a href="#6-执行-confirmTransition-后的操作" class="headerlink" title="6. 执行 confirmTransition 后的操作"></a>6. 执行 <code>confirmTransition</code> 后的操作</h5><p>到这里 <code>confirmTransition</code> 方法就已经执行完了，最后会调用 <code>transitionTo</code> 传入的 <code>onComplete</code> 方法，之前就有提到：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 更新到当前路由信息 (current)，下面会讲</span></span><br><span class="line"><span class="built_in">this</span>.updateRoute(route)</span><br><span class="line"><span class="comment">// 执行用户传入的 onComplete回调</span></span><br><span class="line">onComplete &amp;&amp; onComplete(route)</span><br><span class="line"><span class="comment">// 更新浏览器地址栏上的 URL</span></span><br><span class="line"><span class="built_in">this</span>.ensureURL()</span><br><span class="line"><span class="comment">// 执行注册的 afterHooks</span></span><br><span class="line"><span class="built_in">this</span>.router.afterHooks.forEach(<span class="function">(<span class="params">hook</span>) =&gt;</span> &#123;</span><br><span class="line">  hook &amp;&amp; hook(route, prev)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">this</span>.ready) &#123;</span><br><span class="line">  <span class="built_in">this</span>.ready = <span class="literal">true</span></span><br><span class="line">  <span class="comment">// 执行用户传入的 onReady 回调</span></span><br><span class="line">  <span class="built_in">this</span>.readyCbs.forEach(<span class="function">(<span class="params">cb</span>) =&gt;</span> &#123;</span><br><span class="line">    cb(route)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里主要做了几步：更新当前路由、调用传入的 <code>onComplete</code> 、更新 <code>URL</code> 、调用 <code>afterHooks</code> 、 <code>onReady</code> 钩子。</p>
<p>而如果 <code>confirmTransition</code> 执行失败的话，则会执行传入的 <code>onAbort</code> ：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (onAbort) &#123;</span><br><span class="line">  onAbort(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (err &amp;&amp; !<span class="built_in">this</span>.ready) &#123;</span><br><span class="line">  <span class="comment">// Initial redirection should not mark the history as ready yet</span></span><br><span class="line">  <span class="comment">// because it&#x27;s triggered by the redirection instead</span></span><br><span class="line">  <span class="comment">// https://github.com/vuejs/vue-router/issues/3225</span></span><br><span class="line">  <span class="comment">// https://github.com/vuejs/vue-router/issues/3331</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    !isNavigationFailure(err, NavigationFailureType.redirected) ||</span><br><span class="line">    prev !== START</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="built_in">this</span>.ready = <span class="literal">true</span></span><br><span class="line">    <span class="built_in">this</span>.readyErrorCbs.forEach(<span class="function">(<span class="params">cb</span>) =&gt;</span> &#123;</span><br><span class="line">      cb(err)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主要是调用传入的 <code>onAbort</code> 回调，执行 <code>onError</code> 钩子。</p>
<p>到这里整个 <code>transitionTo</code> 方法的执行过程已经讲完了，导航守卫和一些钩子函数也已经全部执行完毕。<br>​</p>
<h5 id="7-更新路由信息"><a href="#7-更新路由信息" class="headerlink" title="7. 更新路由信息"></a>7. 更新路由信息</h5><p>接着我们看看它是如何更新当前路由信息的，也就是 <code>updateRoute</code> 方法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">updateRoute</span>(<span class="params">route: Route</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.current = route</span><br><span class="line">    <span class="built_in">this</span>.cb &amp;&amp; <span class="built_in">this</span>.cb(route)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先是更新一下 <code>current</code> 的指向，接着调用 <code>cb</code> 这个回调函数并且将当前路由传入，那这个 <code>cb</code> 是什么东西呢？它是在 <code>listen</code> 方法中被赋值的：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">listen</span>(<span class="params">cb: <span class="built_in">Function</span></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.cb = cb</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而哪里调用了这个 <code>listen</code> 方法呢？我们看回之前在 <a href="#_2-%E5%AE%89%E8%A3%85-router">2. 安装 Router</a> 时初始化那里的一段代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 监听路由变化，在所有 app 实例中设置当前路由</span></span><br><span class="line"><span class="comment">// 所以我们一直可以通过 this.$route 拿到当前路由</span></span><br><span class="line">history.listen(<span class="function">(<span class="params">route</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">this</span>.apps.forEach(<span class="function">(<span class="params">app</span>) =&gt;</span> &#123;</span><br><span class="line">    app._route = route</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>所以到这里，我们通过 <code>this.$route</code> 拿到的路由就已经变成跳转的路由了。<br>​</p>
<h5 id="8-更新-URL"><a href="#8-更新-URL" class="headerlink" title="8. 更新 URL"></a>8. 更新 URL</h5><p>接着就是更新 <code>URL</code> 了，在 <code>transitionTo</code> 这里它是先调用了 <code>onComplete</code> 方法，然后再调用 <code>ensureURL</code> 方法来更新浏览器上的 <code>URL</code> ，对应源码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 执行用户传入的 onComplete回调</span></span><br><span class="line">onComplete &amp;&amp; onComplete(route)</span><br><span class="line"><span class="comment">// 更新浏览器地址栏上的 URL</span></span><br><span class="line"><span class="built_in">this</span>.ensureURL()</span><br></pre></td></tr></table></figure>

<p>由于我们这里是以 <code>hash</code> 模式来展开的，所以我们看看它的 <code>push</code> 方法里传入的 <code>onComplete</code> 方法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">push</span>(<span class="params">location: RawLocation, onComplete ? : <span class="built_in">Function</span>, onAbort ? : <span class="built_in">Function</span></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;</span><br><span class="line">        <span class="attr">current</span>: fromRoute</span><br><span class="line">    &#125; = <span class="built_in">this</span></span><br><span class="line">    <span class="built_in">this</span>.transitionTo(</span><br><span class="line">        location,</span><br><span class="line">        <span class="function">(<span class="params">route</span>) =&gt;</span> &#123;</span><br><span class="line">            pushHash(route.fullPath)</span><br><span class="line">            handleScroll(<span class="built_in">this</span>.router, route, fromRoute, <span class="literal">false</span>)</span><br><span class="line">            onComplete &amp;&amp; onComplete(route)</span><br><span class="line">        &#125;,</span><br><span class="line">        onAbort</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而 <code>pushHash</code> 这里实际到后面已经可以更新 <code>URL</code> ：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 位于：src/util/push-state.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">pushState</span>(<span class="params">url?: string, replace?: boolean</span>) </span>&#123;</span><br><span class="line">  saveScrollPosition()</span><br><span class="line">  <span class="comment">// try...catch the pushState call to get around Safari</span></span><br><span class="line">  <span class="comment">// DOM Exception 18 where it limits to 100 pushState calls</span></span><br><span class="line">  <span class="keyword">const</span> history = <span class="built_in">window</span>.history</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (replace) &#123;</span><br><span class="line">      <span class="comment">// preserve existing history state as it could be overriden by the user</span></span><br><span class="line">      <span class="keyword">const</span> stateCopy = extend(&#123;&#125;, history.state)</span><br><span class="line">      stateCopy.key = getStateKey()</span><br><span class="line">      history.replaceState(stateCopy, <span class="string">&#x27;&#x27;</span>, url)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      history.pushState(</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">key</span>: setStateKey(genStateKey())</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        url</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="built_in">window</span>.location[replace ? <span class="string">&#x27;replace&#x27;</span> : <span class="string">&#x27;assign&#x27;</span>](url)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pushHash</span>(<span class="params">path</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (supportsPushState) &#123;</span><br><span class="line">    pushState(getUrl(path))</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">window</span>.location.hash = path</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以后面再执行 <code>ensureURL</code> 时就不需要再更新一遍了：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">ensureURL</span>(<span class="params">push ? : boolean</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> current = <span class="built_in">this</span>.current.fullPath</span><br><span class="line">    <span class="keyword">if</span> (getHash() !== current) &#123;</span><br><span class="line">        push ? pushHash(current) : replaceHash(current)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>难道这个 <code>ensureURL</code> 就是多此一举吗？也不是，在其他地方调用就会更新 <code>URL</code> 的，比如 <code>transitionTo</code> 检查是否跳转至相同路径：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (</span><br><span class="line">  isSameRoute(route, current) &amp;&amp;</span><br><span class="line">  <span class="comment">// in the case the route map has been dynamically appended to</span></span><br><span class="line">  lastRouteIndex === lastCurrentIndex &amp;&amp;</span><br><span class="line">  route.matched[lastRouteIndex] === current.matched[lastCurrentIndex]</span><br><span class="line">) &#123;</span><br><span class="line">  <span class="built_in">this</span>.ensureURL()</span><br><span class="line">  <span class="keyword">return</span> abort(createNavigationDuplicatedError(current, route))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里更新了 <code>URL</code> 以后，还会调用 <code>handleScroll</code> 来滚动相关的操作，如：保存当前滚动位置、根据传入的 <code>scrollBehavior</code> 设置当前滚动位置，不过这里就不展开讲了。</p>
<p>另外，更新 <code>URL</code> 这部分行为也是根据不同的路由模式有所区别，后面的章节会详情讲解。</p>
<h5 id="9-渲染对应的路由视图"><a href="#9-渲染对应的路由视图" class="headerlink" title="9. 渲染对应的路由视图"></a>9. 渲染对应的路由视图</h5><p>除了更新 <code>URL</code> 以外，我们还要渲染当前路由对应的视图，那这又是如何做到的呢？我们知道 vue-router 是通过一个叫 <code>router-view</code> 的组件来渲染，下面看看它的实现，它的源码在：<a target="_blank" rel="noopener" href="https://github1s.com/vuejs/vue-router/blob/HEAD/src/components/view.js">src/components/view.js</a>，我们先粗略看一下它的 <code>render</code> 方法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">render</span>(<span class="params">_, &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">    props,</span></span></span><br><span class="line"><span class="params"><span class="function">    children,</span></span></span><br><span class="line"><span class="params"><span class="function">    parent,</span></span></span><br><span class="line"><span class="params"><span class="function">    data</span></span></span><br><span class="line"><span class="params"><span class="function">&#125;</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// used by devtools to display a router-view badge</span></span><br><span class="line">    data.routerView = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// directly use parent context&#x27;s createElement() function</span></span><br><span class="line">    <span class="comment">// so that components rendered by router-view can resolve named slots</span></span><br><span class="line">    <span class="keyword">const</span> h = parent.$createElement</span><br><span class="line">    <span class="keyword">const</span> name = props.name</span><br><span class="line">    <span class="comment">// 拿到当前路由</span></span><br><span class="line">    <span class="keyword">const</span> route = parent.$route</span><br><span class="line">    <span class="comment">// 缓存路由视图，keepAlive 时会用到</span></span><br><span class="line">    <span class="keyword">const</span> cache = parent._routerViewCache || (parent._routerViewCache = &#123;&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// determine current view depth, also check to see if the tree</span></span><br><span class="line">    <span class="comment">// has been toggled inactive but kept-alive.</span></span><br><span class="line">    <span class="keyword">let</span> depth = <span class="number">0</span></span><br><span class="line">    <span class="keyword">let</span> inactive = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">while</span> (parent &amp;&amp; parent._routerRoot !== parent) &#123;</span><br><span class="line">        <span class="keyword">const</span> vnodeData = parent.$vnode ? parent.$vnode.data : &#123;&#125;</span><br><span class="line">        <span class="keyword">if</span> (vnodeData.routerView) &#123;</span><br><span class="line">            depth++</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (vnodeData.keepAlive &amp;&amp; parent._directInactive &amp;&amp; parent._inactive) &#123;</span><br><span class="line">            inactive = <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">        parent = parent.$parent</span><br><span class="line">    &#125;</span><br><span class="line">    data.routerViewDepth = depth</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里是渲染已经缓存的视图</span></span><br><span class="line">    <span class="keyword">if</span> (inactive) &#123;</span><br><span class="line">        <span class="keyword">const</span> cachedData = cache[name]</span><br><span class="line">        <span class="keyword">const</span> cachedComponent = cachedData &amp;&amp; cachedData.component</span><br><span class="line">        <span class="keyword">if</span> (cachedComponent) &#123;</span><br><span class="line">            <span class="comment">// #2301</span></span><br><span class="line">            <span class="comment">// pass props</span></span><br><span class="line">            <span class="keyword">if</span> (cachedData.configProps) &#123;</span><br><span class="line">                fillPropsinData(</span><br><span class="line">                    cachedComponent,</span><br><span class="line">                    data,</span><br><span class="line">                    cachedData.route,</span><br><span class="line">                    cachedData.configProps</span><br><span class="line">                )</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> h(cachedComponent, data, children)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// render previous empty view</span></span><br><span class="line">            <span class="keyword">return</span> h()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 拿到对应的视图组件</span></span><br><span class="line">    <span class="keyword">const</span> matched = route.matched[depth]</span><br><span class="line">    <span class="keyword">const</span> component = matched &amp;&amp; matched.components[name]</span><br><span class="line"></span><br><span class="line">    <span class="comment">// render empty node if no matched route or no config component</span></span><br><span class="line">    <span class="keyword">if</span> (!matched || !component) &#123;</span><br><span class="line">        cache[name] = <span class="literal">null</span></span><br><span class="line">        <span class="keyword">return</span> h()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// cache component</span></span><br><span class="line">    cache[name] = &#123;</span><br><span class="line">        component</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// attach instance registration hook</span></span><br><span class="line">    <span class="comment">// this will be called in the instance&#x27;s injected lifecycle hooks</span></span><br><span class="line">    data.registerRouteInstance = <span class="function">(<span class="params">vm, val</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// val could be undefined for unregistration</span></span><br><span class="line">        <span class="keyword">const</span> current = matched.instances[name]</span><br><span class="line">        <span class="keyword">if</span> ((val &amp;&amp; current !== vm) || (!val &amp;&amp; current === vm)) &#123;</span><br><span class="line">            matched.instances[name] = val</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// also register instance in prepatch hook</span></span><br><span class="line">    <span class="comment">// in case the same component instance is reused across different routes</span></span><br><span class="line">    ;</span><br><span class="line">    (data.hook || (data.hook = &#123;&#125;)).prepatch = <span class="function">(<span class="params">_, vnode</span>) =&gt;</span> &#123;</span><br><span class="line">        matched.instances[name] = vnode.componentInstance</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// register instance in init hook</span></span><br><span class="line">    <span class="comment">// in case kept-alive component be actived when routes changed</span></span><br><span class="line">    data.hook.init = <span class="function">(<span class="params">vnode</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">            vnode.data.keepAlive &amp;&amp;</span><br><span class="line">            vnode.componentInstance &amp;&amp;</span><br><span class="line">            vnode.componentInstance !== matched.instances[name]</span><br><span class="line">        ) &#123;</span><br><span class="line">            matched.instances[name] = vnode.componentInstance</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// if the route transition has already been confirmed then we weren&#x27;t</span></span><br><span class="line">        <span class="comment">// able to call the cbs during confirmation as the component was not</span></span><br><span class="line">        <span class="comment">// registered yet, so we call it here.</span></span><br><span class="line">        handleRouteEntered(route)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> configProps = matched.props &amp;&amp; matched.props[name]</span><br><span class="line">    <span class="comment">// save route and configProps in cache</span></span><br><span class="line">    <span class="keyword">if</span> (configProps) &#123;</span><br><span class="line">        extend(cache[name], &#123;</span><br><span class="line">            route,</span><br><span class="line">            configProps</span><br><span class="line">        &#125;)</span><br><span class="line">        fillPropsinData(component, data, route, configProps)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 渲染组件</span></span><br><span class="line">    <span class="keyword">return</span> h(component, data, children)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到 <code>router-view</code> 是通过 <code>$route</code> 变量来获取当前组件的，而在前面 <a href="#_7-%E6%9B%B4%E6%96%B0%E8%B7%AF%E7%94%B1%E4%BF%A1%E6%81%AF">7. 更新路由信息</a> 时有提到会更新 <code>_route</code> 变量，而它在 <a href="#_2-%E5%AE%89%E8%A3%85-router">2. 安装 Router</a> 时就已经用 <code>$route</code> 包装成响应式了，这里自然也就可以渲染对应的组件了。</p>
<h2 id="四、-动态添加路由实现"><a href="#四、-动态添加路由实现" class="headerlink" title="四、 动态添加路由实现"></a>四、 动态添加路由实现</h2><p>我们在开发时可能会遇到一些比较复杂的场景，需要动态添加路由，最常见的例子就是根据后端返回的不同用户角色去配置不同的前端路由，那下面就讲讲它在 vue-router 内部是如何实现的。<br>​</p>
<p>我们只需要使用 <code>router.addRoute</code> 方法就能新增一条路由记录，之前我们在讲 <a href="#_2-%E5%88%9B%E5%BB%BA-matcher">2. 创建 matcher</a> 有看到这个方法的定义，下面是它的实现：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addRoute</span>(<span class="params">parentOrRoute, route</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 判断是否有传入父路由，有则取，无则 undefined</span></span><br><span class="line">  <span class="keyword">const</span> parent =</span><br><span class="line">    <span class="keyword">typeof</span> parentOrRoute !== <span class="string">&#x27;object&#x27;</span> ? nameMap[parentOrRoute] : <span class="literal">undefined</span></span><br><span class="line">  <span class="comment">// 插入一条路由，由于这里可能只会传入一个参数，所以需要判断一下</span></span><br><span class="line">  createRouteMap([route || parentOrRoute], pathList, pathMap, nameMap, parent)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 有父路由并且父路由存在别名的情况下，需要给这个别名路由也新增一条子路由</span></span><br><span class="line">  <span class="keyword">if</span> (parent) &#123;</span><br><span class="line">    createRouteMap(</span><br><span class="line">      <span class="comment">// $flow-disable-line route is defined if parent is</span></span><br><span class="line">      parent.alias.map(<span class="function">(<span class="params">alias</span>) =&gt;</span> (&#123;</span><br><span class="line">        <span class="attr">path</span>: alias,</span><br><span class="line">        <span class="attr">children</span>: [route]</span><br><span class="line">      &#125;)),</span><br><span class="line">      pathList,</span><br><span class="line">      pathMap,</span><br><span class="line">      nameMap,</span><br><span class="line">      parent</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里比较重要的是调用 <code>createRouteMap</code> 来创建路由，它的实现之前在 <a href="#_3-%E6%A0%B9%E6%8D%AE%E8%B7%AF%E7%94%B1%E9%85%8D%E7%BD%AE%E7%94%9F%E6%88%90%E4%B8%89%E5%BC%A0%E8%A1%A8">3. 根据路由配置生成三张表</a> 有提到，不过当时只关注它如何生成三张表，在现在这种情况下调用它的区别在于：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这三张表都无需新增，直接拿之前的</span></span><br><span class="line"><span class="keyword">const</span> pathList: <span class="built_in">Array</span>&lt;string&gt; = oldPathList || []</span><br><span class="line"><span class="keyword">const</span> pathMap: Dictionary&lt;RouteRecord&gt; = oldPathMap || <span class="built_in">Object</span>.create(<span class="literal">null</span>)</span><br><span class="line"><span class="keyword">const</span> nameMap: Dictionary&lt;RouteRecord&gt; = oldNameMap || <span class="built_in">Object</span>.create(<span class="literal">null</span>)</span><br></pre></td></tr></table></figure>

<p>好了，可以看到新增一条路由规则十分简单，只需要对 <code>pathList</code> 、 <code>pathMap</code> 、 <code>nameMap</code> 进行改动就好了。</p>
<h2 id="五、-三种路由模式的实现"><a href="#五、-三种路由模式的实现" class="headerlink" title="五、 三种路由模式的实现"></a>五、 三种路由模式的实现</h2><p>vue-router 的核心逻辑已经讲得差不多了，就剩下三种路由模式之间的差异，这一小节就来仔细讲讲它们各自的内部实现。<br>​</p>
<h4 id="相同的部分"><a href="#相同的部分" class="headerlink" title="相同的部分"></a>相同的部分</h4><p>我们知道三种路由模式都是 <code>History</code> 的派生类，源码位置在 <a target="_blank" rel="noopener" href="https://github1s.com/vuejs/vue-router/blob/HEAD/src/history/base.js">src/history/base.js</a>，我们先来看看它们一些比较重要的公用方法：</p>
<ul>
<li>onReady</li>
<li>onError</li>
<li>transitionTo</li>
<li>confirmTransition</li>
<li>updateRoute</li>
</ul>
<p>其实这些方法在前文中已经或多或少有提到了，其余的那些也只是做一些更新变量的操作，这里也不谈了。</p>
<p>其实还有一个非常重要的就是构造函数，它主要是做一些实例变量的初始化，这里混个眼熟就好：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">constructor</span>(<span class="params">router: Router, base: ? string</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.router = router</span><br><span class="line">    <span class="built_in">this</span>.base = normalizeBase(base)</span><br><span class="line">    <span class="comment">// start with a route object that stands for &quot;nowhere&quot;</span></span><br><span class="line">    <span class="built_in">this</span>.current = START</span><br><span class="line">    <span class="built_in">this</span>.pending = <span class="literal">null</span></span><br><span class="line">    <span class="built_in">this</span>.ready = <span class="literal">false</span></span><br><span class="line">    <span class="built_in">this</span>.readyCbs = []</span><br><span class="line">    <span class="built_in">this</span>.readyErrorCbs = []</span><br><span class="line">    <span class="built_in">this</span>.errorCbs = []</span><br><span class="line">    <span class="built_in">this</span>.listeners = []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面我们就讲讲它们不同的地方。</p>
<h4 id="hash-模式"><a href="#hash-模式" class="headerlink" title="hash 模式"></a>hash 模式</h4><p>hash 应该是最常用的一种模式了，它也是浏览器环境下的默认模式，至于它的特点相信大家也很熟悉了，就是利用 <code>URL</code> 中的 <code>hash</code> 值来做路由，这种模式兼容性是最好的。<br>​</p>
<h5 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h5><p>我们先来看看它在初始化时会做哪些操作：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">constructor</span>(<span class="params">router: Router, base: ? string, fallback : boolean</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(router, base)</span><br><span class="line">    <span class="comment">// check history fallback deeplinking</span></span><br><span class="line">    <span class="keyword">if</span> (fallback &amp;&amp; checkFallback(<span class="built_in">this</span>.base)) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    ensureSlash()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代码不多，首先是检查是否因为回退而使用 hash 模式，如果是的话则调用 <code>checkFallback</code> 检查它的返回值，如果为 <code>true</code> 则不调用 <code>ensureSlash</code> 。<br>​</p>
<p>下面是 <code>checkFallback</code> 的实现：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkFallback</span>(<span class="params">base</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 这个方法位于 src/history/html5.js，用于获取 URL 中的路径部分</span></span><br><span class="line">  <span class="comment">// http://a.com/user/routes =&gt; /user/routes</span></span><br><span class="line">  <span class="comment">// http://a.com/#/user/routes =&gt; /#/user/routes</span></span><br><span class="line">  <span class="keyword">const</span> location = getLocation(base)</span><br><span class="line">  <span class="comment">// 检查是否以 /## 开头，如果不是，则重定向至以 /## 开头</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="regexp">/^\/#/</span>.test(location)) &#123;</span><br><span class="line">    <span class="comment">// http://a.com/user/routes =&gt; http://a.com/#/user/routes</span></span><br><span class="line">    <span class="built_in">window</span>.location.replace(cleanPath(base + <span class="string">&#x27;/#&#x27;</span> + location))</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也就是说当我们使用了 <code>history</code> 模式但由于不支持需要回退到 <code>hash</code> 模式时，它会自动重定向到符合 <code>hash</code> 模式下的 <code>url</code> ，接着再执行 <code>ensureSlash</code> 方法。</p>
<p>下面是 <code>ensureSlash</code> 方法的实现：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://a.com/#/user/routes =&gt; /user/routes</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getHash</span>(<span class="params"></span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">  <span class="comment">// We can&#x27;t use window.location.hash here because it&#x27;s not</span></span><br><span class="line">  <span class="comment">// consistent across browsers - Firefox will pre-decode it!</span></span><br><span class="line">  <span class="keyword">let</span> href = <span class="built_in">window</span>.location.href</span><br><span class="line">  <span class="keyword">const</span> index = href.indexOf(<span class="string">&#x27;#&#x27;</span>)</span><br><span class="line">  <span class="comment">// empty path</span></span><br><span class="line">  <span class="keyword">if</span> (index &lt; <span class="number">0</span>) <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">  href = href.slice(index + <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> href</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">replaceHash</span>(<span class="params">path</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (supportsPushState) &#123;</span><br><span class="line">    replaceState(getUrl(path))</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">window</span>.location.replace(getUrl(path))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ensureSlash</span>(<span class="params"></span>): <span class="title">boolean</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> path = getHash()</span><br><span class="line">  <span class="keyword">if</span> (path.charAt(<span class="number">0</span>) === <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">  replaceHash(<span class="string">&#x27;/&#x27;</span> + path)</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>很简单，就是判断一下 <code>hash</code> 部分是否以 <code>/</code> 开头，如果不是则要重定向到以 <code>/</code> 开头的 <code>URL</code> 。<br>​</p>
<p>这样就能解释我们在使用 vue-router 开发项目时，为什么打开调试页面 <a target="_blank" rel="noopener" href="http://localhost:8080/">http://localhost:8080</a> 后会自动把 url 修改为 <a target="_blank" rel="noopener" href="http://localhost:8080/#/">http://localhost:8080/#/</a> 了。</p>
<h5 id="push-和-replace"><a href="#push-和-replace" class="headerlink" title="push 和 replace"></a>push 和 replace</h5><p><code>hash</code> 模式的 <code>push</code> 方法我们在 <a href="#%E4%B8%89%E3%80%81-%E5%88%87%E6%8D%A2%E8%B7%AF%E7%94%B1%E6%97%B6%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88">三、 切换路由时发生了什么</a> 这一小节已经提到过了，其实 <code>replace</code> 也是大同小异，下面是这两个方法的实现：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">push</span>(<span class="params">location: RawLocation, onComplete ? : <span class="built_in">Function</span>, onAbort ? : <span class="built_in">Function</span></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;</span><br><span class="line">        <span class="attr">current</span>: fromRoute</span><br><span class="line">    &#125; = <span class="built_in">this</span></span><br><span class="line">    <span class="built_in">this</span>.transitionTo(</span><br><span class="line">        location,</span><br><span class="line">        <span class="function"><span class="params">route</span> =&gt;</span> &#123;</span><br><span class="line">            pushHash(route.fullPath)</span><br><span class="line">            handleScroll(<span class="built_in">this</span>.router, route, fromRoute, <span class="literal">false</span>)</span><br><span class="line">            onComplete &amp;&amp; onComplete(route)</span><br><span class="line">        &#125;,</span><br><span class="line">        onAbort</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">replace</span>(<span class="params">location: RawLocation, onComplete ? : <span class="built_in">Function</span>, onAbort ? : <span class="built_in">Function</span></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;</span><br><span class="line">        <span class="attr">current</span>: fromRoute</span><br><span class="line">    &#125; = <span class="built_in">this</span></span><br><span class="line">    <span class="built_in">this</span>.transitionTo(</span><br><span class="line">        location,</span><br><span class="line">        <span class="function"><span class="params">route</span> =&gt;</span> &#123;</span><br><span class="line">            replaceHash(route.fullPath)</span><br><span class="line">            handleScroll(<span class="built_in">this</span>.router, route, fromRoute, <span class="literal">false</span>)</span><br><span class="line">            onComplete &amp;&amp; onComplete(route)</span><br><span class="line">        &#125;,</span><br><span class="line">        onAbort</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>replace</code> 方法跟 <code>push</code> 方法不同的地方是它调用的是 <code>replaceHash</code> 而不是 <code>pushHash</code> ，下面是 <code>replaceHash</code> 方法的实现：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">replaceHash</span>(<span class="params">path</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (supportsPushState) &#123;</span><br><span class="line">    replaceState(getUrl(path))</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">window</span>.location.replace(getUrl(path))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 以下方法在 src/util/push-state.js 中</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">pushState</span>(<span class="params">url?: string, replace?: boolean</span>) </span>&#123;</span><br><span class="line">  saveScrollPosition()</span><br><span class="line">  <span class="comment">// try...catch the pushState call to get around Safari</span></span><br><span class="line">  <span class="comment">// DOM Exception 18 where it limits to 100 pushState calls</span></span><br><span class="line">  <span class="keyword">const</span> history = <span class="built_in">window</span>.history</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (replace) &#123;</span><br><span class="line">      <span class="comment">// preserve existing history state as it could be overriden by the user</span></span><br><span class="line">      <span class="keyword">const</span> stateCopy = extend(&#123;&#125;, history.state)</span><br><span class="line">      stateCopy.key = getStateKey()</span><br><span class="line">      history.replaceState(stateCopy, <span class="string">&#x27;&#x27;</span>, url)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      history.pushState(</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">key</span>: setStateKey(genStateKey())</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        url</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="built_in">window</span>.location[replace ? <span class="string">&#x27;replace&#x27;</span> : <span class="string">&#x27;assign&#x27;</span>](url)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">replaceState</span>(<span class="params">url?: string</span>) </span>&#123;</span><br><span class="line">  pushState(url, <span class="literal">true</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以它们在更新 <code>URL</code> 时的区别在于调用的是 <code>push</code> 还是 <code>replace</code> 方法。<br>​</p>
<h5 id="go"><a href="#go" class="headerlink" title="go"></a>go</h5><p>而 <code>go</code> 方法就更直接了，实际上就是调用 <code>history.go</code> 这个方法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">go</span>(<span class="params">n: number</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">window</span>.history.go(n)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不知道大家会不会疑惑，这里没有调用 <code>transitionTo</code> 方法， <code>vue-router</code> 是如何知道需要更新路由的呢？<br>​</p>
<p>这就是就得不得说一下 <code>setupListeners</code> 这个方法了。</p>
<h5 id="setupListeners"><a href="#setupListeners" class="headerlink" title="setupListeners"></a>setupListeners</h5><p>还记得在 <a href="#%E4%B8%89%E3%80%81-%E5%88%87%E6%8D%A2%E8%B7%AF%E7%94%B1%E6%97%B6%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88">三、 切换路由时发生了什么</a> 这一小节的 <code>init</code> 方法里有这么一段代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在浏览器环境下初始化时根据当前路由位置做路由跳转</span></span><br><span class="line"><span class="keyword">if</span> (history <span class="keyword">instanceof</span> HTML5History || history <span class="keyword">instanceof</span> HashHistory) &#123;</span><br><span class="line">  <span class="keyword">const</span> handleInitialScroll = <span class="function">(<span class="params">routeOrError</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">from</span> = history.current</span><br><span class="line">    <span class="keyword">const</span> expectScroll = <span class="built_in">this</span>.options.scrollBehavior</span><br><span class="line">    <span class="keyword">const</span> supportsScroll = supportsPushState &amp;&amp; expectScroll</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (supportsScroll &amp;&amp; <span class="string">&#x27;fullPath&#x27;</span> <span class="keyword">in</span> routeOrError) &#123;</span><br><span class="line">      handleScroll(<span class="built_in">this</span>, routeOrError, <span class="keyword">from</span>, <span class="literal">false</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> setupListeners = <span class="function">(<span class="params">routeOrError</span>) =&gt;</span> &#123;</span><br><span class="line">    history.setupListeners()</span><br><span class="line">    handleInitialScroll(routeOrError)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 切换路由的方法，这个方法后面会讲</span></span><br><span class="line">  history.transitionTo(</span><br><span class="line">    history.getCurrentLocation(),</span><br><span class="line">    setupListeners,</span><br><span class="line">    setupListeners</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 <code>history</code> 或者 <code>hash</code> 模式下初始化时也会调用一下 <code>transitionTo</code> ，而这里传入的 <code>onComplete</code> 回调就会调用 <code>setupListeners</code> 方法，为什么要这么做呢？我们直接看 <code>setupListeners</code> 里面是什么：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">setupListeners</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.listeners.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> router = <span class="built_in">this</span>.router</span><br><span class="line">    <span class="keyword">const</span> expectScroll = router.options.scrollBehavior</span><br><span class="line">    <span class="keyword">const</span> supportsScroll = supportsPushState &amp;&amp; expectScroll</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (supportsScroll) &#123;</span><br><span class="line">        <span class="built_in">this</span>.listeners.push(setupScroll())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> handleRoutingEvent = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> current = <span class="built_in">this</span>.current</span><br><span class="line">        <span class="comment">// 检查当前 URL 是否符合 hash 模式的规则，如果符合会直接重定向一下</span></span><br><span class="line">        <span class="comment">// 由于重定向后还是会再触发一下当前方法，这次就没必要执行了</span></span><br><span class="line">        <span class="keyword">if</span> (!ensureSlash()) &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.transitionTo(getHash(), <span class="function">(<span class="params">route</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (supportsScroll) &#123;</span><br><span class="line">                handleScroll(<span class="built_in">this</span>.router, route, current, <span class="literal">true</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!supportsPushState) &#123;</span><br><span class="line">                replaceHash(route.fullPath)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> eventType = supportsPushState ? <span class="string">&#x27;popstate&#x27;</span> : <span class="string">&#x27;hashchange&#x27;</span></span><br><span class="line">    <span class="built_in">window</span>.addEventListener(eventType, handleRoutingEvent)</span><br><span class="line">    <span class="built_in">this</span>.listeners.push(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">window</span>.removeEventListener(eventType, handleRoutingEvent)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主要是做了两件事情：</p>
<ol>
<li>监听 <code>popstate</code> 或者 <code>hashchange</code> 事件，触发时会执行一下 <code>transitionTo</code>​</li>
<li>在 <code>listeners</code> 中存入两个回调：处理滚动相关、取消监听第 1 点中的事件</li>
</ol>
<p>也就是说 vue-router 除了调用 <code>push</code> 或者 <code>replece</code> 这些方法以外，它也支持通过其它方式来切换路由，只要这个操作会触发 <code>popstate</code> 或者 <code>hashchange</code> 事件，比如下面这些方式：</p>
<ul>
<li>如支持 <code>history</code> api<ul>
<li>history.pushState</li>
<li>history.replaceState</li>
<li>history.back</li>
<li>history.go</li>
</ul>
</li>
<li><code>location.hash = &#39;#/a&#39;</code></li>
</ul>
<p>当然这个事件监听器会在应用实例销毁时取消监听，避免产生副作用：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">teardown</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="comment">// clean up event listeners</span></span><br><span class="line">    <span class="comment">// https://github.com/vuejs/vue-router/issues/2341</span></span><br><span class="line">    <span class="built_in">this</span>.listeners.forEach(<span class="function"><span class="params">cleanupListener</span> =&gt;</span> &#123;</span><br><span class="line">        cleanupListener()</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="built_in">this</span>.listeners = []</span><br><span class="line">    <span class="comment">// reset current history route</span></span><br><span class="line">    <span class="comment">// https://github.com/vuejs/vue-router/issues/3294</span></span><br><span class="line">    <span class="built_in">this</span>.current = START</span><br><span class="line">    <span class="built_in">this</span>.pending = <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="history-模式"><a href="#history-模式" class="headerlink" title="history 模式"></a>history 模式</h4><p><code>history</code> 模式是基于 HTML5 History API 实现的，不过在生产环境上使用它还需要在服务器上配置路由转发才行，不过这仍是大部分项目的选择，毕竟这样比较好看，不像 hash 模式这么奇葩。</p>
<h5 id="初始化-1"><a href="#初始化-1" class="headerlink" title="初始化"></a>初始化</h5><p>我们看看 <code>history</code> 模式在初始化时会做哪些操作：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">constructor</span>(<span class="params">router: Router, base: ? string</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(router, base)</span><br><span class="line">    <span class="comment">// getLocation 方法在前面已经讲过，主要用于获取 URL 中的路径部分</span></span><br><span class="line">    <span class="built_in">this</span>._startLocation = getLocation(<span class="built_in">this</span>.base)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>只是初始化了一个 <code>_startLocation</code> 变量，这个变量的作用后面会讲到。<br>​</p>
<h5 id="push-和-replace、go"><a href="#push-和-replace、go" class="headerlink" title="push 和 replace、go"></a>push 和 replace、go</h5><p>其实 <code>history</code> 模式的这几个方法与 <code>hash</code> 模式是一模一样的，区别是它们在调用 <code>pushState</code> 时传入的 <code>URL</code> 不一样而已，关于 <code>pushState</code> 方法的定义前面已经讲过了。</p>
<h5 id="setupListeners-1"><a href="#setupListeners-1" class="headerlink" title="setupListeners"></a>setupListeners</h5><p><code>setupListeners</code> 与 <code>hash</code> 模式也是大同小异，区别在于它在判断 <code>URL</code> 与当前路由是否一致时有点不同：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">const handleRoutingEvent = () =&gt; &#123;</span><br><span class="line">  const current = this.current</span><br><span class="line"></span><br><span class="line"><span class="deletion">-  if (!ensureSlash()) &#123;</span></span><br><span class="line"><span class="deletion">-    return</span></span><br><span class="line"><span class="deletion">-  &#125;</span></span><br><span class="line"><span class="addition">+  const location = getLocation(this.base)</span></span><br><span class="line"><span class="addition">+  if (this.current === START &amp;&amp; location === this._startLocation) &#123;</span></span><br><span class="line"><span class="addition">+    return</span></span><br><span class="line"><span class="addition">+  &#125;</span></span><br><span class="line"></span><br><span class="line">  this.transitionTo(location, (route) =&gt; &#123;</span><br><span class="line">    if (supportsScroll) &#123;</span><br><span class="line">      handleScroll(router, route, current, true)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="abstract-模式"><a href="#abstract-模式" class="headerlink" title="abstract 模式"></a>abstract 模式</h4><p><code>abstract</code> 我们可能用得比较少，它主要是用在 <code>node</code> 环境下，也就是说在该模式下不会调用一切与浏览器相关的 <code>api</code> ，那它就只能用别的地方去维护当前 <code>URL</code> 与路由历史，由于不是很长，我直接放在一起讲了：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractHistory</span> <span class="keyword">extends</span> <span class="title">History</span> </span>&#123;</span><br><span class="line">  <span class="attr">index</span>: number</span><br><span class="line">  <span class="attr">stack</span>: <span class="built_in">Array</span>&lt;Route&gt;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">router: Router, base: ?string</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(router, base)</span><br><span class="line">    <span class="comment">// 堆栈，用于维护路由历史</span></span><br><span class="line">    <span class="built_in">this</span>.stack = []</span><br><span class="line">    <span class="comment">// 当前所在路由在 stack 中的索引</span></span><br><span class="line">    <span class="built_in">this</span>.index = -<span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">push</span>(<span class="params">location: RawLocation, onComplete?: <span class="built_in">Function</span>, onAbort?: <span class="built_in">Function</span></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.transitionTo(</span><br><span class="line">      location,</span><br><span class="line">      <span class="function">(<span class="params">route</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 将当前跳转的路由存入栈中，index + 1</span></span><br><span class="line">        <span class="built_in">this</span>.stack = <span class="built_in">this</span>.stack.slice(<span class="number">0</span>, <span class="built_in">this</span>.index + <span class="number">1</span>).concat(route)</span><br><span class="line">        <span class="built_in">this</span>.index++</span><br><span class="line">        onComplete &amp;&amp; onComplete(route)</span><br><span class="line">      &#125;,</span><br><span class="line">      onAbort</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">replace</span>(<span class="params">location: RawLocation, onComplete?: <span class="built_in">Function</span>, onAbort?: <span class="built_in">Function</span></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.transitionTo(</span><br><span class="line">      location,</span><br><span class="line">      <span class="function">(<span class="params">route</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 将当前跳转的路由替换之前路由所在的位置，index 不变</span></span><br><span class="line">        <span class="built_in">this</span>.stack = <span class="built_in">this</span>.stack.slice(<span class="number">0</span>, <span class="built_in">this</span>.index).concat(route)</span><br><span class="line">        onComplete &amp;&amp; onComplete(route)</span><br><span class="line">      &#125;,</span><br><span class="line">      onAbort</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">go</span>(<span class="params">n: number</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> targetIndex = <span class="built_in">this</span>.index + n</span><br><span class="line">    <span class="keyword">if</span> (targetIndex &lt; <span class="number">0</span> || targetIndex &gt;= <span class="built_in">this</span>.stack.length) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> route = <span class="built_in">this</span>.stack[targetIndex]</span><br><span class="line">    <span class="built_in">this</span>.confirmTransition(</span><br><span class="line">      route,</span><br><span class="line">      <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> prev = <span class="built_in">this</span>.current</span><br><span class="line">        <span class="comment">// 将跳转至的路由索引指向 index</span></span><br><span class="line">        <span class="built_in">this</span>.index = targetIndex</span><br><span class="line">        <span class="built_in">this</span>.updateRoute(route)</span><br><span class="line">        <span class="built_in">this</span>.router.afterHooks.forEach(<span class="function">(<span class="params">hook</span>) =&gt;</span> &#123;</span><br><span class="line">          hook &amp;&amp; hook(route, prev)</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (isNavigationFailure(err, NavigationFailureType.duplicated)) &#123;</span><br><span class="line">          <span class="built_in">this</span>.index = targetIndex</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">getCurrentLocation</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> current = <span class="built_in">this</span>.stack[<span class="built_in">this</span>.stack.length - <span class="number">1</span>]</span><br><span class="line">    <span class="keyword">return</span> current ? current.fullPath : <span class="string">&#x27;/&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">ensureURL</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="comment">// noop</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>本文完，感谢阅读。</p>
</div>
  <hr class="copy-line" />
  <div class="post-copyright">
    <div class="copy-author">
      <span>作者 :</span>
      <span
        >4Ark</span
      >
    </div>
    <div class="copy-url">
      <span>地址 :</span>
      <a href="https://4ark.me/post/vue-router-score-code.html">https://4ark.me/post/vue-router-score-code.html</a>
    </div>
    <div class="copy-origin">
      <span>来源 :</span>
      <a href="https://4ark.me">https://4ark.me</a>
    </div>
    <div class="copy-license">著作权归作者所有，转载请联系作者获得授权。</div>
  </div>
</article>

<div class="blog-post-comments">
  <div id="load-disqus">
    <p onclick="loadDisqus()" style="cursor: pointer; text-align: center">
      🥳&nbsp;加载 Disqus 评论
    </p>
  </div>
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the comments.</noscript>
  </div>
</div>
 


        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about">About</a></li>
         
          <li><a href="/archives">Writing</a></li>
         
          <li><a href="/weekly">Weekly</a></li>
         
          <li><a href="/tags">Tags</a></li>
         
          <li><a href="/search">Search</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81-new-Router-%E6%97%B6%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-number">2.</span> <span class="toc-text">一、 new Router 时发生了什么？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%A3%B0%E6%98%8E%E4%B8%80%E4%BA%9B%E5%8F%98%E9%87%8F"><span class="toc-number">2.1.</span> <span class="toc-text">1. 声明一些变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%88%9B%E5%BB%BA-matcher"><span class="toc-number">2.2.</span> <span class="toc-text">2. 创建 matcher</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%A0%B9%E6%8D%AE%E8%B7%AF%E7%94%B1%E9%85%8D%E7%BD%AE%E7%94%9F%E6%88%90%E4%B8%89%E5%BC%A0%E8%A1%A8"><span class="toc-number">2.3.</span> <span class="toc-text">3. 根据路由配置生成三张表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E4%BD%BF%E7%94%A8%E4%B8%80%E4%BA%9B%E6%96%B9%E6%B3%95%E6%9D%A5%E6%93%8D%E4%BD%9C%E8%BF%99%E4%B8%89%E5%BC%A0%E8%A1%A8"><span class="toc-number">2.4.</span> <span class="toc-text">4. 使用一些方法来操作这三张表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E6%A3%80%E6%9F%A5-mode-%EF%BC%8C%E4%BD%BF%E7%94%A8%E5%AF%B9%E5%BA%94%E7%9A%84%E8%B7%AF%E7%94%B1%E6%A8%A1%E5%BC%8F"><span class="toc-number">2.5.</span> <span class="toc-text">5. 检查 mode ，使用对应的路由模式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81-use-Router-%E6%97%B6%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-number">3.</span> <span class="toc-text">二、 use Router 时发生了什么？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Vue-use-%E6%BA%90%E7%A0%81"><span class="toc-number">3.1.</span> <span class="toc-text">1. Vue.use 源码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%AE%89%E8%A3%85-Router"><span class="toc-number">3.2.</span> <span class="toc-text">2. 安装 Router</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81-%E5%88%87%E6%8D%A2%E8%B7%AF%E7%94%B1%E6%97%B6%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88"><span class="toc-number">4.</span> <span class="toc-text">三、 切换路由时发生了什么</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%87%E6%8D%A2%E8%B7%AF%E7%94%B1%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E5%BC%8F"><span class="toc-number">4.0.1.</span> <span class="toc-text">切换路由的几种方式</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E6%89%8B%E5%8A%A8%E8%A7%A6%E5%8F%91-URL-%E6%9B%B4%E6%96%B0"><span class="toc-number">4.0.1.1.</span> <span class="toc-text">1. 手动触发 URL 更新</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E9%80%9A%E8%BF%87-router-link-%E5%88%87%E6%8D%A2"><span class="toc-number">4.0.1.2.</span> <span class="toc-text">2. 通过 router-link 切换</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E9%80%9A%E8%BF%87-router-%E7%9A%84%E6%96%B9%E6%B3%95%E5%88%87%E6%8D%A2"><span class="toc-number">4.0.1.3.</span> <span class="toc-text">3. 通过 router 的方法切换</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%87%E6%8D%A2%E8%BF%87%E7%A8%8B"><span class="toc-number">4.0.2.</span> <span class="toc-text">切换过程</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E8%B0%83%E7%94%A8-transitionTo-%E6%96%B9%E6%B3%95"><span class="toc-number">4.0.2.1.</span> <span class="toc-text">1. 调用 transitionTo 方法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E8%B0%83%E7%94%A8-match-%E6%96%B9%E6%B3%95%E5%8C%B9%E9%85%8D%E8%B7%AF%E7%94%B1"><span class="toc-number">4.0.2.2.</span> <span class="toc-text">2. 调用 match 方法匹配路由</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E8%B0%83%E7%94%A8-confirmTransition-%E6%96%B9%E6%B3%95"><span class="toc-number">4.0.2.3.</span> <span class="toc-text">3. 调用 confirmTransition 方法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-%E6%9E%84%E9%80%A0%E5%AF%BC%E8%88%AA%E5%AE%88%E5%8D%AB%E9%98%9F%E5%88%97"><span class="toc-number">4.0.2.4.</span> <span class="toc-text">4. 构造导航守卫队列</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-%E6%89%A7%E8%A1%8C%E9%98%9F%E5%88%97"><span class="toc-number">4.0.2.5.</span> <span class="toc-text">5. 执行队列</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-%E6%89%A7%E8%A1%8C-confirmTransition-%E5%90%8E%E7%9A%84%E6%93%8D%E4%BD%9C"><span class="toc-number">4.0.2.6.</span> <span class="toc-text">6. 执行 confirmTransition 后的操作</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-%E6%9B%B4%E6%96%B0%E8%B7%AF%E7%94%B1%E4%BF%A1%E6%81%AF"><span class="toc-number">4.0.2.7.</span> <span class="toc-text">7. 更新路由信息</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#8-%E6%9B%B4%E6%96%B0-URL"><span class="toc-number">4.0.2.8.</span> <span class="toc-text">8. 更新 URL</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#9-%E6%B8%B2%E6%9F%93%E5%AF%B9%E5%BA%94%E7%9A%84%E8%B7%AF%E7%94%B1%E8%A7%86%E5%9B%BE"><span class="toc-number">4.0.2.9.</span> <span class="toc-text">9. 渲染对应的路由视图</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81-%E5%8A%A8%E6%80%81%E6%B7%BB%E5%8A%A0%E8%B7%AF%E7%94%B1%E5%AE%9E%E7%8E%B0"><span class="toc-number">5.</span> <span class="toc-text">四、 动态添加路由实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81-%E4%B8%89%E7%A7%8D%E8%B7%AF%E7%94%B1%E6%A8%A1%E5%BC%8F%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">6.</span> <span class="toc-text">五、 三种路由模式的实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%B8%E5%90%8C%E7%9A%84%E9%83%A8%E5%88%86"><span class="toc-number">6.0.1.</span> <span class="toc-text">相同的部分</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#hash-%E6%A8%A1%E5%BC%8F"><span class="toc-number">6.0.2.</span> <span class="toc-text">hash 模式</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">6.0.2.1.</span> <span class="toc-text">初始化</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#push-%E5%92%8C-replace"><span class="toc-number">6.0.2.2.</span> <span class="toc-text">push 和 replace</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#go"><span class="toc-number">6.0.2.3.</span> <span class="toc-text">go</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#setupListeners"><span class="toc-number">6.0.2.4.</span> <span class="toc-text">setupListeners</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#history-%E6%A8%A1%E5%BC%8F"><span class="toc-number">6.0.3.</span> <span class="toc-text">history 模式</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96-1"><span class="toc-number">6.0.3.1.</span> <span class="toc-text">初始化</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#push-%E5%92%8C-replace%E3%80%81go"><span class="toc-number">6.0.3.2.</span> <span class="toc-text">push 和 replace、go</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#setupListeners-1"><span class="toc-number">6.0.3.3.</span> <span class="toc-text">setupListeners</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#abstract-%E6%A8%A1%E5%BC%8F"><span class="toc-number">6.0.4.</span> <span class="toc-text">abstract 模式</span></a></li></ol></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://4ark.me/post/vue-router-score-code.html"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://4ark.me/post/vue-router-score-code.html&text=vue-router 源码解析"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://4ark.me/post/vue-router-score-code.html&title=vue-router 源码解析"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://4ark.me/post/vue-router-score-code.html&is_video=false&description=vue-router 源码解析"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=vue-router 源码解析&body=Check out this article: https://4ark.me/post/vue-router-score-code.html"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://4ark.me/post/vue-router-score-code.html&title=vue-router 源码解析"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://4ark.me/post/vue-router-score-code.html&title=vue-router 源码解析"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://4ark.me/post/vue-router-score-code.html&title=vue-router 源码解析"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://4ark.me/post/vue-router-score-code.html&title=vue-router 源码解析"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://4ark.me/post/vue-router-score-code.html&name=vue-router 源码解析&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://4ark.me/post/vue-router-score-code.html&t=vue-router 源码解析"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="dark-mobile" class="icon"><i class="fa fa-sun" id="dark-btn" aria-hidden="true"></i> Switch</a>
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2024
    4Ark
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about">About</a></li><!--
     --><!--
       --><li><a href="/archives">Writing</a></li><!--
     --><!--
       --><li><a href="/weekly">Weekly</a></li><!--
     --><!--
       --><li><a href="/tags">Tags</a></li><!--
     --><!--
       --><li><a href="/search">Search</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-190615898-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-190615898-1');
    </script>

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<script type="text/javascript">
  function loadDisqus() {
    var disqus_shortname = 'https-4ark-me'

    ;(function () {
      var dsq = document.createElement('script')
      dsq.type = 'text/javascript'
      dsq.async = true
      dsq.src =
        '//' +
        disqus_shortname +
        '.disqus.com/embed.js'
      ;(
        document.getElementsByTagName('head')[0] ||
        document.getElementsByTagName('body')[0]
      ).appendChild(dsq)
    })()

    $('#load-disqus').hide()
  }
</script>

<!-- utterances Comments -->

</body>
</html>
